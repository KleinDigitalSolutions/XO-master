<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="c6Os7hNWJXfZkuvNtX7sPc0_bPUz4TQfi4OWUAA3BMo" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klein Digital Solutions - AI Music Studio | Music Mastering, Stem Separation, Speech Enhancement & Audio Processing</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Professional AI-powered music studio with stem separation, mastering, speech enhancement, and audio processing. Separate vocals, drums, bass with BS-RoFormer. AI audio enhancement, noise reduction, podcast processing, and MIDI transcription. Music production tools for creators and professionals.">
    <meta name="keywords" content="music mastering service, stem generation, music separation, AI mastering, vocal isolation, stem separation, speech enhancement, audio enhancement, noise reduction, podcast processing, voice processing, AI audio tools, MIDI transcription, audio generation, Musik Stem Generierung, BS-RoFormer, automatic mastering, mastering service, music production, audio processing, Klein Digital Solutions, Musik Mastering Service, Stem Generierung, Speech Enhancement, Audio Enhancement, Podcast Bearbeitung">
    <meta name="author" content="Klein Digital Solutions">
    <meta name="robots" content="index, follow">
    <meta name="language" content="en,de">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Klein Digital Solutions - AI Music Studio | Music Mastering, Stem Separation, Speech Enhancement & Audio Processing">
    <meta property="og:description" content="Professional AI-powered music studio with stem separation, mastering, speech enhancement, and audio processing. Advanced AI tools for music producers, podcasters, and content creators. Noise reduction, voice processing, and professional audio enhancement.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kleindigitalsolutions.de">
    <meta property="og:image" content="https://kleindigitalsolutions.de/assets/og-image.jpg">
    <meta property="og:site_name" content="Klein Digital Solutions">
    <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="de_DE">
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Klein Digital Solutions - AI Music Studio | Music Mastering, Stem Separation, Speech Enhancement & Audio Processing">
    <meta name="twitter:description" content="Professional AI-powered music studio with stem separation, mastering, speech enhancement, and audio processing. Advanced AI tools for music producers, podcasters, and content creators. Noise reduction, voice processing, and professional audio enhancement.">
    <meta name="twitter:image" content="https://kleindigitalsolutions.de/assets/twitter-image.jpg">
    <meta name="twitter:creator" content="@kleindigital">
    
    <!-- German Meta Tags -->
    <meta name="description" lang="de" content="Professionelles AI Music Studio mit Stem-Separation, Mastering, Speech Enhancement und Audio-Verarbeitung. KI-Tools f√ºr Musikproduzenten, Podcaster und Content Creator. Rauschunterdr√ºckung, Voice Processing und professionelle Audio-Enhancement.">
    <meta name="keywords" lang="de" content="Musik Mastering Service, Musik Stem Generierung, Musikseparation, KI Mastering, Vocal Isolation, Stem Separation, Speech Enhancement, Audio Enhancement, Rauschunterdr√ºckung, Podcast Bearbeitung, Voice Processing, KI Audio Tools, MIDI Transkription, Audio Generierung, BS-RoFormer, automatisches Mastering, Mastering Service, Musikproduktion, Audio Processing, Klein Digital Solutions, Stem Generierung, Sprach Enhancement, Audio Verbesserung">
    
    <!-- Technical Meta Tags -->
    <meta name="theme-color" content="#4A90E2">
    <meta name="msapplication-TileColor" content="#4A90E2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Music Studio">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://kleindigitalsolutions.de">
    
    <!-- Alternate Languages -->
    <link rel="alternate" hreflang="en" href="https://kleindigitalsolutions.de/en">
    <link rel="alternate" hreflang="de" href="https://kleindigitalsolutions.de/de">
    <link rel="alternate" hreflang="x-default" href="https://kleindigitalsolutions.de">
    
    <!-- Preload and load critical payment script early -->
    <link rel="preload" href="https://js.stripe.com/v3/" as="script">
    <link rel="dns-prefetch" href="https://js.stripe.com">
    <script src="https://js.stripe.com/v3/" async></script>
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Klein Digital Solutions - AI Music Studio",
        "description": "Professional AI-powered music studio with stem separation, mastering, speech enhancement, and audio processing. Advanced AI tools for music producers, podcasters, and content creators.",
        "url": "https://kleindigitalsolutions.de",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR"
        },
        "creator": {
            "@type": "Organization",
            "name": "Klein Digital Solutions",
            "url": "https://kleindigitalsolutions.de"
        },
        "featureList": [
            "AI Music Separation",
            "Vocal Isolation",
            "Drum Separation",
            "Bass Separation",
            "Automatic Mastering",
            "Professional Audio Processing",
            "Music Mastering Service",
            "Stem Generation",
            "Music Transcription",
            "Chord Recognition",
            "Melody Transcription",
            "MIDI Export",
            "Speech Enhancement",
            "Audio Enhancement", 
            "Noise Reduction",
            "Voice Processing",
            "Podcast Enhancement",
            "Audio Generation",
            "AI Audio Tools",
            "Filler Word Removal",
            "Silence Trimming",
            "Volume Normalization",
            "Loudness Targeting",
            "AudioLDM AI Model",
            "Musik Mastering Service",
            "Musik Stem Generierung", 
            "Musik Transkription",
            "Sprach Enhancement",
            "Audio Verbesserung",
            "Rauschunterdr√ºckung",
            "Podcast Bearbeitung"
        ]
    }
    </script>
    
    <!-- Additional Service-Specific Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Service",
        "name": "AI Speech Enhancement Service",
        "description": "Professional AI-powered speech enhancement, noise reduction, and podcast processing service.",
        "provider": {
            "@type": "Organization",
            "name": "Klein Digital Solutions"
        },
        "serviceType": "Audio Enhancement",
        "offers": {
            "@type": "Offer",
            "price": "19.99",
            "priceCurrency": "EUR",
            "priceValidUntil": "2025-12-31"
        }
    }
    </script>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "AI Music Production Suite",
        "applicationCategory": "MultimediaApplication",
        "offers": [
            {
                "@type": "Offer",
                "name": "Starter Credits",
                "price": "24.99",
                "priceCurrency": "EUR"
            },
            {
                "@type": "Offer", 
                "name": "Studio Credits",
                "price": "79.99",
                "priceCurrency": "EUR"
            }
        ],
        "featureList": [
            "Music Stem Separation",
            "Audio Mastering", 
            "Speech Enhancement",
            "Podcast Processing",
            "MIDI Transcription"
        ]
    }
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Stripe script now loaded earlier in head section -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            /* Original Colors - Keep Working */
            --primary-color: #0d6efd; /* Bootstrap Primary Blue */
            --accent-color: #A020F0; /* Electric Violet */
            --background-color: #F9FAFB; /* Sehr helles Grau */
            --text-color: #111827; /* Dunkelgrau */
            --card-bg: #fff;
            --card-shadow: 0 8px 32px rgba(107,33,168,0.10);
            --card-hover-shadow: 0 16px 32px rgba(160,32,240,0.14);
            --border-color: #e5e7eb; /* Helles Grau f√ºr Rahmen */
            --light-gray: #f3f4f6; /* Sehr helles Grau f√ºr Hintergr√ºnde */
            --dark-color: #111827; /* Dunkelgrau f√ºr Footer etc. */
            
            /* LANDR/TuneCore Inspired Design Extensions */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            
            /* Professional Text Colors */
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --text-inverse: #ffffff;
            
            /* Glass Morphism Effects */
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            
            /* Modern Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Animations */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Typography */
            --font-display: 'Inter', 'SF Pro Display', system-ui, sans-serif;
            --font-body: 'Inter', 'SF Pro Text', system-ui, sans-serif;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', 'Poppins', sans-serif;
            color: var(--text-color);
            background: var(--background-color);
            font-weight: 400;
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
        }

        .navbar {
            box-shadow: var(--card-shadow);
            transition: background 0.3s, box-shadow 0.3s;
            background: rgba(255,255,255,0.98);
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        .navbar.transparent {
            background: rgba(255,255,255,0.15) !important;
            box-shadow: none !important;
        }
        .navbar .container {
            max-width: 100% !important;
            padding-left: 15px !important;
            padding-right: 15px !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            width: 100% !important;
        }
        .navbar-brand {
            margin-right: 0 !important;
            margin-left: 0 !important;
            padding-left: 0 !important;
            flex-shrink: 0 !important;
            order: -1 !important;
            align-self: flex-start !important;
        }

        .hero-section {
            background: url('/header.webp?v=2025') center/cover no-repeat;
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            position: relative;
            overflow: hidden;
            padding-top: 120px;
        }
        
        
        /* Mobile navbar fixes */
        @media (max-width: 991px) {
            .navbar-brand {
                font-size: 1.1rem !important;
                margin-left: 0 !important;
                padding-left: 0 !important;
            }
            .navbar .container {
                padding-left: 5px !important;
                padding-right: 5px !important;
            }
        }
        
        @media (max-width: 576px) {
            .navbar-brand {
                font-size: 1rem !important;
            }
            .navbar .container {
                padding-left: 5px !important;
                padding-right: 5px !important;
            }
        }
        .hero-section .container {
            position: relative;
            z-index: 1;
        }

        .hero-section h1 {
            font-weight: 700;
            font-size: clamp(2.5rem, 5vw, 4rem);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: white;
        }

        .hero-section .btn {
            padding: 14px 36px;
            font-weight: 700;
            border-radius: 32px;
            font-size: 1.2rem;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            color: #fff;
            border: none;
            box-shadow: 0 4px 24px rgba(160,32,240,0.12);
            transition: all 0.3s cubic-bezier(.4,2,.3,1);
        }
        .hero-section .btn:hover {
            transform: translateY(-4px) scale(1.04);
            box-shadow: 0 8px 32px rgba(224,0,176,0.18);
        }

        section {
            padding: 80px 0;
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: var(--light-gray);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary-color);
            background-color: white;
            transform: translateY(-5px);
            box-shadow: var(--card-hover-shadow);
        }

        .progress-container {
            display: none;
            margin-top: 30px;
        }

        .download-section {
            display: none;
            margin-top: 30px;
        }

        .stem-file {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 10px;
            background-color: var(--light-gray);
        }

        .features-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        /* LANDR/TuneCore Features Section Enhancement */
        #features {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(244, 114, 182, 0.02) 100%) !important;
        }

        #features h2 {
            font-family: var(--font-display) !important;
            font-weight: 800 !important;
            font-size: clamp(2rem, 4vw, 3rem) !important;
            color: var(--text-primary) !important;
            letter-spacing: -0.02em !important;
            margin-bottom: 3rem !important;
        }

        #features .col-lg-4 {
            display: flex;
            flex-direction: column;
            min-height: 280px;
            margin-bottom: 2rem;
        }

        #features .col-lg-4 h4 {
            font-family: var(--font-display) !important;
            font-weight: 700 !important;
            font-size: 1.5rem !important;
            color: var(--text-primary) !important;
            margin-bottom: 1rem !important;
            letter-spacing: -0.01em !important;
        }

        #features .col-lg-4 p {
            flex-grow: 1;
            display: flex;
            align-items: center;
            font-size: 1.1rem !important;
            line-height: 1.6 !important;
            color: var(--text-secondary) !important;
        }

        /* Enhanced LANDR/TuneCore Footer */
        .footer {
            background: linear-gradient(135deg, var(--dark-color) 0%, rgba(17, 24, 39, 0.95) 100%);
            color: white;
            padding: 3rem 0 2rem 0;
            margin-top: 5rem;
            border-top: 1px solid rgba(107, 114, 128, 0.2);
        }

        .footer .container {
            max-width: 1200px;
        }

        .footer h5 {
            font-weight: 600;
            margin-bottom: 1rem;
            position: relative;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .footer h5::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: var(--primary-gradient);
            border-radius: 1px;
        }
        
        /* Responsive footer underline positioning */
        @media (min-width: 992px) {
            .text-lg-start .footer h5::after {
                left: 0;
                transform: none;
            }
        }

        .footer p {
            color: rgba(156, 163, 175, 0.9);
            font-weight: 400;
        }

        .footer .text-light {
            color: rgba(255, 255, 255, 0.8) !important;
            text-decoration: none;
            font-weight: 500;
            transition: all var(--transition-base);
        }

        .footer .text-light:hover {
            color: #667eea !important;
            text-decoration: underline;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 50px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.4);
        }

        .stem-file-preview:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-hover-shadow);
        }

        .stem-file-preview .btn {
            transition: all 0.3s ease;
        }

        .stem-file-preview .btn:hover {
            transform: scale(1.05);
        }

        .card.service-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .card.service-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--card-hover-shadow);
            border-color: var(--primary-color);
        }

        .card.service-card.active {
            border-color: var(--primary-color);
            background-color: var(--light-gray);
        }

        .service-features {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        /* LANDR/TuneCore Inspired Modern Design Enhancements */
        /* Design Only - All Functionality Preserved */
        
        /* LANDR/TuneCore Enhanced Navigation */
        .navbar {
            backdrop-filter: blur(24px) !important;
            background: rgba(255, 255, 255, 0.95) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            padding: 0.5rem 0 !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
        }

        .navbar-brand {
            font-family: var(--font-display);
            font-weight: 800;
            font-size: 1.4rem !important;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
            flex: 1 !important;
        }

        .navbar-nav {
            flex: 0 0 auto !important;
        }
        
        .navbar-nav .nav-link {
            font-weight: 500;
            color: var(--text-primary) !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px;
            transition: all var(--transition-base);
            font-size: 0.95rem;
        }

        .navbar-nav .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* Hero Button Hover Effects */
        .hero-btn:hover {
            background: rgba(84, 92, 178, 0.25) !important;
            border: 2px solid rgba(65, 103, 206, 0.8) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(80, 133, 180, 0.3);
            transition: all 0.3s ease;
        }

        /* Enhanced Hero Section */
        .hero-section {
            background: url('/header.webp?v=2025') center/cover no-repeat !important;
            position: relative !important;
            align-items: flex-start !important;
            padding-top: 120px !important;
        }


        .hero-section .container {
            position: relative !important;
            z-index: 2 !important;
        }

        .hero-section h1 {
            font-family: var(--font-display) !important;
            font-weight: 800 !important;
            line-height: 1.1 !important;
            letter-spacing: -0.02em !important;
            font-size: clamp(2.5rem, 6vw, 4.5rem) !important;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .hero-section p {
            font-size: clamp(1.1rem, 2.5vw, 1.25rem);
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* LANDR/TuneCore Modern Button Style */
        .btn-primary {
            background: var(--primary-gradient) !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 1rem 2rem !important;
            font-weight: 600 !important;
            font-family: var(--font-display) !important;
            font-size: 1rem !important;
            letter-spacing: -0.01em !important;
            transition: all var(--transition-base) !important;
            box-shadow: 0 4px 14px 0 rgba(102, 126, 234, 0.2) !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .btn-primary:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px 0 rgba(102, 126, 234, 0.3) !important;
            filter: brightness(1.05) !important;
        }

        .btn-primary:active {
            transform: translateY(0) !important;
        }

        /* LANDR/TuneCore Professional Service Cards */
        .service-card {
            border-radius: 24px !important;
            transition: all var(--transition-slow) !important;
            overflow: hidden !important;
            position: relative !important;
            border: 1px solid rgba(0, 0, 0, 0.08) !important;
            background: var(--surface) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
        }

        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-base);
            z-index: 1;
        }

        .service-card:hover::before {
            opacity: 0.03;
        }

        .service-card:hover {
            transform: translateY(-12px) !important;
            box-shadow: 0 16px 40px rgba(102, 126, 234, 0.15) !important;
            border-color: rgba(102, 126, 234, 0.2) !important;
        }

        .service-card .card-body {
            position: relative;
            z-index: 2;
            padding: 2.5rem !important;
        }

        .service-card h4 {
            font-family: var(--font-display) !important;
            font-weight: 700 !important;
            font-size: 1.5rem !important;
            color: var(--text-primary) !important;
            margin-bottom: 1rem !important;
            letter-spacing: -0.02em !important;
        }

        .service-card p {
            font-size: 1rem !important;
            line-height: 1.6 !important;
            color: var(--text-secondary) !important;
        }

        .service-card .fa-3x {
            font-size: 3.5rem !important;
            background: var(--primary-gradient) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            margin-bottom: 1.5rem !important;
        }

        /* LANDR/TuneCore Professional Upload Interface */
        .upload-zone {
            border-radius: 24px !important;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(244, 114, 182, 0.02) 100%) !important;
            position: relative !important;
            overflow: hidden !important;
            border: 2px dashed rgba(102, 126, 234, 0.3) !important;
            padding: 3rem 2rem !important;
            text-align: center !important;
            transition: all var(--transition-base) !important;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .upload-zone:hover::before,
        .upload-zone.dragover::before {
            opacity: 0.03;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #667eea !important;
            transform: translateY(-4px) !important;
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.15) !important;
        }

        .upload-zone i {
            font-size: 3.5rem !important;
            background: var(--primary-gradient) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            margin-bottom: 1.5rem !important;
            transition: all var(--transition-base) !important;
        }

        .upload-zone:hover i {
            transform: scale(1.1) !important;
        }


        .upload-zone h4, .upload-zone p {
            font-family: var(--font-display) !important;
            margin-bottom: 0.5rem !important;
        }

        /* Enhanced Progress Bars */
        .progress {
            height: 8px !important;
            background: rgba(102, 126, 234, 0.1) !important;
            border-radius: 4px !important;
            overflow: hidden !important;
        }

        .progress-bar {
            background: var(--primary-gradient) !important;
            border-radius: 4px !important;
            position: relative !important;
            overflow: hidden !important;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* LANDR/TuneCore Enhanced Cards and Forms */
        .card {
            border-radius: 20px !important;
            border: 1px solid rgba(0, 0, 0, 0.06) !important;
            transition: all var(--transition-base) !important;
            background: #fafbfc !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04) !important;
        }

        .card:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08) !important;
            border-color: rgba(102, 126, 234, 0.2) !important;
        }

        .card-body {
            padding: 2rem !important;
        }

        /* Modern Form Elements */
        .form-check {
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            border-radius: 12px !important;
            background: rgba(102, 126, 234, 0.02) !important;
            border: 1px solid rgba(102, 126, 234, 0.1) !important;
            transition: all var(--transition-base) !important;
        }

        .form-check:hover {
            background: rgba(102, 126, 234, 0.04) !important;
            border-color: rgba(102, 126, 234, 0.2) !important;
        }

        .form-check-input:checked {
            background-color: #667eea !important;
            border-color: #667eea !important;
        }

        .form-check-label {
            font-family: var(--font-display) !important;
            font-weight: 500 !important;
            color: var(--text-primary) !important;
        }

        .form-check-label strong {
            font-weight: 700 !important;
            color: var(--text-primary) !important;
        }

        /* Enhanced File Results */
        .stem-file {
            border-radius: 16px !important;
            transition: all var(--transition-base) !important;
        }

        .stem-file:hover {
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-md) !important;
            border-color: rgba(102, 126, 234, 0.2) !important;
        }

        /* Utility Classes */
        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Performance Optimizations */
        .will-change-transform {
            will-change: transform;
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .btn-primary {
                padding: 0.875rem 1.5rem !important;
                font-size: 0.875rem !important;
            }
            
            .hero-section {
                padding-top: 100px !important;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        
        /* Final LANDR/TuneCore Professional Touches */
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .processing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .processing-indicator::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Professional button micro-interactions */
        .btn-modern:active {
            transform: scale(0.98) translateY(-1px) !important;
            transition: all 0.1s ease !important;
        }

        .btn-modern:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        /* Professional A/B Comparison Player - LANDR Style */
        .professional-ab-player {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 
                        0 8px 16px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .professional-ab-player::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        .ab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ab-title {
            color: #f8fafc;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.025em;
        }

        .ab-controls {
            display: flex;
            gap: 12px;
        }

        .loop-btn, .solo-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #cbd5e1;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .loop-btn:hover, .solo-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #f8fafc;
            transform: translateY(-1px);
        }

        .loop-btn.active, .solo-btn.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #3b82f6;
            color: white;
        }

        .dual-waveform-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .waveform-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .original-section {
            border-left: 3px solid #ef4444;
        }

        .mastered-section {
            border-left: 3px solid #22c55e;
        }

        .waveform-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .label-text {
            color: #f8fafc;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.025em;
        }

        .level-meter {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .level-bar {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #eab308 70%, #ef4444 100%);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 2px;
        }

        .waveform-wrapper {
            position: relative;
            padding: 16px;
            height: 120px;
        }

        .waveform-display {
            width: 100%;
            height: 88px;
            border-radius: 6px;
            overflow: hidden;
        }

        .waveform-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .lufs-indicator {
            background: rgba(0, 0, 0, 0.8);
            color: #f8fafc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .transport-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transport-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .transport-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .transport-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .transport-btn:active {
            transform: translateY(0px);
        }

        .time-display {
            color: #cbd5e1;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: 600;
        }

        .ab-switch-center {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ab-switch-btn {
            background: transparent;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 80px;
        }

        .ab-switch-btn.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .switch-label {
            font-size: 18px;
            font-weight: 700;
            color: #f8fafc;
        }

        .switch-text {
            font-size: 12px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .ab-switch-btn.active .switch-text {
            color: white;
        }

        .switch-separator {
            width: 1px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 8px;
        }

        .transport-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cbd5e1;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .dual-waveform-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .transport-controls {
                flex-direction: column;
                gap: 16px;
            }
            
            .ab-switch-center {
                order: -1;
            }

            /* Services section mobile optimization */
            #services {
                min-height: auto !important;
                padding: 60px 0 !important;
            }
            
            #services h2 {
                font-size: 2rem !important;
            }
            
            .service-card {
                min-height: 380px !important;
                margin-bottom: 2rem !important;
            }

            /* Benefits section mobile */
            .benefit-icon {
                width: 60px !important;
                height: 60px !important;
            }
            
            .benefit-icon i {
                font-size: 1.5rem !important;
            }

            /* How it works section mobile */
            .step-number {
                width: 60px !important;
                height: 60px !important;
            }
            
            .step-number span {
                font-size: 1.5rem !important;
            }

            /* Typography mobile adjustments */
            h2 {
                font-size: 2rem !important;
            }
            
            .lead {
                font-size: 1.1rem !important;
            }
        }

        /* Tablet responsiveness */
        @media (max-width: 992px) and (min-width: 769px) {
            #services {
                min-height: 80vh !important;
            }
            
            .service-card {
                min-height: 400px !important;
            }

            #services h2 {
                font-size: 2.5rem !important;
            }
        }

        /* Large mobile devices */
        @media (max-width: 576px) {
            .container {
                padding-left: 20px !important;
                padding-right: 20px !important;
            }

            #services {
                padding: 40px 0 !important;
            }

            #services h2 {
                font-size: 1.75rem !important;
            }
            
            .service-card {
                min-height: 350px !important;
            }

            .service-card .card-body {
                padding: 1.5rem !important;
            }

            .d-flex.gap-4 {
                flex-direction: column !important;
                gap: 1rem !important;
            }

            .benefit-icon {
                width: 50px !important;
                height: 50px !important;
            }
            
            .benefit-icon i {
                font-size: 1.2rem !important;
            }

            .step-number {
                width: 50px !important;
                height: 50px !important;
            }
            
            .step-number span {
                font-size: 1.3rem !important;
            }
        }

        /* Enhanced Visual Hierarchy and Spacing */
        .section-spacer {
            padding: 100px 0;
        }

        .section-spacer-sm {
            padding: 80px 0;
        }

        /* Improved animations and transitions */
        .service-card,
        .benefit-icon,
        .step-number {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .service-card:hover .service-icon-wrapper i {
            transform: scale(1.1);
            transition: transform 0.3s ease;
        }

        .benefit-icon:hover {
            transform: translateY(-5px);
        }

        .step-number:hover {
            transform: scale(1.1);
        }

        /* Enhanced section dividers */
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.1) 50%, transparent 100%);
            margin: 0;
        }

        /* Improved scroll behavior */
        html {
            scroll-padding-top: 80px;
        }

        /* Better focus states for accessibility */
        .service-card:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Enhanced container spacing */
        .container {
            max-width: 1200px;
        }

        /* Improved vertical rhythm */
        .mb-section {
            margin-bottom: 4rem;
        }

        .mb-section-lg {
            margin-bottom: 6rem;
        }

        /* üöÄ Enhanced Mode Toggle Styling */
        .form-check-input:checked {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        .form-check-input:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(107, 33, 168, 0.25) !important;
        }

        .form-check-label {
            cursor: pointer !important;
        }

        /* Enhanced card with special glow when enhanced mode is active */
        .enhanced-card.enhanced-active {
            animation: enhancedGlow 2s ease-in-out infinite alternate;
        }

        @keyframes enhancedGlow {
            from {
                box-shadow: 0 16px 40px rgba(102, 126, 234, 0.15);
            }
            to {
                box-shadow: 0 16px 40px rgba(102, 126, 234, 0.25);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="https://www.kleindigitalsolutions.de" target="_blank" rel="noopener">Klein Digital Solutions</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#separator">Separator</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#mastering">Mastering</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#transcription">Transcription</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#pricing">Preise</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#features">Features</a>
                    </li>
                    <!-- Authentication -->
                    <li class="nav-item" id="auth-buttons">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="showAuthModal('login')">
                            <i class="fas fa-sign-in-alt me-1"></i>Login
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="showAuthModal('register')">
                            <i class="fas fa-user-plus me-1"></i>Registrieren
                        </button>
                    </li>
                    <!-- User Menu (hidden by default) -->
                    <li class="nav-item dropdown" id="user-menu" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="user-email"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <!-- Credit Balance Display -->
                            <li>
                                <div class="dropdown-item-text text-center bg-light border-bottom pb-2 mb-2">
                                    <small class="text-muted d-block">Aktueller Stand:</small>
                                    <span class="credit-balance badge bg-secondary">Loading...</span>
                                </div>
                            </li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="showDashboard()">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="handleCreditPurchase('starter')">
                                <i class="fas fa-coins me-2"></i>Credits kaufen
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Authentication Modal -->
    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="authModalTitle">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Login Form -->
                    <div id="loginForm">
                        <form onsubmit="handleLogin(event)">
                            <div class="mb-3">
                                <label for="loginEmail" class="form-label">E-Mail Adresse</label>
                                <input type="email" class="form-control" id="loginEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">Passwort</label>
                                <input type="password" class="form-control" id="loginPassword" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="loginBtn">
                                    <i class="fas fa-sign-in-alt me-2"></i>Einloggen
                                </button>
                            </div>
                        </form>
                        <div class="text-center mt-3">
                            <a href="#" onclick="switchAuthMode('register')">Noch kein Account? Registrieren</a>
                        </div>
                        <div class="text-center mt-2">
                            <a href="#" onclick="showPasswordReset()">Passwort vergessen?</a>
                        </div>
                    </div>

                    <!-- Registration Form -->
                    <div id="registerForm" style="display: none;">
                        <form onsubmit="handleRegister(event)">
                            <div class="mb-3">
                                <label for="registerName" class="form-label">Vollst√§ndiger Name</label>
                                <input type="text" class="form-control" id="registerName" required>
                            </div>
                            <div class="mb-3">
                                <label for="registerEmail" class="form-label">E-Mail Adresse</label>
                                <input type="email" class="form-control" id="registerEmail" required>
                            </div>
                            <div class="mb-3">
                                <label for="registerCompany" class="form-label">Firma (optional)</label>
                                <input type="text" class="form-control" id="registerCompany">
                            </div>
                            <div class="mb-3">
                                <label for="registerPassword" class="form-label">Passwort</label>
                                <input type="password" class="form-control" id="registerPassword" required minlength="6">
                            </div>
                            <div class="mb-3">
                                <label for="registerPasswordConfirm" class="form-label">Passwort best√§tigen</label>
                                <input type="password" class="form-control" id="registerPasswordConfirm" required>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    Ich akzeptiere die <a href="#" target="_blank">AGB</a> und <a href="#" target="_blank">Datenschutzerkl√§rung</a>
                                </label>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="registerBtn">
                                    <i class="fas fa-user-plus me-2"></i>Registrieren
                                </button>
                            </div>
                        </form>
                        <div class="text-center mt-3">
                            <a href="#" onclick="switchAuthMode('login')">Bereits registriert? Einloggen</a>
                        </div>
                    </div>

                    <!-- Password Reset Form -->
                    <div id="passwordResetForm" style="display: none;">
                        <form onsubmit="handlePasswordReset(event)">
                            <div class="mb-3">
                                <label for="resetEmail" class="form-label">E-Mail Adresse</label>
                                <input type="email" class="form-control" id="resetEmail" required>
                                <div class="form-text">Wir senden Ihnen einen Link zum Zur√ºcksetzen Ihres Passworts.</div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="resetBtn">
                                    <i class="fas fa-envelope me-2"></i>Reset-Link senden
                                </button>
                            </div>
                        </form>
                        <div class="text-center mt-3">
                            <a href="#" onclick="switchAuthMode('login')">Zur√ºck zum Login</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Dashboard Modal -->
    <div class="modal fade" id="dashboardModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-tachometer-alt me-2"></i>Mein Dashboard
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="dashboardContent">
                    <!-- Dashboard content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <section id="home" class="hero-section text-center d-flex align-items-center">
        <div class="container" style="margin-top: 80px;">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <h1 class="display-4 fw-bold mb-4" style="color: #f8f9fa; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">Studio Audio Tools</h1>
                    <p class="lead mb-5" style="color: #e9ecef; font-size: 1.25rem; max-width: 700px; margin: 0 auto;">
                        Professionelle Stem-Separation, AI-Mastering und Musiktranskription mit modernster neuronaler Netzwerk-Technologie
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Service Selection -->
    <section id="services" class="py-5" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); min-height: 90vh; display: flex; align-items: center;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="text-center mb-5" style="max-width: 800px; margin: 0 auto;">
                        <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill mb-3" style="font-size: 0.9rem; font-weight: 500;">AI-POWERED MUSIC STUDIO</span>
                        <h2 class="mb-4" style="font-size: 3rem; font-weight: 700; color: #1e293b; line-height: 1.2;">W√§hlen Sie Ihren Service</h2>
                        <p class="lead mb-4" style="color: #64748b; font-size: 1.3rem; font-weight: 400; line-height: 1.6;">Erlebe automatisches Mastering, professionelle Stem-Trennung, Musik-Transkription und Speech Enhancement mit modernster KI. Perfekt f√ºr Musiker, Produzenten und Content Creators.</p>
                        <div class="d-flex justify-content-center gap-4 flex-wrap mb-5">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span style="color: #64748b; font-weight: 500;">Professionelle Qualit√§t</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span style="color: #64748b; font-weight: 500;">Blitzschnelle Verarbeitung</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span style="color: #64748b; font-weight: 500;">KI-gest√ºtzte Technologie</span>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 service-card enhanced-card" onclick="selectService('separator')" style="min-height: 420px; position: relative;">
                                
                                <div class="card-body text-center d-flex flex-column">
                                    <div class="service-icon-wrapper mb-4" style="height: 80px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-music fa-3x text-primary"></i>
                                    </div>
                                    <h4 class="mb-3" style="font-size: 1.4rem; font-weight: 600;">üöÄ Enhanced AI Stem Separation</h4>
                                    <p class="text-muted mb-4 flex-grow-1" style="font-size: 1rem; line-height: 1.6;">BS-RoFormer (9.65dB SDR) + Asteroid Post-Processing + DSP Enhancement f√ºr verbesserte Qualit√§t.</p>
                                    <div class="service-features mt-auto">
                                        <div class="feature-list text-start">
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;"><strong>9.65dB SDR</strong> + Asteroid + DSP</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Ensemble + Asteroid Post-Processing</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Standard Stems (Vocals, Drums, Bass, Other)</span>
                                            </div>
                                            <div class="feature-item">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Professional DSP Enhancement</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 service-card" onclick="selectService('mastering')" style="min-height: 420px;">
                                <div class="card-body text-center d-flex flex-column">
                                    <div class="service-icon-wrapper mb-4" style="height: 80px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-sliders-h fa-3x text-primary"></i>
                                    </div>
                                    <h4 class="mb-3" style="font-size: 1.4rem; font-weight: 600;">Professional AI Mastering</h4>
                                    <p class="text-muted mb-4 flex-grow-1" style="font-size: 1rem; line-height: 1.6;">Erreichen Sie kommerzielle Lautst√§rke und professionellen Sound. Automatisches Mastering nach Industry-Standards f√ºr Streaming-Plattformen.</p>
                                    <div class="service-features mt-auto">
                                        <div class="feature-list text-start">
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">LUFS-Targeting (-16/-14/-9 LUFS)</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Bass Mono-Making & FFT-Analyse</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Intelligente Multi-Band EQ</span>
                                            </div>
                                            <div class="feature-item">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">16bit/24bit Professional Output</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 service-card" onclick="selectService('transcription')" style="min-height: 420px;">
                                <div class="card-body text-center d-flex flex-column">
                                    <div class="service-icon-wrapper mb-4" style="height: 80px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-file-audio fa-3x text-primary"></i>
                                    </div>
                                    <h4 class="mb-3" style="font-size: 1.4rem; font-weight: 600;">AI Music Transcription</h4>
                                    <p class="text-muted mb-4 flex-grow-1" style="font-size: 1rem; line-height: 1.6;">Konvertieren Sie jede Aufnahme in bearbeitbare MIDI-Dateien. Perfekt f√ºr Musikanalyse, Remixing und digitale Musikproduktion.</p>
                                    <div class="service-features mt-auto">
                                        <div class="feature-list text-start">
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Akkord-Erkennung (essentia)</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Melodie-Transkription (basic-pitch)</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Drum-Pattern Analyse (madmom)</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Beat & Tempo (madmom)</span>
                                            </div>
                                            <div class="feature-item">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">MIDI & JSON Export</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 service-card" onclick="selectService('enhancement')" style="min-height: 420px;">
                                <div class="card-body text-center d-flex flex-column">
                                    <div class="service-icon-wrapper mb-4" style="height: 80px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-microphone-alt fa-3x text-primary"></i>
                                    </div>
                                    <h4 class="mb-3" style="font-size: 1.4rem; font-weight: 600;">Speech Enhancement</h4>
                                    <p class="text-muted mb-4 flex-grow-1" style="font-size: 1rem; line-height: 1.6;">Professionelle Sprachverbesserung mit KI-gest√ºtzter Rauschunterdr√ºckung, F√ºllwort-Entfernung und Qualit√§tsoptimierung f√ºr Podcasts und Aufnahmen.</p>
                                    <div class="service-features mt-auto">
                                        <div class="feature-list text-start">
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">DeepFilterNet Noise Reduction</span>
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Whisper Filler Word Removal</span>
                                            </div>
                                            <div class="feature-item">
                                                <i class="fas fa-check text-success me-2" style="font-size: 0.9rem;"></i>
                                                <span style="font-size: 0.95rem; font-weight: 500;">Broadcast-Quality Processing</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Benefits Section -->
    <section class="py-5" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-top: 1px solid rgba(0,0,0,0.05);">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center mb-5">
                    <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill mb-3" style="font-size: 0.9rem; font-weight: 500;">WARUM KLEIN DIGITAL SOLUTIONS?</span>
                    <h2 class="mb-4" style="font-size: 2.5rem; font-weight: 700; color: #1e293b;">Professionelle Ergebnisse mit modernster KI</h2>
                    <p class="lead" style="color: #64748b; font-size: 1.2rem;">Unsere KI-gest√ºtzten Tools bieten Ihnen professionelle Audioqualit√§t, die sonst nur in teuren Studios verf√ºgbar ist.</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-lg-4 col-md-6">
                    <div class="text-center">
                        <div class="benefit-icon mb-3" style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-rocket text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h4 class="mb-3" style="font-weight: 600; color: #1e293b;">Blitzschnelle Verarbeitung</h4>
                        <p style="color: #64748b; line-height: 1.6;">Hochmoderne GPU-Cluster verarbeiten Ihre Dateien in Rekordzeit - von Sekunden bis Minuten statt Stunden.</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="text-center">
                        <div class="benefit-icon mb-3" style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-award text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h4 class="mb-3" style="font-weight: 600; color: #1e293b;">Studio-Qualit√§t garantiert</h4>
                        <p style="color: #64748b; line-height: 1.6;">Professionelle Ergebnisse durch modernste neuronale Netzwerke und Broadcasting-Standards.</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="text-center">
                        <div class="benefit-icon mb-3" style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-shield-alt text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h4 class="mb-3" style="font-weight: 600; color: #1e293b;">Sicher & Privat</h4>
                        <p style="color: #64748b; line-height: 1.6;">Ihre Dateien werden sicher verarbeitet und automatisch nach der Bearbeitung gel√∂scht. DSGVO-konform.</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="text-center">
                        <div class="benefit-icon mb-3" style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-cog text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h4 class="mb-3" style="font-weight: 600; color: #1e293b;">Keine Installation n√∂tig</h4>
                        <p style="color: #64748b; line-height: 1.6;">Funktioniert direkt im Browser - keine Software-Installation oder komplizierte Setups erforderlich.</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="text-center">
                        <div class="benefit-icon mb-3" style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-magic text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h4 class="mb-3" style="font-weight: 600; color: #1e293b;">KI-gest√ºtzte Pr√§zision</h4>
                        <p style="color: #64748b; line-height: 1.6;">Modernste neuronale Netzwerke wie BS-RoFormer f√ºr h√∂chste Genauigkeit bei der Audioverarbeitung.</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="text-center">
                        <div class="benefit-icon mb-3" style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-headphones text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h4 class="mb-3" style="font-weight: 600; color: #1e293b;">24/7 Verf√ºgbar</h4>
                        <p style="color: #64748b; line-height: 1.6;">Rund um die Uhr verf√ºgbar - verarbeiten Sie Ihre Audio-Projekte wann immer Sie m√∂chten.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works Section -->
    <section class="py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center mb-5">
                    <span class="badge bg-white bg-opacity-20 text-white px-3 py-2 rounded-pill mb-3" style="font-size: 0.9rem; font-weight: 500;">SO EINFACH GEHT'S</span>
                    <h2 class="mb-4" style="font-size: 2.5rem; font-weight: 700;">In 3 einfachen Schritten zu professionellen Ergebnissen</h2>
                    <p class="lead" style="font-size: 1.2rem; color: rgba(255,255,255,0.9);">Laden Sie Ihre Datei hoch, w√§hlen Sie den gew√ºnschten Service und erhalten Sie professionelle Ergebnisse.</p>
                </div>
            </div>
            <div class="row g-5">
                <div class="col-lg-4 text-center">
                    <div class="step-number mb-4" style="width: 80px; height: 80px; margin: 0 auto; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        <span style="font-size: 2rem; font-weight: 700;">1</span>
                    </div>
                    <h4 class="mb-3" style="font-weight: 600;">Service ausw√§hlen</h4>
                    <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">W√§hlen Sie aus Stem Separation, AI Mastering, Transcription oder Speech Enhancement - je nach Ihrem Bedarf.</p>
                </div>
                <div class="col-lg-4 text-center">
                    <div class="step-number mb-4" style="width: 80px; height: 80px; margin: 0 auto; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        <span style="font-size: 2rem; font-weight: 700;">2</span>
                    </div>
                    <h4 class="mb-3" style="font-weight: 600;">Audio-Datei hochladen</h4>
                    <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">Ziehen Sie Ihre MP3, WAV oder FLAC Datei einfach in den Upload-Bereich oder klicken Sie zum Ausw√§hlen.</p>
                </div>
                <div class="col-lg-4 text-center">
                    <div class="step-number mb-4" style="width: 80px; height: 80px; margin: 0 auto; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        <span style="font-size: 2rem; font-weight: 700;">3</span>
                    </div>
                    <h4 class="mb-3" style="font-weight: 600;">Professionelle Ergebnisse erhalten</h4>
                    <p style="color: rgba(255,255,255,0.9); line-height: 1.6;">Nach wenigen Minuten erhalten Sie Ihre verarbeiteten Dateien in Studioqualit√§t zum Download.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Music Separation Section -->
    <section id="separator" class="py-5" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h2 class="text-center mb-5">Start Your Music Separation</h2>
                    
                    <!-- Connection Status -->
                    <div class="text-center mb-4">
                        <div id="connection-status" class="small text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Verbindung wird getestet...
                        </div>
                    </div>

                    <!-- Stem Selection -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">W√§hlen Sie Ihre gew√ºnschten Stems</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="stemSelection" id="all-stems" value="all" checked>
                                            <label class="form-check-label" for="all-stems">
                                                <strong>Alle Stems</strong> (Vocals, Drums, Bass, Other) - <em>~2-3 Minuten</em>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="stemSelection" id="vocals-only" value="vocals">
                                            <label class="form-check-label" for="vocals-only">
                                                <strong>Nur Vocals</strong> - <em>~30 Sekunden</em>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="stemSelection" id="drums-only" value="drums">
                                            <label class="form-check-label" for="drums-only">
                                                <strong>Nur Drums</strong> - <em>~30 Sekunden</em>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="stemSelection" id="bass-only" value="bass">
                                            <label class="form-check-label" for="bass-only">
                                                <strong>Nur Bass</strong> - <em>~30 Sekunden</em>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="stemSelection" id="custom-stems" value="custom">
                                            <label class="form-check-label" for="custom-stems">
                                                <strong>Benutzerdefiniert</strong> - W√§hlen Sie mehrere:
                                            </label>
                                            <div class="mt-2 ms-4" id="custom-checkboxes" style="display: none;">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="custom-vocals" value="vocals">
                                                    <label class="form-check-label" for="custom-vocals">Vocals</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="custom-drums" value="drums">
                                                    <label class="form-check-label" for="custom-drums">Drums</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="custom-bass" value="bass">
                                                    <label class="form-check-label" for="custom-bass">Bass</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="custom-other" value="other">
                                                    <label class="form-check-label" for="custom-other">Other</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üöÄ ENHANCED: "Ultrathink" Quality Options -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">Enhanced Processing Mode</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                <div class="card border-primary border-2">
                                    <div class="card-body">
                                        <!-- Enhanced Mode Toggle -->
                                        <div class="form-check form-switch mb-4">
                                            <input class="form-check-input" type="checkbox" id="enhanced-mode" checked style="transform: scale(1.2);">
                                            <label class="form-check-label" for="enhanced-mode" style="cursor: pointer;">
                                                <strong>üöÄ Enhanced Mode aktivieren</strong> - <em>Asteroid + DSP Enhancement</em>
                                                <p class="small text-primary mb-0">BS-RoFormer + Neural Post-Processing + Professional DSP</p>
                                            </label>
                                        </div>

                                        <!-- Enhanced Processing Info -->
                                        <div class="mb-3" id="enhanced-processing-info">
                                            <div class="alert alert-info">
                                                <strong>Enhanced Processing:</strong> BS-RoFormer + Asteroid Neural Enhancement + Professional DSP
                                            </div>
                                        </div>

                                        <!-- Standard Stems -->
                                        <div class="mb-3" id="stems-info">
                                            <div class="alert alert-secondary">
                                                <strong>Stems:</strong> Vocals, Drums, Bass, Other (4 Standard-Stems)
                                            </div>
                                        </div>

                                        <!-- Processing Features -->
                                        <div class="row" id="processing-features">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="use-asteroid" checked disabled>
                                                    <label class="form-check-label" for="use-asteroid">
                                                        <strong>‚úÖ Asteroid Neural Enhancement</strong>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="use-dsp" checked disabled>
                                                    <label class="form-check-label" for="use-dsp">
                                                        <strong>‚úÖ Professional DSP Processing</strong>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Classic Pro-Features Options (Legacy) -->
                    <div class="mb-4" id="classic-options" style="display: none;">
                        <h4 class="text-center mb-4">Classic Mode Optionen</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="use-tta">
                                            <label class="form-check-label" for="use-tta">
                                                <strong>H√∂chste Qualit√§t (TTA)</strong> - <em>Verdoppelt die Verarbeitungszeit</em>
                                                <p class="small text-muted mb-0">Reduziert Artefakte durch mehrfache Analyse. Empfohlen f√ºr finale Produktionen.</p>
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="extract-instrumental">
                                            <label class="form-check-label" for="extract-instrumental">
                                                <strong>Instrumental-Version erstellen</strong>
                                                <p class="small text-muted mb-0">Erzeugt eine zus√§tzliche Spur ohne Gesang. Ideal f√ºr Karaoke.</p>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div>
                        <h4 class="text-center mb-4">Laden Sie Ihre Datei hoch</h4>
                        <p class="text-center text-muted mb-4">BS-RoFormer - State-of-the-Art Qualit√§t mit schneller Verarbeitung.</p>
                        <div class="upload-zone" id="upload-zone">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                            <h4>Drag & Drop Ihre Musik-Datei hier</h4>
                            <p class="text-muted">oder klicken Sie zum Ausw√§hlen</p>
                            <p class="small text-muted">Unterst√ºtzte Formate: MP3, WAV, FLAC, M4A, AAC (max. 100MB)</p>
                            <input type="file" id="file-input" accept=".mp3,.wav,.flac,.m4a,.aac" style="display: none;">
                        </div>
                        
                        <!-- Start Button -->
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg" id="start-separation-btn" onclick="startSeparation()" disabled>
                                <i class="fas fa-music"></i> Stem-Trennung starten
                            </button>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-container" id="progress-container">
                        <h4 class="text-center">Verarbeitung l√§uft...</h4>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="progress-info" class="text-center">
                            <p id="progress-text">Initialisierung...</p>
                            <p id="progress-time" class="text-muted"></p>
                        </div>
                    </div>

                    <!-- Download Section -->
                    <div class="download-section" id="download-section">
                        <h4 class="text-center mb-4">Ihre Stems sind bereit!</h4>
                        <div id="stem-files"></div>
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg" onclick="downloadAllStems()">
                                <i class="fas fa-download"></i> Alle Stems als ZIP herunterladen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- AI Mastering Section -->
    <section id="mastering" class="py-5" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h2 class="text-center mb-5">AI-Powered Mastering</h2>
                    
                    <!-- Connection Status -->
                    <div class="text-center mb-4">
                        <div id="mastering-connection-status" class="small text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Automatic Mastering Service wird getestet...
                        </div>
                    </div>

                    <!-- Mastering Intensity Selection -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">Mastering Intensit√§t & LUFS-Zielwerte</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="radio" name="masteringIntensity" id="intensity-low" value="low">
                                            <label class="form-check-label w-100" for="intensity-low">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>üéß Audiophil</strong> - Dynamisches Mastering
                                                        <br><small class="text-muted">Erh√§lt nat√ºrliche Dynamik, ideal f√ºr kritisches H√∂ren</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-info">-16.0 LUFS</span>
                                                        <br><small class="text-muted">Audiophile Qualit√§t</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="form-check mb-3 p-3 border rounded style="background-color: #fafbfc;"">
                                            <input class="form-check-input" type="radio" name="masteringIntensity" id="intensity-medium" value="medium" checked>
                                            <label class="form-check-label w-100" for="intensity-medium">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>üéµ Streaming</strong> - Industry Standard
                                                        <br><small class="text-muted">Optimiert f√ºr Spotify, Apple Music, YouTube</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-success">-14.0 LUFS</span>
                                                        <br><small class="text-muted">Streaming Standard</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="form-check p-3 border rounded">
                                            <input class="form-check-input" type="radio" name="masteringIntensity" id="intensity-high" value="high">
                                            <label class="form-check-label w-100" for="intensity-high">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>üîä Club/Radio</strong> - Maximale Lautheit
                                                        <br><small class="text-muted">Aggressives Mastering f√ºr laute Umgebungen</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-warning text-dark">-9.0 LUFS</span>
                                                        <br><small class="text-muted">Maximale Lautheit</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Features -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">Professionelle Features</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="bass-mono-making" checked>
                                            <label class="form-check-label" for="bass-mono-making">
                                                <strong>üîä Bass Mono-Making</strong> - Profi-Trick f√ºr druckvollen Bass
                                                <p class="small text-muted mb-0">Macht Frequenzen unter 150Hz mono f√ºr besseren Punch und Kompatibilit√§t</p>
                                            </label>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="intelligent-eq" checked>
                                            <label class="form-check-label" for="intelligent-eq">
                                                <strong>üß† Intelligente Frequenz-Analyse</strong> - KI-gest√ºtzte EQ-Anpassungen
                                                <p class="small text-muted mb-0">FFT-Analyse erkennt und korrigiert automatisch Frequenz-Probleme</p>
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="lufs-targeting" checked>
                                            <label class="form-check-label" for="lufs-targeting">
                                                <strong>üéØ LUFS-Targeting</strong> - Industry-Standard Lautheit
                                                <p class="small text-muted mb-0">Automatische Anpassung auf professionelle LUFS-Zielwerte</p>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Output Format Selection -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">Output Format</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="format-16bit" checked>
                                            <label class="form-check-label" for="format-16bit">
                                                <strong>16-bit PCM</strong> - Standard f√ºr Streaming & Distribution
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="format-24bit" checked>
                                            <label class="form-check-label" for="format-24bit">
                                                <strong>24-bit PCM</strong> - H√∂chste Qualit√§t f√ºr weitere Bearbeitung
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Preparation Guide -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">üìã Audio-Vorbereitung f√ºr optimale Ergebnisse</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-lightbulb"></i> <strong>Professionelle Tipps f√ºr beste Mastering-Qualit√§t</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-volume-up text-primary"></i> <strong>Idealer Pegel</strong></h6>
                                                <ul class="list-unstyled small">
                                                    <li><span class="badge bg-success">‚úÖ Optimal:</span> Peak bei <strong>-6dB bis -3dB</strong></li>
                                                    <li><span class="badge bg-warning">‚ö†Ô∏è Zu leise:</span> Peak unter -12dB (wenig Headroom-Nutzung)</li>
                                                    <li><span class="badge bg-danger">‚ùå Zu laut:</span> Peak √ºber -1dB (Gefahr von Clipping)</li>
                                                </ul>
                                                
                                                <h6><i class="fas fa-cog text-primary"></i> <strong>Technische Specs</strong></h6>
                                                <ul class="list-unstyled small">
                                                    <li><span class="badge bg-info">üìä</span> <strong>Sample Rate:</strong> 44.1kHz oder h√∂her</li>
                                                    <li><span class="badge bg-info">üéöÔ∏è</span> <strong>Bit Depth:</strong> 24-bit empfohlen</li>
                                                    <li><span class="badge bg-info">üîÑ</span> <strong>Format:</strong> WAV, FLAC (verlustfrei)</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-ban text-primary"></i> <strong>Vermeiden Sie</strong></h6>
                                                <ul class="list-unstyled small">
                                                    <li><span class="badge bg-danger">‚ùå</span> Bereits gemasterte Tracks</li>
                                                    <li><span class="badge bg-danger">‚ùå</span> Limiter auf der Summe</li>
                                                    <li><span class="badge bg-danger">‚ùå</span> Aggressive Kompression</li>
                                                    <li><span class="badge bg-danger">‚ùå</span> MP3 als Ausgangsformat</li>
                                                </ul>
                                                
                                                <h6><i class="fas fa-thumbs-up text-primary"></i> <strong>Ideal f√ºr unsere KI</strong></h6>
                                                <ul class="list-unstyled small">
                                                    <li><span class="badge bg-success">‚úÖ</span> Sauberer, unbearbeiteter Mix</li>
                                                    <li><span class="badge bg-success">‚úÖ</span> Ausgewogene Frequenzen</li>
                                                    <li><span class="badge bg-success">‚úÖ</span> Nat√ºrliche Dynamik erhalten</li>
                                                    <li><span class="badge bg-success">‚úÖ</span> Stereo-Mix (f√ºr Bass Mono-Making)</li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3 p-3 style="background-color: #fafbfc;" rounded">
                                            <h6><i class="fas fa-magic text-primary"></i> <strong>Was unsere KI automatisch korrigiert:</strong></h6>
                                            <div class="row small">
                                                <div class="col-md-4">
                                                    <strong>üîä Bass-Probleme</strong><br>
                                                    <span class="text-muted">Zu viel/wenig Bass wird erkannt und angepasst</span>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>üé§ Vocal-Balance</strong><br>
                                                    <span class="text-muted">Mid-Frequenzen werden intelligent optimiert</span>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>‚ú® H√∂hen-Klarheit</strong><br>
                                                    <span class="text-muted">Harte oder dumpfe H√∂hen werden korrigiert</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="text-center mt-3">
                                            <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detailedGuide">
                                                <i class="fas fa-info-circle"></i> Detaillierte Anleitung anzeigen
                                            </button>
                                        </div>
                                        
                                        <div class="collapse mt-3" id="detailedGuide">
                                            <div class="card border-secondary">
                                                <div class="card-body small">
                                                    <h6><strong>üéöÔ∏è Mixing-Vorbereitung f√ºr optimales Mastering:</strong></h6>
                                                    <ol>
                                                        <li><strong>Gain Staging:</strong> Alle Tracks sollten genug Headroom haben</li>
                                                        <li><strong>Bus-Kompression:</strong> Maximal sanfte Kompression (1.5:1 ratio)</li>
                                                        <li><strong>EQ-Sauberkeit:</strong> High-Pass Filter auf unn√∂tige B√§sse</li>
                                                        <li><strong>Panning:</strong> Klare Stereo-Verteilung f√ºr Bass Mono-Making</li>
                                                        <li><strong>Referenz-Check:</strong> Auf verschiedenen Lautsprechern testen</li>
                                                    </ol>
                                                    
                                                    <h6><strong>üî¨ Technische Qualit√§tskontrolle:</strong></h6>
                                                    <ul>
                                                        <li><strong>RMS-Level:</strong> Idealerweise zwischen -18dB und -12dB</li>
                                                        <li><strong>Dynamik:</strong> Mindestens 6dB Dynamikumfang</li>
                                                        <li><strong>Clipping-Check:</strong> Keine digitalen Verzerrungen</li>
                                                        <li><strong>Phase-Koh√§renz:</strong> Mono-Kompatibilit√§t pr√ºfen</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div>
                        <h4 class="text-center mb-4">Upload Your Audio</h4>
                        <p class="text-center text-muted mb-4">Professional AI Mastering - No reference track needed</p>
                        
                        <!-- Target Audio Upload -->
                        <div class="mb-4">
                            <div class="upload-zone" id="target-upload-zone">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                <h4>Drag & Drop Your Audio File</h4>
                                <p class="text-muted">oder klicken Sie zum Ausw√§hlen</p>
                                <p class="small text-muted">Max. 50MB - MP3, WAV, FLAC, M4A, AAC</p>
                                <input type="file" id="target-file-input" accept=".mp3,.wav,.flac,.m4a,.aac" style="display: none;">
                            </div>
                        </div>

                        <!-- Process Button -->
                        <div class="text-center">
                            <button class="btn btn-primary btn-lg" id="start-mastering-btn" onclick="startMastering()" disabled>
                                <i class="fas fa-sliders-h"></i> Start Automatic Mastering
                            </button>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-container" id="mastering-progress-container" style="display: none;">
                        <h4 class="text-center">Mastering l√§uft...</h4>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="mastering-progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="mastering-progress-info" class="text-center">
                            <p id="mastering-progress-text">Initialisierung...</p>
                            <p id="mastering-progress-time" class="text-muted"></p>
                        </div>
                    </div>

                    <!-- Download Section -->
                    <div class="download-section" id="mastering-download-section" style="display: none;">
                        <h4 class="text-center mb-4">Ihre gemasterten Tracks sind bereit!</h4>
                        
                        <!-- Professional A/B Comparison Player (LANDR-style) -->
                        <div class="professional-ab-player" id="ab-comparison-player" style="display: none;">
                            <div class="ab-header">
                                <h5 class="ab-title">
                                    <i class="fas fa-waveform-lines me-2"></i>
                                    Professional A/B Comparison
                                </h5>
                                <div class="ab-controls">
                                    <button class="loop-btn" id="loop-toggle" onclick="toggleLoop()">
                                        <i class="fas fa-repeat"></i>
                                        <span>Loop</span>
                                    </button>
                                    <button class="solo-btn" id="solo-toggle" onclick="toggleSolo()">
                                        <i class="fas fa-headphones"></i>
                                        <span>Solo</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="dual-waveform-container">
                                <!-- Original Waveform -->
                                <div class="waveform-section original-section">
                                    <div class="waveform-label">
                                        <span class="label-text">Original</span>
                                        <div class="level-meter">
                                            <div class="level-bar" id="original-level"></div>
                                        </div>
                                    </div>
                                    <div class="waveform-wrapper">
                                        <div id="original-waveform" class="waveform-display"></div>
                                        <div class="waveform-overlay">
                                            <div class="lufs-indicator" id="original-lufs">-16.2 LUFS</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Mastered Waveform -->
                                <div class="waveform-section mastered-section">
                                    <div class="waveform-label">
                                        <span class="label-text">Mastered</span>
                                        <div class="level-meter">
                                            <div class="level-bar" id="mastered-level"></div>
                                        </div>
                                    </div>
                                    <div class="waveform-wrapper">
                                        <div id="mastered-waveform" class="waveform-display"></div>
                                        <div class="waveform-overlay">
                                            <div class="lufs-indicator" id="mastered-lufs">-14.1 LUFS</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Professional Transport Controls -->
                            <div class="transport-controls">
                                <div class="transport-left">
                                    <button class="transport-btn" id="transport-play" onclick="togglePlayPause()">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="transport-btn" onclick="stopPlayback()">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    <div class="time-display">
                                        <span id="current-time">00:00</span> / <span id="total-time">00:00</span>
                                    </div>
                                </div>
                                
                                <div class="ab-switch-center">
                                    <button class="ab-switch-btn active" id="btn-original" onclick="switchAudio('original')" data-audio="original">
                                        <span class="switch-label">A</span>
                                        <span class="switch-text">Original</span>
                                    </button>
                                    <div class="switch-separator"></div>
                                    <button class="ab-switch-btn" id="btn-mastered" onclick="switchAudio('mastered')" data-audio="mastered">
                                        <span class="switch-label">B</span>
                                        <span class="switch-text">Mastered</span>
                                    </button>
                                </div>
                                
                                <div class="transport-right">
                                    <div class="volume-control">
                                        <i class="fas fa-volume-up"></i>
                                        <input type="range" class="volume-slider" id="master-volume" min="0" max="100" value="80">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="mastered-files"></div>
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg" onclick="downloadAllMastered()">
                                <i class="fas fa-download"></i> Alle Tracks als ZIP herunterladen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Music Transcription Section V2 -->
    <section id="transcription" class="py-5" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h2 class="text-center mb-4">Professionelle Musik-Transkription</h2>
                    <p class="text-center text-muted mb-5">Analysieren Sie jeden Aspekt Ihres Tracks mit branchenf√ºhrenden KI-Modellen. Erstellen Sie MIDI-Dateien, extrahieren Sie Rhythmus-Grids und entdecken Sie die harmonische Struktur Ihrer Musik.</p>

                    <!-- Connection Status -->
                    <div class="text-center mb-4">
                        <div id="transcription-connection-status" class="small text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Transkriptions-Service wird getestet...
                        </div>
                    </div>

                    <!-- Transcription Options -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">W√§hlen Sie Ihre Analyse-Module</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                <div class="card">
                                    <div class="card-body">
                                        <!-- Melody -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="task-melody" checked>
                                            <label class="form-check-label" for="task-melody">
                                                <strong>üéπ Melodie & Instrumente (basic-pitch)</strong>
                                                <p class="small text-muted mb-0">Generiert eine saubere MIDI-Datei von polyphonen Instrumenten. Perfekt, um Melodien in Ihrer DAW mit eigenen VSTs nachzuspielen.</p>
                                            </label>
                                        </div>
                                        <!-- Drums -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="task-drums">
                                            <label class="form-check-label" for="task-drums">
                                                <strong>ü•Å Drums & Percussion (madmom)</strong>
                                                <p class="small text-muted mb-0">Erkennt pr√§zise Drum-Anschl√§ge (Onsets) und erstellt ein exaktes Rhythmus-Grid. Ideal, um Drum-Samples auszutauschen oder zu synchronisieren.</p>
                                            </label>
                                        </div>
                                        <!-- Chords -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="task-chords" checked>
                                            <label class="form-check-label" for="task-chords">
                                                <strong>üé∏ Akkorde & Harmonie (essentia)</strong>
                                                <p class="small text-muted mb-0">Extrahiert die komplette Akkordfolge eines Songs. Unverzichtbar f√ºr Remixe, Cover-Versionen oder das Schreiben passender Basslines.</p>
                                            </label>
                                        </div>
                                        <!-- Beats -->
                                        <div class="form-check form-switch p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="task-beats">
                                            <label class="form-check-label" for="task-beats">
                                                <strong>‚è±Ô∏è Beat & Tempo (madmom)</strong>
                                                <p class="small text-muted mb-0">Erstellt ein perfektes Tempo-Grid (Click Track), auch bei variierendem Tempo. Die Grundlage f√ºr jeden Remix und jedes Sample.</p>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div>
                        <h4 class="text-center mb-4">Laden Sie Ihre Datei hoch</h4>
                        <div class="upload-zone" id="transcription-upload-zone">
                            <i class="fas fa-file-audio fa-3x mb-3 text-muted"></i>
                            <h4>Drag & Drop Ihre Musik-Datei hier</h4>
                            <p class="text-muted">oder klicken Sie zum Ausw√§hlen</p>
                            <p class="small text-muted">Unterst√ºtzte Formate: MP3, WAV, FLAC, M4A (max. 50MB)</p>
                            <input type="file" id="transcription-file-input" accept=".mp3,.wav,.flac,.m4a" style="display: none;">
                        </div>
                    </div>

                    <!-- Process Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" id="start-transcription-btn" onclick="startTranscription()" disabled>
                            <i class="fas fa-cogs"></i> Transkription starten
                        </button>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-container" id="transcription-progress-container">
                        <h4 class="text-center">Verarbeitung l√§uft...</h4>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="transcription-progress-bar" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <div class="text-center">
                            <div id="transcription-status-text" class="small text-muted">Initialisierung...</div>
                            <div id="transcription-processing-time" class="small text-muted"></div>
                        </div>
                    </div>

                    <!-- Download Section -->
                    <div class="download-section" id="transcription-download-section">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>Transkription abgeschlossen!</h5>
                            <p class="mb-3">Ihre Musik wurde erfolgreich transkribiert. Laden Sie die Ergebnisse herunter:</p>
                        </div>
                        <div id="transcription-download-links"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Audio Enhancement Section -->
    <section id="enhancement" class="py-5" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h2 class="text-center mb-4">Professional Speech Enhancement</h2>
                    <p class="text-center text-muted mb-5">Verwandeln Sie Ihre Aufnahmen in broadcast-ready Audio. Entfernen Sie Hintergrundger√§usche, optimieren Sie die Klangqualit√§t und eliminieren Sie st√∂rende Elemente wie F√ºllw√∂rter und Husten.</p>
                    
                    <!-- Connection Status -->
                    <div class="text-center mb-4">
                        <div id="enhancement-connection-status" class="small text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Audio Enhancement Service wird getestet...
                        </div>
                    </div>
                    
                    <!-- Enhancement Options -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">Enhancement-Optionen</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                <div class="card">
                                    <div class="card-body">
                                        <!-- Basic Enhancement -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="enhancement-noise-reduction" checked>
                                            <label class="form-check-label" for="enhancement-noise-reduction">
                                                <strong>üîß Noise Reduction</strong>
                                                <p class="small text-muted mb-0">Entfernt Hintergrundger√§usche, Rauschen und St√∂rungen mit DeepFilterNet AI</p>
                                            </label>
                                        </div>
                                        
                                        <!-- Volume Optimization -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="enhancement-volume-normalization" checked>
                                            <label class="form-check-label" for="enhancement-volume-normalization">
                                                <strong>üìä Volume Normalization</strong>
                                                <p class="small text-muted mb-0">Optimiert Lautst√§rke und Dynamik f√ºr konsistente H√∂rerfahrung</p>
                                            </label>
                                        </div>
                                        
                                        <!-- Silence Trimming -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="enhancement-silence-trimming" checked>
                                            <label class="form-check-label" for="enhancement-silence-trimming">
                                                <strong>‚úÇÔ∏è Silence Trimming</strong>
                                                <p class="small text-muted mb-0">Entfernt √ºberfl√ºssige Pausen am Anfang und Ende der Aufnahme</p>
                                            </label>
                                        </div>
                                        
                                        <!-- Advanced Options -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="enhancement-filler-words">
                                            <label class="form-check-label" for="enhancement-filler-words">
                                                <strong>üó£Ô∏è Filler Word Removal (Premium)</strong>
                                                <p class="small text-muted mb-0">Erkennt und entfernt "√§h", "√§hm", "mh" mit Whisper AI</p>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="enhancement-cough-detection">
                                            <label class="form-check-label" for="enhancement-cough-detection">
                                                <strong>ü§ß Cough Detection (Premium)</strong>
                                                <p class="small text-muted mb-0">Automatische Erkennung und Entfernung von Husten mit YAMNet AI</p>
                                            </label>
                                        </div>
                                        
                                        <!-- Quality Enhancement -->
                                        <div class="form-check form-switch mb-3 p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="enhancement-quality" checked>
                                            <label class="form-check-label" for="enhancement-quality">
                                                <strong>‚ú® Audio Quality Enhancement</strong>
                                                <p class="small text-muted mb-0">Professionelle EQ und Kompression f√ºr broadcast-ready Klang</p>
                                            </label>
                                        </div>
                                        
                                        <!-- Loudness Targeting -->
                                        <div class="form-check form-switch p-3 border rounded">
                                            <input class="form-check-input" type="checkbox" id="enhancement-loudness" checked>
                                            <label class="form-check-label" for="enhancement-loudness">
                                                <strong>üéöÔ∏è Loudness Targeting</strong>
                                                <p class="small text-muted mb-0">Optimiert f√ºr Podcast/Broadcast Standards (-16 LUFS)</p>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Upload Section -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">Laden Sie Ihre Datei hoch</h4>
                        <p class="text-center text-muted mb-4">AI-basierte Audio Enhancement mit modernsten Algorithmen.</p>
                        <div class="upload-zone" id="enhancement-upload-zone">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                            <h4>Drag & Drop Ihre Audio-Datei hier</h4>
                            <p class="text-muted">oder klicken Sie zum Ausw√§hlen</p>
                            <p class="small text-muted">Unterst√ºtzte Formate: MP3, WAV, FLAC, M4A, AAC (max. 100MB)</p>
                            <input type="file" id="enhancement-file-input-main" accept=".mp3,.wav,.flac,.m4a,.aac" style="display: none;">
                        </div>
                        
                        <!-- Start Button -->
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg" id="start-enhancement-btn" onclick="startEnhancement()" disabled>
                                <i class="fas fa-magic me-2"></i>Enhancement starten
                            </button>
                        </div>
                    </div>

                    <!-- Enhancement Presets -->
                    <div class="mb-4">
                        <h4 class="text-center mb-4">Quick Presets</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="selectEnhancementPreset('podcast')">
                                        <i class="fas fa-microphone me-2"></i>Podcast
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="selectEnhancementPreset('interview')">
                                        <i class="fas fa-comments me-2"></i>Interview
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="selectEnhancementPreset('presentation')">
                                        <i class="fas fa-presentation me-2"></i>Presentation
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="selectEnhancementPreset('voiceover')">
                                        <i class="fas fa-volume-up me-2"></i>Voiceover
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Processing Section -->
                    <div id="enhancement-processing" style="display: none;">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5>Audio Enhancement l√§uft...</h5>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="enhancement-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                </div>
                                <p id="enhancement-status" class="text-muted">Initialisierung...</p>
                                <div id="enhancement-phase" class="small text-muted"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="enhancement-results" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="text-center mb-4">Enhancement abgeschlossen! ‚ú®</h5>
                                <div id="enhancement-metrics" class="mb-4"></div>
                                <div id="enhancement-comparison" class="mb-4">
                                    <h6>Vorher/Nachher Vergleich:</h6>
                                    <div id="enhancement-waveform"></div>
                                </div>
                                <div id="enhancement-download-links" class="text-center">
                                    <p class="mb-3">Ihre enhanced Audio ist bereit:</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Launch Special Announcement -->
    <div class="alert alert-warning alert-dismissible fade show border-0 shadow-sm text-center" role="alert">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <i class="fas fa-fire text-danger me-2"></i>
                    <strong>üöÄ LAUNCH SPECIAL - Nur f√ºr kurze Zeit!</strong>
                    <br>
                    <span class="text-dark">Sparen Sie bis zu <strong>54%</strong> auf alle Credit-Pakete! Dieses Angebot gilt nur, w√§hrend wir unseren neuen Service einf√ºhren.</span>
                </div>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Pricing Section -->
    <section id="pricing" class="py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10 text-center mb-5">
                    <h2 class="fw-bold mb-4">üíé Neues Credit-System - Launch-Angebot!</h2>
                    <p class="text-muted mb-3">Kaufen Sie Credits und nutzen Sie alle AI-Services flexibel nach Bedarf.</p>
                    <div class="alert alert-info d-inline-block">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>1 Credit = 1 Service</strong> ‚Ä¢ Stem Separation ‚Ä¢ AI Mastering ‚Ä¢ Speech Enhancement ‚Ä¢ Music Transcription
                    </div>
                </div>
            </div>
            
            <div class="row justify-content-center">
                <!-- Single Credit Pack -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body text-center p-4 d-flex flex-column">
                            <div class="mb-3">
                                <i class="fas fa-play fa-2x text-info"></i>
                            </div>
                            <h4 class="card-title fw-bold">Testen</h4>
                            <div class="mb-3">
                                <small class="text-muted text-decoration-line-through">‚Ç¨4.99</small>
                                <br>
                                <span class="h3 fw-bold text-info">‚Ç¨3.49</span>
                                <br>
                                <span class="badge bg-danger">30% Rabatt</span>
                            </div>
                            <div class="mb-4">
                                <h5 class="text-primary">1 Credit</h5>
                            </div>
                            <ul class="list-unstyled mb-4 text-start flex-grow-1">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>1x AI Service nutzen</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Alle Features verf√ºgbar</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>WAV & MP3 Download</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Nie ablaufend</li>
                            </ul>
                            <button class="btn btn-info w-100 mt-auto" onclick="handleCreditPurchase('single')">
                                Jetzt kaufen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Starter Pack -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card h-100 shadow border-success border-2 position-relative">
                        <div class="position-absolute top-0 start-50 translate-middle">
                            <span class="badge bg-success px-3 py-1">Beliebt</span>
                        </div>
                        <div class="card-body text-center p-4 d-flex flex-column">
                            <div class="mb-3">
                                <i class="fas fa-star fa-2x text-success"></i>
                            </div>
                            <h4 class="card-title fw-bold">Starter</h4>
                            <div class="mb-3">
                                <small class="text-muted text-decoration-line-through">‚Ç¨34.90</small>
                                <br>
                                <span class="h3 fw-bold text-success">‚Ç¨24.99</span>
                                <br>
                                <span class="badge bg-danger">28% Rabatt</span>
                            </div>
                            <div class="mb-4">
                                <h5 class="text-primary">10 Credits</h5>
                                <p class="text-muted small">‚Ç¨2.50 pro Credit</p>
                            </div>
                            <ul class="list-unstyled mb-4 text-start flex-grow-1">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>10x AI Services nutzen</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Alle Features verf√ºgbar</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>WAV & MP3 Download</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Nie ablaufend</li>
                            </ul>
                            <button class="btn btn-success w-100 mt-auto" onclick="handleCreditPurchase('starter')">
                                Jetzt kaufen
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Pro Pack -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card h-100 shadow border-primary border-2 position-relative">
                        <div class="position-absolute top-0 start-50 translate-middle">
                            <span class="badge bg-primary px-3 py-1">Beliebt</span>
                        </div>
                        <div class="card-body text-center p-4 d-flex flex-column">
                            <div class="mb-3">
                                <i class="fas fa-crown fa-2x text-primary"></i>
                            </div>
                            <h4 class="card-title fw-bold">Pro</h4>
                            <div class="mb-3">
                                <small class="text-muted text-decoration-line-through">‚Ç¨87.25</small>
                                <br>
                                <span class="h3 fw-bold text-primary">‚Ç¨49.99</span>
                                <br>
                                <span class="badge bg-danger">43% Rabatt</span>
                            </div>
                            <div class="mb-4">
                                <h5 class="text-primary">25 Credits</h5>
                                <p class="text-muted small">‚Ç¨2.00 pro Credit</p>
                            </div>
                            <ul class="list-unstyled mb-4 text-start flex-grow-1">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>25x AI Services nutzen</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Alle Features verf√ºgbar</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>WAV & MP3 Download</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Nie ablaufend</li>
                            </ul>
                            <button class="btn btn-success w-100 mt-auto" onclick="handleCreditPurchase('pro')">
                                Jetzt kaufen
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Studio Pack -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card h-100 shadow border-warning border-2 position-relative">
                        <div class="position-absolute top-0 start-50 translate-middle">
                            <span class="badge bg-warning text-dark px-3 py-1">Beste Ersparnis</span>
                        </div>
                        <div class="card-body text-center p-4 d-flex flex-column">
                            <div class="mb-3">
                                <i class="fas fa-building fa-2x text-warning"></i>
                            </div>
                            <h4 class="card-title fw-bold">Studio</h4>
                            <div class="mb-3">
                                <small class="text-muted text-decoration-line-through">‚Ç¨174.50</small>
                                <br>
                                <span class="h3 fw-bold text-warning">‚Ç¨79.99</span>
                                <br>
                                <span class="badge bg-danger">54% Rabatt</span>
                            </div>
                            <div class="mb-4">
                                <h5 class="text-primary">50 Credits</h5>
                                <p class="text-muted small">‚Ç¨1.60 pro Credit</p>
                            </div>
                            <ul class="list-unstyled mb-4 text-start flex-grow-1">
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>50x AI Services nutzen</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Alle Features verf√ºgbar</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>WAV & MP3 Download</li>
                                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Nie ablaufend</li>
                            </ul>
                            <button class="btn btn-warning w-100 text-dark mt-auto" onclick="handleCreditPurchase('studio')">
                                Jetzt kaufen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feature Comparison Table -->
            <div class="row justify-content-center mt-5">
                <div class="col-lg-10">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-center mb-4">Detaillierter Feature-Vergleich</h3>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">Features</th>
                                            <th scope="col" class="text-center">Kostenlos</th>
                                            <th scope="col" class="text-center">Starter (10)</th>
                                            <th scope="col" class="text-center">Pro (25)</th>
                                            <th scope="col" class="text-center">Studio (50)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Credits im Paket</strong></td>
                                            <td class="text-center">3 kostenlos</td>
                                            <td class="text-center">10</td>
                                            <td class="text-center">25</td>
                                            <td class="text-center">50</td>
                                        </tr>
                                        <tr>
                                            <td>AI Stem Separation</td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Professional AI Mastering</td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Music Transcription & MIDI Export</td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Speech Enhancement & Noise Reduction</td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                        </tr>
                                        <tr>
                                            <td>WAV & MP3 Downloads</td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Credits laufen nie ab</td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trust Indicators -->
            <div class="row justify-content-center mt-5">
                <div class="col-lg-8 text-center">
                    <h4 class="mb-4">Vertrauensw√ºrdig & Sicher</h4>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="trust-badge">
                                <i class="fab fa-stripe fa-2x text-primary mb-2"></i>
                                <p class="small mb-0">Sichere Zahlung<br>mit Stripe</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="trust-badge">
                                <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                <p class="small mb-0">SSL verschl√ºsselt<br>& DSGVO konform</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="trust-badge">
                                <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                <p class="small mb-0">Jederzeit k√ºndbar<br>Keine Bindung</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="trust-badge">
                                <i class="fas fa-headset fa-2x text-warning mb-2"></i>
                                <p class="small mb-0">24/7 Support<br>bei Fragen</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="py-5" style="background-color: #f8fafc;">
        <div class="container">
            <h2 class="text-center mb-5">Die f√ºhrende AI-Plattform f√ºr Musikproduzenten</h2>
            <div class="row">
                <div class="col-lg-4 text-center mb-4">
                    <i class="fas fa-chart-line features-icon"></i>
                    <h4>Studio-Grade AI Technology</h4>
                    <p>Hochmoderne neuronale Netzwerke liefern professionelle Ergebnisse in Broadcast-Qualit√§t f√ºr Stem-Separation, Mastering und Transkription</p>
                </div>
                <div class="col-lg-4 text-center mb-4">
                    <i class="fas fa-award features-icon"></i>
                    <h4>100% K√ºnstlerkontrolle</h4>
                    <p>Behalten Sie volle kreative Kontrolle - Ihre Musik, Ihre Rechte. Pr√§zise MIDI-Exports und hochaufl√∂sende Stems ohne Qualit√§tsverlust</p>
                </div>
                <div class="col-lg-4 text-center mb-4">
                    <i class="fas fa-bolt features-icon"></i>
                    <h4>Blitzschnelle Verarbeitung</h4>
                    <p>Modernste GPU-beschleunigte Verarbeitung mit enterprise-grade Sicherheit. Ihre Dateien sind verschl√ºsselt und werden automatisch gel√∂scht</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 text-center text-lg-start mb-3 mb-lg-0">
                    <h5>Klein Digital Solutions</h5>
                    <p>Professionelle KI-Services f√ºr die Musikindustrie</p>
                </div>
                <div class="col-lg-6 text-center text-lg-end">
                    <p class="mb-2">¬© 2025 Klein Digital Solutions. Alle Rechte vorbehalten.</p>
                    <div class="footer-links">
                        <a href="javascript:void(0)" onclick="showLegalModal('impressum')" class="text-light me-3">Impressum</a>
                        <a href="javascript:void(0)" onclick="showLegalModal('agb')" class="text-light me-3">AGB</a>
                        <a href="javascript:void(0)" onclick="showLegalModal('datenschutz')" class="text-light me-3">Datenschutz</a>
                        <a href="https://kleindigitalsolutions.de" class="text-light" target="_blank">kleindigitalsolutions.de</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script>
        // Navbar transparency on scroll
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 60) {
                navbar.classList.add('transparent');
            } else {
                navbar.classList.remove('transparent');
            }
        });
    </script>
    <script>
        // Configuration - Modal Serverless APIs
        const API_BASE = 'https://bucci369--music-ai-separator-zfturbo-complete-fastapi-app.modal.run';
        const HEALTH_URL = 'https://bucci369--music-ai-separator-zfturbo-complete-fastapi-app.modal.run/health';
        const MODELS_URL = 'https://bucci369--music-ai-separator-zfturbo-complete-fastapi-app.modal.run/models';
        
        // üöÄ ENHANCED API with "Ultrathink" Processing - BS-RoFormer + Asteroid + DSP
        const ENHANCED_API_BASE = 'https://bucci369--music-ai-separator-enhanced-enhanced-fastapi-app.modal.run';
        const ENHANCED_HEALTH_URL = 'https://bucci369--music-ai-separator-enhanced-enhanced-fastapi-app.modal.run/health/enhanced';
        const ENHANCED_MODELS_URL = 'https://bucci369--music-ai-separator-enhanced-enhanced-fastapi-app.modal.run/models/enhanced';
        
        // Matchering 2.0 API Configuration
        const MATCHERING_API_BASE = 'https://bucci369--matchering-ai-mastering-matchering-app.modal.run';
        const MATCHERING_HEALTH_URL = 'https://bucci369--matchering-ai-mastering-matchering-app.modal.run/health';
        
        let selectedModel = 'mvsep_ensemble'; // MVSEP Ensemble verwenden
        let currentJobId = null;
        let models = {};
        let isEnhancedMode = true; // üöÄ Default to Enhanced mode for best quality
        const MODAL_API_BASE = 'https://bucci369--music-ai-separator-zfturbo-complete-fastapi-app.modal.run';

        // Global variables for mastering
        let targetFile = null;
        let currentMasteringJobId = null;
        let masteringStatusInterval = null;

        // Service selection functions
        function selectService(service) {
            // Hide all service sections
            document.getElementById('separator').style.display = 'none';
            document.getElementById('mastering').style.display = 'none';
            document.getElementById('transcription').style.display = 'none';
            document.getElementById('enhancement').style.display = 'none';
            
            // Remove active class from all service cards
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Show selected service and mark card as active
            if (service === 'separator') {
                document.getElementById('separator').style.display = 'block';
                document.querySelector('.service-card[onclick="selectService(\'separator\')"]').classList.add('active');
                
                // üöÄ Initialize Enhanced Mode Toggle when separator is selected
                setTimeout(() => {
                    initializeEnhancedMode();
                }, 200);
                
                // Test separator connection
                testConnection().then(result => {
                    console.log('Separator connection test:', result);
                    if (!result.success) {
                        console.error('Separator API connection failed:', result.message);
                    }
                });
                // Setup separation uploads
                setupSeparationUploads();
            } else if (service === 'mastering') {
                document.getElementById('mastering').style.display = 'block';
                document.querySelector('.service-card[onclick="selectService(\'mastering\')"]').classList.add('active');
                // Test mastering connection
                testMasteringConnection();
                // Setup mastering uploads when service is selected
                setupMasteringUploads();
            } else if (service === 'transcription') {
                document.getElementById('transcription').style.display = 'block';
                document.querySelector('.service-card[onclick="selectService(\'transcription\')"]').classList.add('active');
                // Test transcription connection
                testTranscriptionConnection();
            } else if (service === 'enhancement') {
                document.getElementById('enhancement').style.display = 'block';
                // Test enhancement connection
                testEnhancementConnection();
            }
            
            // Scroll to the selected service
            document.getElementById(service).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Connection test function
        async function testConnection() {
            const statusElement = document.getElementById('connection-status');
            
            try {
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verbindung wird getestet...';
                }
                
                console.log('üîó Testing separator API connection...');
                const response = await fetch(HEALTH_URL, { 
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Separator API connected:', data);
                    
                    if (statusElement) {
                        statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Verbunden mit Modal API - BS-RoFormer bereit';
                        statusElement.className = 'small text-success';
                    }
                    
                    return { success: true, message: 'Verbindung erfolgreich' };
                } else {
                    console.error('‚ùå Separator API error:', response.status);
                    
                    if (statusElement) {
                        statusElement.innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i> Server-Fehler: ${response.status}`;
                        statusElement.className = 'small text-danger';
                    }
                    
                    return { success: false, message: `Server-Fehler: ${response.status}` };
                }
            } catch (error) {
                console.error('‚ùå Separator API connection failed:', error);
                
                if (statusElement) {
                    safeHTML(statusElement, '<i class="fas fa-times-circle text-danger"></i> Verbindungsfehler: ');
                    const errorSpan = document.createElement('span');
                    errorSpan.textContent = error.message;
                    statusElement.appendChild(errorSpan);
                    statusElement.className = 'small text-danger';
                }
                
                return { success: false, message: `Verbindungsfehler: ${error.message}` };
            }
        }

        // Load models and pricing
        async function loadModels() {
            try {
                const response = await fetch(MODELS_URL);
                const data = await response.json();
                
                // Handle new API structure
                models = data.models || data;
                
                // renderModelSelection(); // Nicht mehr ben√∂tigt
                // renderPricingCards(); // Nicht mehr ben√∂tigt
                
                // Show connection status
                document.getElementById('connection-status').innerHTML = '<i class="fas fa-check-circle text-success"></i> Verbindung OK';
            } catch (error) {
                console.error('Failed to load models:', error);
                document.getElementById('connection-status').innerHTML = '<i class="fas fa-exclamation-circle text-warning"></i> Verbindungsprobleme';
            }
        }

        // renderModelSelection and renderPricingCards are no longer needed

        // Variables for separation
        let separationFile = null;
        
        // File upload handling for separation
        function setupSeparationUploads() {
            console.log('üéµ Setting up separation uploads...');
            
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('file-input');
            
            if (!uploadZone || !fileInput) {
                console.error('‚ùå Separator upload elements not found:', { uploadZone, fileInput });
                return;
            }
            
            console.log('‚úÖ Found separator upload elements:', { uploadZone: !!uploadZone, fileInput: !!fileInput });
            
            // Remove existing listeners to prevent duplicates
            uploadZone.replaceWith(uploadZone.cloneNode(true));
            fileInput.replaceWith(fileInput.cloneNode(true));
            
            // Re-get the elements after cloning
            const newUploadZone = document.getElementById('upload-zone');
            const newFileInput = document.getElementById('file-input');
            
            newUploadZone.addEventListener('click', () => {
                console.log('üîΩ Upload zone clicked');
                newFileInput.click();
            });
            newUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                newUploadZone.classList.add('dragover');
            });
            newUploadZone.addEventListener('dragleave', () => {
                newUploadZone.classList.remove('dragover');
            });
            newUploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                newUploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('üìÅ File dropped:', files[0].name);
                    handleSeparationFileSelect(files[0]);
                }
            });
            newFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleSeparationFileSelect(e.target.files[0]);
                }
            });
        }
        
        // Handle file selection for separation (not processing yet)
        function handleSeparationFileSelect(file) {
            // Validate file
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/mp4', 'audio/aac'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|flac|m4a|aac)$/i)) {
                alert('Unsupported file format. Please use MP3, WAV, FLAC, M4A, or AAC.');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) { // 100MB limit
                alert('File too large. Maximum size is 100MB.');
                return;
            }
            
            separationFile = file;
            const uploadZone = document.getElementById('upload-zone');
            safeHTML(uploadZone, `
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h4>Audio bereit: <span class="filename"></span></h4>
                <p class="text-muted">${(file.size / (1024*1024)).toFixed(1)} MB</p>
            `);
            uploadZone.querySelector('.filename').textContent = file.name;
            
            checkSeparationReady();
        }
        
        // Check if separation is ready to start
        function checkSeparationReady() {
            const startBtn = document.getElementById('start-separation-btn');
            if (separationFile) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-music"></i> Stem-Trennung starten';
            } else {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-music"></i> Datei w√§hlen';
            }
        }
        
        // üöÄ Enhanced Separation Processing with "Ultrathink"
        async function startSeparation() {
            // ‚úÖ PAYWALL CHECK FIRST
            const canUse = await checkUsageLimit();
            if (!canUse) {
                console.log('üö´ Paywall blocked separation - user limit reached');
                return; // Stop if paywall blocks usage
            }
            console.log('‚úÖ Paywall passed - proceeding with separation');
            
            if (!separationFile) {
                alert('Bitte w√§hlen Sie eine Audio-Datei aus');
                return;
            }
            
            // Check if Enhanced Mode is enabled
            const isEnhanced = document.getElementById('enhanced-mode')?.checked || false;
            
            if (isEnhanced) {
                console.log('üöÄ Starting Enhanced separation with Ultrathink processing');
                await handleEnhancedFileUpload(separationFile);
            } else {
                console.log('üìº Starting Classic separation');
                await handleFileUpload(separationFile);
            }
        }

        // üöÄ Enhanced File Upload Handler
        async function handleEnhancedFileUpload(file) {
            console.log('üöÄ Enhanced processing started for:', file.name);
            
            // Get Enhanced settings
            const qualityMode = 'enhanced'; // Fixed mode - Asteroid + DSP
            const stemConfiguration = 'standard'; // Fixed to standard 4 stems
            const useEnsemble = false; // No ensemble, single BS-RoFormer
            const useAsteroid = true; // Real Asteroid enhancement
            const useDsp = true; // Real DSP processing
            
            console.log('üéõÔ∏è Enhanced settings:', {
                qualityMode,
                stemConfiguration,
                useEnsemble,
                useAsteroid,
                useDsp
            });
            
            showProgress();
            updateProgress(5, 'üöÄ Initialisiere Enhanced Pipeline...');

            const formData = new FormData();
            formData.append('audio_file', file);
            formData.append('selected_stems', stemConfiguration);
            formData.append('quality_mode', qualityMode);
            formData.append('use_ensemble', useEnsemble);
            formData.append('use_asteroid', useAsteroid);
            formData.append('use_dsp', useDsp);

            try {
                console.log('üöÄ Sending to Enhanced API:', ENHANCED_API_BASE + '/enhanced');
                
                const response = await fetch(ENHANCED_API_BASE + '/enhanced', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Enhanced processing started:', result);
                    
                    currentJobId = result.job_id;
                    
                    updateProgress(10, `üß† Enhanced Processing gestartet (${result.expected_quality})`);
                    
                    // Start enhanced progress polling
                    startEnhancedProgressPolling(currentJobId);
                    
                } else {
                    const errorText = await response.text();
                    throw new Error(`Enhanced API Error: ${response.status} - ${errorText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Enhanced processing failed:', error);
                hideProgress();
                alert('Enhanced processing failed: ' + error.message + '\n\nFalling back to Classic mode...');
                
                // Fallback to classic processing
                await handleFileUpload(file);
            }
        }

        // üöÄ Enhanced Progress Polling
        function startEnhancedProgressPolling(jobId) {
            if (statusInterval) {
                IntervalManager.clear(statusInterval);
            }
            
            statusInterval = IntervalManager.create(async () => {
                try {
                    const response = await fetch(`${ENHANCED_API_BASE}/status/${jobId}`);
                    if (response.ok) {
                        const status = await response.json();
                        
                        // Enhanced progress display
                        const progressText = status.phase || 'Enhanced Processing...';
                        const qualityInfo = status.features?.expected_sdr ? ` (${status.features.expected_sdr})` : '';
                        
                        updateProgress(status.progress || 0, progressText + qualityInfo);
                        
                        // Display quality metrics if available
                        if (status.quality_metrics) {
                            const metrics = status.quality_metrics;
                            console.log('üìä Quality Metrics:', metrics);
                        }
                        
                        // Check if processing is complete
                        if (status.status === 'completed') {
                            IntervalManager.clear(statusInterval);
                            statusInterval = null;
                            
                            // Show enhanced completion message
                            const completionMessage = `üéâ Enhanced Processing Complete! SDR: ${status.quality_metrics?.achieved_sdr || '9.65dB + Enhancement'} (${status.processing_time}s)`;
                            updateProgress(100, completionMessage);
                            
                            // Display enhanced results
                            setTimeout(() => {
                                hideProgress();
                                displayEnhancedResults(status, jobId);
                            }, 1500);
                            
                        } else if (status.status === 'error') {
                            IntervalManager.clear(statusInterval);
                            statusInterval = null;
                            hideProgress();
                            alert('Enhanced Processing Error: ' + (status.error || 'Unknown error'));
                        }
                        
                    } else {
                        console.warn('‚ö†Ô∏è Enhanced status check failed');
                    }
                } catch (error) {
                    console.error('‚ùå Enhanced polling error:', error);
                }
            }, 3000); // Check every 3 seconds for enhanced processing
        }

        // üöÄ Display Enhanced Results
        function displayEnhancedResults(status, jobId) {
            console.log('üéâ Displaying Enhanced results:', status);
            
            const downloadSection = document.getElementById('download-section');
            const downloadLinks = document.getElementById('stem-files'); // ‚úÖ Korrekt f√ºr Enhanced Mode
            
            if (!downloadSection || !downloadLinks) {
                console.error('‚ùå Download section not found');
                return;
            }
            
            // Clear previous results
            downloadLinks.innerHTML = '';
            
            // Enhanced results header
            const headerHtml = `
                <div class="text-center mb-4">
                    <div class="badge bg-success bg-opacity-10 text-success px-4 py-3 rounded-pill mb-3">
                        <i class="fas fa-trophy me-2"></i>
                        <strong>Enhanced Processing Complete!</strong>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card border-success">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <h5 class="text-success mb-1">${status.quality_metrics?.achieved_sdr || '9.65dB + Enhancement'}</h5>
                                            <small class="text-muted">SDR Quality</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h5 class="text-success mb-1">${status.files?.length || 0}</h5>
                                            <small class="text-muted">Stems</small>
                                        </div>
                                        <div class="col-md-4">
                                            <h5 class="text-success mb-1">${status.total_size_mb || 0}MB</h5>
                                            <small class="text-muted">Total Size</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            downloadLinks.innerHTML = headerHtml;
            
            // Enhanced file links
            if (status.files && Array.isArray(status.files)) {
                const filesHtml = status.files.map(filename => {
                    const stemName = filename.replace('.wav', '');
                    const stemIcon = getStemIcon(stemName);
                    const downloadUrl = `${ENHANCED_API_BASE}/download/${jobId}/final_stems/${filename}`;
                    const previewUrl = `${ENHANCED_API_BASE}/preview/${jobId}/final_stems/preview_${filename}`;
                    
                    const uniqueId = `enhanced-waveform-${stemName}`;
                    
                    return `
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card h-100 border-primary border-opacity-25">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="${stemIcon} fa-2x text-primary"></i>
                                    </div>
                                    <h6 class="card-title">${stemName.charAt(0).toUpperCase() + stemName.slice(1)}</h6>
                                    
                                    <!-- Enhanced Waveform Display -->
                                    <div class="waveform-container mb-3" style="height: 60px; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden;">
                                        <div id="${uniqueId}" style="height: 100%; width: 100%;"></div>
                                    </div>
                                    
                                    <div class="btn-group-vertical w-100">
                                        <button class="btn btn-outline-primary btn-sm mb-2" onclick="toggleEnhancedPlayPause('${stemName}', '${uniqueId}')">
                                            <i id="enhanced-play-icon-${stemName}" class="fas fa-play me-1"></i>Preview
                                        </button>
                                        <a href="${downloadUrl}" class="btn btn-primary btn-sm" download="${filename}">
                                            <i class="fas fa-download me-1"></i>Download
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                downloadLinks.innerHTML += `
                    <div class="row">
                        ${filesHtml}
                    </div>
                `;
            }
            
            // Store enhanced results for global access
            lastDownloadBaseUrl = status.download_base_url;
            lastJobId = jobId;
            lastFiles = status.files;
            
            // Initialize Enhanced Waveforms after DOM update
            setTimeout(() => {
                initializeEnhancedWaveforms(status.files, jobId);
            }, 100);
            
            // Show download section
            downloadSection.style.display = 'block';
            downloadSection.scrollIntoView({ behavior: 'smooth' });
        }

        // üöÄ Enhanced Preview Player
        function playEnhancedPreview(previewUrl, stemName) {
            console.log('üéµ Playing enhanced preview:', previewUrl);
            
            // Stop current audio if playing
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            // Create and play enhanced preview
            currentAudio = new Audio(previewUrl);
            currentAudio.volume = 0.7;
            
            currentAudio.play().then(() => {
                console.log(`‚úÖ Enhanced preview playing: ${stemName}`);
            }).catch(error => {
                console.error(`‚ùå Enhanced preview failed for ${stemName}:`, error);
                alert(`Preview nicht verf√ºgbar f√ºr ${stemName}`);
            });
        }

        // Enhanced audio players storage
        let enhancedAudioPlayers = {};
        let currentlyPlayingEnhanced = null;

        // Initialize Enhanced Waveforms
        function initializeEnhancedWaveforms(files, jobId) {
            console.log('üéµ Initializing Enhanced waveforms for:', files);
            
            if (!files || !Array.isArray(files)) return;
            
            files.forEach(filename => {
                const stemName = filename.replace('.wav', '');
                const containerId = `enhanced-waveform-${stemName}`;
                const previewUrl = `${ENHANCED_API_BASE}/preview/${jobId}/final_stems/preview_${filename}`;
                
                console.log(`üîó Enhanced Preview URL: ${previewUrl}`);
                
                try {
                    const wavesurfer = WaveSurfer.create({
                        container: `#${containerId}`,
                        waveColor: '#4A90E2',
                        progressColor: '#50E3C2',
                        cursorColor: '#ffffff',
                        barWidth: 2,
                        barRadius: 1,
                        responsive: true,
                        height: 60,
                        normalize: true,
                        backend: 'WebAudio'
                    });
                    
                    wavesurfer.load(previewUrl);
                    
                    // Error handling for enhanced preview loading
                    wavesurfer.on('error', (error) => {
                        console.error(`‚ùå Enhanced WaveSurfer error for ${filename}:`, error);
                        // Try fallback to original WAV file if MP3 preview fails
                        const fallbackUrl = `${ENHANCED_API_BASE}/download/${jobId}/final_stems/${filename}`;
                        console.log(`üîÑ Trying enhanced fallback URL: ${fallbackUrl}`);
                        wavesurfer.load(fallbackUrl);
                    });
                    
                    wavesurfer.on('ready', () => {
                        console.log(`‚úÖ Enhanced WaveSurfer ready for ${filename}`);
                    });
                    
                    // Handle enhanced play/pause state
                    wavesurfer.on('play', () => {
                        const playIcon = document.getElementById(`enhanced-play-icon-${stemName}`);
                        if (playIcon) {
                            playIcon.className = 'fas fa-pause me-1';
                        }
                    });
                    
                    wavesurfer.on('pause', () => {
                        const playIcon = document.getElementById(`enhanced-play-icon-${stemName}`);
                        if (playIcon) {
                            playIcon.className = 'fas fa-play me-1';
                        }
                    });
                    
                    enhancedAudioPlayers[stemName] = wavesurfer;
                    
                } catch (error) {
                    console.error(`Error initializing Enhanced WaveSurfer for ${filename}:`, error);
                }
            });
        }
        
        // Toggle Enhanced Play/Pause
        function toggleEnhancedPlayPause(stemName, containerId) {
            const wavesurfer = enhancedAudioPlayers[stemName];
            
            if (!wavesurfer) {
                console.error(`Enhanced WaveSurfer not found for ${stemName}`);
                return;
            }
            
            // Stop other playing enhanced audio
            if (currentlyPlayingEnhanced && currentlyPlayingEnhanced !== wavesurfer) {
                currentlyPlayingEnhanced.pause();
            }
            
            if (wavesurfer.isPlaying()) {
                wavesurfer.pause();
                currentlyPlayingEnhanced = null;
            } else {
                wavesurfer.play();
                currentlyPlayingEnhanced = wavesurfer;
            }
        }

        // Progress polling system
        let statusInterval = null;

        // üöÄ Enhanced Mode Toggle Handlers
        function initializeEnhancedMode() {
            const enhancedModeToggle = document.getElementById('enhanced-mode');
            const qualityModeSection = document.getElementById('enhanced-processing-info');
            const enhancedStemsSection = document.getElementById('stems-info');
            const advancedOptionsSection = document.getElementById('processing-features');
            const classicOptions = document.getElementById('classic-options');
            
            console.log('üîß Initializing Enhanced Mode Toggle...', {
                toggle: !!enhancedModeToggle,
                qualitySection: !!qualityModeSection,
                stemsSection: !!enhancedStemsSection,
                advancedSection: !!advancedOptionsSection,
                classicSection: !!classicOptions
            });
            
            if (enhancedModeToggle) {
                // Remove existing listeners
                enhancedModeToggle.removeEventListener('change', handleEnhancedModeChange);
                
                // Add new listener
                enhancedModeToggle.addEventListener('change', handleEnhancedModeChange);
                
                // Initialize with current state
                handleEnhancedModeChange.call(enhancedModeToggle);
                
                console.log('‚úÖ Enhanced Mode Toggle initialized');
            } else {
                console.warn('‚ö†Ô∏è Enhanced Mode Toggle not found');
            }
        }

        function handleEnhancedModeChange() {
            const isEnhanced = this.checked;
            console.log('üöÄ Enhanced mode toggled:', isEnhanced);
            
            const qualityModeSection = document.getElementById('enhanced-processing-info');
            const enhancedStemsSection = document.getElementById('stems-info');
            const advancedOptionsSection = document.getElementById('processing-features');
            const classicOptions = document.getElementById('classic-options');
            
            // Show/hide sections based on enhanced mode
            if (qualityModeSection) {
                qualityModeSection.style.display = isEnhanced ? 'block' : 'none';
            }
            if (enhancedStemsSection) {
                enhancedStemsSection.style.display = isEnhanced ? 'block' : 'none';
            }
            if (advancedOptionsSection) {
                advancedOptionsSection.style.display = isEnhanced ? 'block' : 'none';
            }
            if (classicOptions) {
                classicOptions.style.display = isEnhanced ? 'none' : 'block';
            }
            
            // Update global variable
            window.isEnhancedMode = isEnhanced;
            
            // Update service card appearance
            updateServiceCardAppearance(isEnhanced);
        }

        // Initialize when DOM is ready and when selectService is called
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Enhanced API health check
            checkEnhancedApiHealth();
            
            // Try to initialize enhanced mode (may not be visible yet)
            setTimeout(initializeEnhancedMode, 100);
        });
        
        // üöÄ Update Service Card Appearance
        function updateServiceCardAppearance(isEnhanced) {
            const separatorCard = document.querySelector('.enhanced-card');
            if (separatorCard) {
                if (isEnhanced) {
                    separatorCard.classList.add('enhanced-active');
                    separatorCard.style.borderColor = 'rgba(102, 126, 234, 0.4)';
                    separatorCard.style.transform = 'translateY(-5px)';
                    console.log('‚úÖ Enhanced card appearance activated');
                } else {
                    separatorCard.classList.remove('enhanced-active');
                    separatorCard.style.borderColor = '';
                    separatorCard.style.transform = '';
                    console.log('üìº Classic card appearance activated');
                }
            } else {
                console.warn('‚ö†Ô∏è Enhanced card not found for appearance update');
            }
        }
        
        // üöÄ Enhanced API Health Check
        async function checkEnhancedApiHealth() {
            try {
                console.log('üîç Checking Enhanced API health...');
                
                // Skip health check if Enhanced API is not deployed yet
                const isEnhancedDeployed = true; // ‚úÖ Enhanced backend with asteroid is deployed!
                
                if (!isEnhancedDeployed) {
                    console.warn('‚ö†Ô∏è Enhanced API not deployed yet - using fallback mode');
                    
                    // Disable enhanced mode temporarily  
                    const enhancedToggle = document.getElementById('enhanced-mode');
                    if (enhancedToggle) {
                        enhancedToggle.checked = false;
                        enhancedToggle.disabled = true;
                        enhancedToggle.dispatchEvent(new Event('change'));
                        
                        // Add tooltip explaining why it's disabled
                        enhancedToggle.parentElement.title = 'Enhanced Mode wird gerade deployed...';
                    }
                    
                    // Show deployment status
                    const connectionStatus = document.getElementById('connection-status');
                    if (connectionStatus) {
                        connectionStatus.innerHTML = `
                            <i class="fas fa-sync fa-spin text-primary"></i> 
                            üöÄ Enhanced API wird deployed - bitte warten...
                        `;
                    }
                    return;
                }
                
                // Try to connect to Enhanced API
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(ENHANCED_HEALTH_URL, { 
                    signal: controller.signal,
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const health = await response.json();
                    console.log('‚úÖ Enhanced API is healthy:', health);
                    
                    // Enable enhanced mode
                    const enhancedToggle = document.getElementById('enhanced-mode');
                    if (enhancedToggle) {
                        enhancedToggle.disabled = false;
                        enhancedToggle.parentElement.title = '';
                    }
                    
                    // Update connection status for enhanced mode
                    const connectionStatus = document.getElementById('connection-status');
                    if (connectionStatus) {
                        connectionStatus.innerHTML = `
                            <i class="fas fa-check-circle text-success"></i> 
                            üöÄ Enhanced API Connected (${health.max_quality || '9.65dB SDR + Enhancement'} quality)
                        `;
                    }
                } else {
                    throw new Error(`Enhanced API responded with status ${response.status}`);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Enhanced API health check failed:', error.message || error);
                
                // Disable enhanced mode if API is not available
                const enhancedToggle = document.getElementById('enhanced-mode');
                if (enhancedToggle) {
                    enhancedToggle.checked = false;
                    enhancedToggle.disabled = true;
                    enhancedToggle.dispatchEvent(new Event('change'));
                    enhancedToggle.parentElement.title = 'Enhanced API nicht verf√ºgbar';
                }
                
                // Show fallback message
                const connectionStatus = document.getElementById('connection-status');
                if (connectionStatus) {
                    connectionStatus.innerHTML = `
                        <i class="fas fa-exclamation-triangle text-warning"></i> 
                        Enhanced Mode nicht verf√ºgbar - Classic Mode aktiv
                    `;
                }
            }
        }
        
        // üöÄ Get Stem Icon for Enhanced Display
        function getStemIcon(stemName) {
            const iconMap = {
                'vocals': 'fas fa-microphone',
                'drums': 'fas fa-drum',
                'bass': 'fas fa-guitar',
                'other': 'fas fa-music',
                'instrumental': 'fas fa-compact-disc',
                'piano': 'fas fa-piano',
                'guitar': 'fas fa-guitar',
                'strings': 'fas fa-violin',
                'brass': 'fas fa-trumpet',
                'woodwinds': 'fas fa-saxophone',
                'synth': 'fas fa-keyboard',
                'effects': 'fas fa-magic'
            };
            
            return iconMap[stemName.toLowerCase()] || 'fas fa-music';
        }
        
        function startProgressPolling(jobId) {
            if (statusInterval) {
                IntervalManager.clear(statusInterval);
            }
            
            statusInterval = IntervalManager.create(async () => {
                try {
                    const response = await fetch(`${API_BASE}/status/${jobId}`);
                    if (response.ok) {
                        const status = await response.json();
                        
                        // Update progress bar
                        updateProgress(status.progress || 0, status.phase || 'Verarbeitung l√§uft...');
                        
                        // Check if processing is complete
                        if (status.status === 'completed') {
                            IntervalManager.clear(statusInterval);
                            statusInterval = null;
                            
                            // Show completion message
                            updateProgress(100, `Verarbeitung abgeschlossen in ${status.processing_time}s`);
                            
                            // Display download options
                            setTimeout(() => {
                                hideProgress();
                                displayAsyncResults(status, jobId);
                            }, 1000);
                            
                        } else if (status.status === 'error') {
                            IntervalManager.clear(statusInterval);
                            statusInterval = null;
                            hideProgress();
                            alert(`Verarbeitung fehlgeschlagen: ${status.error}`);
                        }
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                    // Continue polling unless it's a critical error
                }
            }, 2000); // Poll every 2 seconds
        }
        
        // Custom stem selection setup moved to initializeApplication()
        
        function getSelectedStems() {
            const selected = document.querySelector('input[name="stemSelection"]:checked');
            if (!selected) return 'all';
            
            if (selected.value === 'custom') {
                const customBoxes = document.querySelectorAll('#custom-checkboxes input[type="checkbox"]:checked');
                const customStems = Array.from(customBoxes).map(cb => cb.value);
                return customStems.length > 0 ? customStems.join(',') : 'all';
            }
            
            return selected.value;
        }
        
        async function handleFileUpload(file) {
            // ‚úÖ PAYWALL CHECK FIRST
            const canUse = await checkUsageLimit();
            if (!canUse) {
                console.log('üö´ Paywall blocked file upload - user limit reached');
                return; // Stop if paywall blocks usage
            }

            // Validate file
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/mp4', 'audio/aac'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|flac|m4a|aac)$/i)) {
                alert('Unsupported file format. Please use MP3, WAV, FLAC, M4A, or AAC.');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                alert('File too large. Maximum size is 100MB.');
                return;
            }

            // Show progress
            showProgress();
            updateProgress(5, 'Verbinde mit Server...');

            // Upload file with selected stems
            const formData = new FormData();
            formData.append('audio_file', file);
            formData.append('selected_stems', getSelectedStems());
            formData.append('use_tta', document.getElementById('use-tta').checked);
            formData.append('extract_instrumental', document.getElementById('extract-instrumental').checked);

            try {
                updateProgress(10, 'Lade Datei hoch...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minutes for upload
                
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                if (response.ok && result.job_id) {
                    // Upload successful, start polling for progress
                    updateProgress(15, 'Upload erfolgreich, Verarbeitung startet...');
                    console.log(`üîÑ Starting progress polling for job ${result.job_id}`);
                    startProgressPolling(result.job_id);
                    
                } else {
                    throw new Error(result.detail || result.message || 'Upload failed');
                }
                
            } catch (error) {
                hideProgress();
                
                if (error.name === 'AbortError') {
                    alert('Upload-Zeit√ºberschreitung. Bitte versuchen Sie es sp√§ter erneut.');
                } else if (error.message.includes('NetworkError') || !navigator.onLine) {
                    alert('Netzwerkverbindung instabil. Bitte pr√ºfen Sie Ihre Internetverbindung und versuchen Sie es erneut.');
                } else {
                    alert(`Upload fehlgeschlagen: ${error.message}`);
                }
            }
        }

        function showProgress() {
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('download-section').style.display = 'none';
        }

        function hideProgress() {
            document.getElementById('progress-container').style.display = 'none';
        }

        function showDownloads() {
            document.getElementById('download-section').style.display = 'block';
        }

        function updateProgress(progress, text, timeText = '') {
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = text;
            document.getElementById('progress-time').textContent = timeText;
        }

let processedFiles = {}; // Store processed files for download
let lastDownloadBaseUrl = null;
let lastModelUsed = null;

        // Audio preview management
        let audioPlayers = {};
        let currentlyPlaying = null;
        let currentAudio = null; // For enhanced preview playback
        
        function displayAsyncResults(status, jobId) {
            showDownloads();
            
            // Store download information
            lastDownloadBaseUrl = status.download_base_url || null;
            lastModelUsed = 'htdemucs_ft'; // From backend
            currentJobId = jobId;
            
            const container = document.getElementById('stem-files');
            container.innerHTML = '';
            
            // Create download info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'alert alert-success';
            infoDiv.innerHTML = `
                <h5>üéâ Separation erfolgreich!</h5>
                <p><strong>Verarbeitungszeit:</strong> ${status.processing_time}s</p>
                <p><strong>Model:</strong> ${status.model_info?.name || 'MVSEP Ensemble'}</p>
                <p><strong>Qualit√§t:</strong> ${status.model_info?.quality || 'State-of-the-Art Multi-Instrument'}</p>
                <p><strong>Dateigr√∂√üe:</strong> ${status.total_size_mb} MB</p>
            `;
            container.appendChild(infoDiv);
            
            // Show available files with audio preview
            if (status.files && status.files.length > 0) {
                status.files.forEach(filename => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'stem-file-preview';
                    fileDiv.style.cssText = `
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 15px;
                        background-color: var(--light-gray);
                        transition: all 0.3s ease;
                    `;
                    
                    const stemIcon = getStemIcon(filename);
                    const uniqueId = `waveform-${filename.replace('.', '-')}`;
                    
                    fileDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center;">
                                <i class="${stemIcon}" style="font-size: 1.5rem; margin-right: 10px; color: var(--primary-color);"></i>
                                <strong>${getStemDisplayName(filename)}</strong>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="togglePlayPause('${filename}', '${uniqueId}')">
                                    <i class="fas fa-play" id="play-icon-${filename.replace('.', '-')}"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="downloadFile('${filename}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                        <div id="${uniqueId}" style="background-color: white; border-radius: 8px; padding: 10px; min-height: 80px;"></div>
                        <div style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9rem;">
                            <span id="time-${filename.replace('.', '-')}">00:00 / 00:00</span>
                        </div>
                    `;
                    
                    container.appendChild(fileDiv);
                    
                    // Initialize WaveSurfer for this file
                    setTimeout(() => initializeWaveSurfer(filename, uniqueId), 100);
                });
            }
        }
        
        function getStemIcon(filename) {
            const name = filename.toLowerCase();
            if (name.includes('vocal')) return 'fas fa-microphone';
            if (name.includes('drum')) return 'fas fa-drum';
            if (name.includes('bass')) return 'fas fa-guitar';
            if (name.includes('guitar')) return 'fas fa-guitar';
            if (name.includes('piano')) return 'fas fa-piano';
            if (name.includes('other')) return 'fas fa-music';
            if (name.includes('instrumental')) return 'fas fa-compact-disc';
            return 'fas fa-file-audio';
        }
        
        function getStemDisplayName(filename) {
            const name = filename.toLowerCase();
            if (name.includes('vocal')) return 'Gesang und Instrumente';
            if (name.includes('drum')) return 'Drums';
            if (name.includes('bass')) return 'Bass';
            if (name.includes('other')) return 'Andere Instrumente';
            if (name.includes('instrumental')) return 'Instrumental';
            return filename;
        }
        
        function initializeWaveSurfer(filename, containerId) {
            // KORREKTUR: Lade die kleine, schnelle MP3-Vorschau, nicht die gro√üe WAV-Datei.
            const previewFilename = `preview_${filename.replace('.wav', '.mp3')}`;
            const audioUrl = `${MODAL_API_BASE}${lastDownloadBaseUrl.replace('/download/', '/preview/')}/${previewFilename}`;
            
            console.log(`üéµ Initializing WaveSurfer for ${filename}`);
            console.log(`üîó Preview URL: ${audioUrl}`);
            
            try {
                const wavesurfer = WaveSurfer.create({
                    container: `#${containerId}`,
                    waveColor: '#4A90E2',
                    progressColor: '#50E3C2',
                    height: 60,
                    barWidth: 3,
                    barGap: 1,
                    responsive: true,
                    normalize: true,
                    backend: 'WebAudio'
                });
                
                wavesurfer.load(audioUrl);
                
                // Error handling for preview loading
                wavesurfer.on('error', (error) => {
                    console.error(`‚ùå WaveSurfer error for ${filename}:`, error);
                    // Try fallback to original WAV file if MP3 preview fails
                    const fallbackUrl = `${MODAL_API_BASE}${lastDownloadBaseUrl}/${filename}`;
                    console.log(`üîÑ Trying fallback URL: ${fallbackUrl}`);
                    wavesurfer.load(fallbackUrl);
                });
                
                wavesurfer.on('ready', () => {
                    console.log(`‚úÖ WaveSurfer ready for ${filename}`);
                });
                
                // Update time display
                wavesurfer.on('audioprocess', () => {
                    const current = wavesurfer.getCurrentTime();
                    const duration = wavesurfer.getDuration();
                    const timeDisplay = document.getElementById(`time-${filename.replace('.', '-')}`);
                    if (timeDisplay) {
                        timeDisplay.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
                    }
                });
                
                // Handle play/pause state
                wavesurfer.on('play', () => {
                    const playIcon = document.getElementById(`play-icon-${filename.replace('.', '-')}`);
                    if (playIcon) {
                        playIcon.className = 'fas fa-pause';
                    }
                });
                
                wavesurfer.on('pause', () => {
                    const playIcon = document.getElementById(`play-icon-${filename.replace('.', '-')}`);
                    if (playIcon) {
                        playIcon.className = 'fas fa-play';
                    }
                });
                
                audioPlayers[filename] = wavesurfer;
                
            } catch (error) {
                console.error(`Error initializing WaveSurfer for ${filename}:`, error);
                // Fallback: show simple message
                document.getElementById(containerId).innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Vorschau nicht verf√ºgbar - Download verf√ºgbar
                    </div>
                `;
            }
        }
        
        function togglePlayPause(filename, containerId) {
            const wavesurfer = audioPlayers[filename];
            
            if (!wavesurfer) {
                console.error(`WaveSurfer not found for ${filename}`);
                return;
            }
            
            // Stop other playing audio
            if (currentlyPlaying && currentlyPlaying !== wavesurfer) {
                currentlyPlaying.pause();
            }
            
            if (wavesurfer.isPlaying()) {
                wavesurfer.pause();
                currentlyPlaying = null;
            } else {
                wavesurfer.play();
                currentlyPlaying = wavesurfer;
            }
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Entferne ungenutzte Legacy-Funktion
        
        // Download functions
        function downloadFile(filename) {
    // The base64 logic is now removed, we always download from the URL
    if (lastDownloadBaseUrl) {
        // Download-Link f√ºr gro√üe Dateien (absolute URL!)
        // The model name is now part of the base URL from the backend
        const url = MODAL_API_BASE + lastDownloadBaseUrl + '/' + filename;
        window.open(url, '_blank');
    } else {
        alert('Datei nicht gefunden! Kein Download-Link verf√ºgbar.');
    }
        }

        function downloadAllStems() {
    // The base64 logic for zipping is removed
    if (lastDownloadBaseUrl) {
        // ZIP direkt vom Server herunterladen (absolute URL!)
        // The model name is now part of the base URL from the backend
        const url = MODAL_API_BASE + lastDownloadBaseUrl + '/all.zip';
        window.open(url, '_blank');
    } else {
        alert('Keine Dateien zum Download verf√ºgbar!');
    }
        }

        // Smooth scrolling (only for valid anchors)
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                const href = this.getAttribute('href');
                
                // Skip if href is just "#" or has onclick handler
                if (href === '#' || this.hasAttribute('onclick')) {
                    return; // Let the onclick handler deal with it
                }
                
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // Automatic mastering connection test
        async function testMasteringConnection() {
            try {
                const response = await fetch(MATCHERING_HEALTH_URL, { method: 'GET' });
                if (response.ok) {
                    document.getElementById('mastering-connection-status').innerHTML = '<i class="fas fa-check-circle text-success"></i> Automatic Mastering Service OK';
                } else {
                    document.getElementById('mastering-connection-status').innerHTML = '<i class="fas fa-exclamation-circle text-warning"></i> Automatic Mastering Service Probleme';
                }
            } catch (error) {
                console.error('Automatic mastering connection test failed:', error);
                document.getElementById('mastering-connection-status').innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> Automatic Mastering Service nicht erreichbar';
            }
        }

        // Automatic mastering file upload handling
        function setupMasteringUploads() {
            console.log('üéõÔ∏è Setting up mastering uploads...');
            
            const targetUploadZone = document.getElementById('target-upload-zone');
            const targetFileInput = document.getElementById('target-file-input');
            
            if (!targetUploadZone || !targetFileInput) {
                console.error('‚ùå Mastering upload elements not found:', { targetUploadZone, targetFileInput });
                return;
            }
            
            console.log('‚úÖ Found mastering upload elements:', { targetUploadZone: !!targetUploadZone, targetFileInput: !!targetFileInput });
            
            // Remove existing listeners to prevent duplicates
            targetUploadZone.replaceWith(targetUploadZone.cloneNode(true));
            targetFileInput.replaceWith(targetFileInput.cloneNode(true));
            
            // Re-get the elements after cloning
            const newTargetUploadZone = document.getElementById('target-upload-zone');
            const newTargetFileInput = document.getElementById('target-file-input');
            
            newTargetUploadZone.addEventListener('click', () => {
                console.log('üñ±Ô∏è Upload zone clicked!');
                newTargetFileInput.click();
            });
            newTargetUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                newTargetUploadZone.classList.add('dragover');
                console.log('üìÇ Dragover detected!');
            });
            newTargetUploadZone.addEventListener('dragleave', () => {
                newTargetUploadZone.classList.remove('dragover');
            });
            newTargetUploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                newTargetUploadZone.classList.remove('dragover');
                console.log('üéµ File dropped!');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleTargetFileUpload(files[0]);
                }
            });
            newTargetFileInput.addEventListener('change', (e) => {
                console.log('üìÅ File input changed!');
                if (e.target.files.length > 0) {
                    handleTargetFileUpload(e.target.files[0]);
                }
            });
            
            console.log('‚úÖ Mastering upload listeners attached successfully!');
        }

        function handleTargetFileUpload(file) {
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/mp4', 'audio/aac'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|flac|m4a|aac)$/i)) {
                alert('Unsupported audio file format. Please use MP3, WAV, FLAC, M4A, or AAC.');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                alert('File too large. Maximum size is 50MB.');
                return;
            }

            targetFile = file;
            const targetZone = document.getElementById('target-upload-zone');
            safeHTML(targetZone, `
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h4>Audio bereit: <span class="filename"></span></h4>
                <p class="text-muted">${(file.size / (1024*1024)).toFixed(1)} MB</p>
            `);
            targetZone.querySelector('.filename').textContent = file.name;
            
            checkMasteringReady();
        }

        function checkMasteringReady() {
            const startBtn = document.getElementById('start-mastering-btn');
            if (targetFile) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-sliders-h"></i> Start Automatic Mastering';
            } else {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-sliders-h"></i> Upload Audio File';
            }
        }

        async function startMastering() {
            // ‚úÖ PAYWALL CHECK FIRST
            const canUse = await checkUsageLimit();
            if (!canUse) {
                console.log('üö´ Paywall blocked mastering - user limit reached');
                return; // Stop if paywall blocks usage
            }

            if (!targetFile) {
                alert('Please upload an audio file.');
                return;
            }

            // Store original file URL for A/B comparison
            window.currentOriginalFileUrl = URL.createObjectURL(targetFile);
            console.log('üéµ Original file URL stored for A/B comparison:', window.currentOriginalFileUrl);

            // Get selected formats
            const formats = [];
            if (document.getElementById('format-16bit').checked) formats.push('16bit');
            if (document.getElementById('format-24bit').checked) formats.push('24bit');

            if (formats.length === 0) {
                alert('Please select at least one output format.');
                return;
            }

            // Get selected mastering intensity
            const intensityRadio = document.querySelector('input[name="masteringIntensity"]:checked');
            const intensity = intensityRadio ? intensityRadio.value : 'medium';

            // Get professional features settings
            const bassMonoMaking = document.getElementById('bass-mono-making').checked;
            const intelligentEQ = document.getElementById('intelligent-eq').checked;
            const lufsTargeting = document.getElementById('lufs-targeting').checked;

            // Show progress
            showMasteringProgress();
            updateMasteringProgress(5, 'Verbinde mit Professional Mastering Service...');

            // Upload file
            const formData = new FormData();
            formData.append('target_audio', targetFile);
            formData.append('mastering_intensity', intensity);
            formData.append('output_formats', formats.join(','));
            
            // Add professional features (for future backend expansion)
            formData.append('bass_mono_making', bassMonoMaking);
            formData.append('intelligent_eq', intelligentEQ);
            formData.append('lufs_targeting', lufsTargeting);

            try {
                updateMasteringProgress(10, 'Lade Datei hoch...');
                
                const response = await fetch(`${MATCHERING_API_BASE}/master`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.job_id) {
                    updateMasteringProgress(15, 'Upload erfolgreich, Automatic Mastering startet...');
                    console.log(`üéöÔ∏è Starting automatic mastering progress polling for job ${result.job_id}`);
                    startMasteringProgressPolling(result.job_id);
                } else {
                    throw new Error(result.error || result.message || 'Automatic mastering failed');
                }
                
            } catch (error) {
                hideMasteringProgress();
                if (error.message.includes('NetworkError') || !navigator.onLine) {
                    alert('Netzwerkverbindung instabil. Bitte pr√ºfen Sie Ihre Internetverbindung und versuchen Sie es erneut.');
                } else {
                    alert(`Automatic Mastering fehlgeschlagen: ${error.message}`);
                }
            }
        }

        function startMasteringProgressPolling(jobId) {
            currentMasteringJobId = jobId;
            
            if (masteringStatusInterval) {
                IntervalManager.clear(masteringStatusInterval);
            }
            
            masteringStatusInterval = IntervalManager.create(async () => {
                try {
                    const response = await fetch(`${MATCHERING_API_BASE}/status/mastering/${jobId}`);
                    if (response.ok) {
                        const status = await response.json();
                        
                        updateMasteringProgress(status.progress || 0, status.phase || 'Mastering l√§uft...');
                        
                        if (status.status === 'completed') {
                            IntervalManager.clear(masteringStatusInterval);
                            masteringStatusInterval = null;
                            
                            updateMasteringProgress(100, `Mastering abgeschlossen in ${status.processing_time}s`);
                            
                            setTimeout(() => {
                                hideMasteringProgress();
                                displayMasteringResults(status, jobId);
                            }, 1000);
                            
                        } else if (status.status === 'error') {
                            IntervalManager.clear(masteringStatusInterval);
                            masteringStatusInterval = null;
                            hideMasteringProgress();
                            alert(`Mastering fehlgeschlagen: ${status.error}`);
                        }
                    }
                } catch (error) {
                    console.error('Mastering status polling error:', error);
                }
            }, 2000);
        }

        function showMasteringProgress() {
            document.getElementById('mastering-progress-container').style.display = 'block';
            document.getElementById('mastering-download-section').style.display = 'none';
        }

        function hideMasteringProgress() {
            document.getElementById('mastering-progress-container').style.display = 'none';
        }

        function updateMasteringProgress(progress, text, timeText = '') {
            document.getElementById('mastering-progress-bar').style.width = `${progress}%`;
            document.getElementById('mastering-progress-text').textContent = text;
            document.getElementById('mastering-progress-time').textContent = timeText;
        }

        // A/B Comparison Variables
        let comparisonWaveSurfer = null;
        let originalAudioUrl = null;
        let masteredAudioUrl = null;
        let currentAudioType = 'original';

        function displayMasteringResults(status, jobId) {
            // Track usage after successful mastering
            trackUsage('mastering', targetFile?.name);
            
            document.getElementById('mastering-download-section').style.display = 'block';
            
            const container = document.getElementById('mastered-files');
            container.innerHTML = '';
            
            // Create download info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'alert alert-success';
            
            // Get selected intensity for LUFS display
            const selectedIntensity = document.querySelector('input[name="masteringIntensity"]:checked');
            const intensityValue = selectedIntensity ? selectedIntensity.value : 'medium';
            
            // LUFS mapping
            const lufsMap = {
                'low': '-16.0 LUFS (Audiophil)',
                'medium': '-14.0 LUFS (Streaming Standard)', 
                'high': '-9.0 LUFS (Club/Radio)'
            };
            
            // Professional features status
            const bassMonoStatus = document.getElementById('bass-mono-making').checked ? '‚úÖ Aktiv' : '‚ùå Deaktiviert';
            const intelligentEQStatus = document.getElementById('intelligent-eq').checked ? '‚úÖ Aktiv' : '‚ùå Deaktiviert';
            const lufsTargetingStatus = document.getElementById('lufs-targeting').checked ? '‚úÖ Aktiv' : '‚ùå Deaktiviert';
            
            infoDiv.innerHTML = `
                <h5>üéâ Professional Mastering erfolgreich!</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>‚è±Ô∏è Verarbeitungszeit:</strong> ${status.processing_time}s</p>
                        <p><strong>üéöÔ∏è Service:</strong> Professional AI Mastering 2025</p>
                        <p><strong>üìä Output Formats:</strong> ${status.files.join(', ')}</p>
                        <p><strong>üìÅ Dateigr√∂√üe:</strong> ${status.total_size_mb} MB</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>üéØ LUFS-Ziel:</strong> ${lufsMap[intensityValue]}</p>
                        <p><strong>üîä Bass Mono-Making:</strong> ${bassMonoStatus}</p>
                        <p><strong>üß† Intelligente EQ:</strong> ${intelligentEQStatus}</p>
                        <p><strong>üéõÔ∏è LUFS-Targeting:</strong> ${lufsTargetingStatus}</p>
                    </div>
                </div>
                <div class="mt-3 p-3" style="background-color: #fafbfc;">
                    <small class="text-muted">
                        <strong>üî¨ Professionelle Features angewendet:</strong>
                        FFT-Frequenzanalyse ‚Ä¢ Intelligente Multi-Band EQ ‚Ä¢ Adaptive Kompression ‚Ä¢ 
                        ${document.getElementById('bass-mono-making').checked ? 'Bass Mono-Making ‚Ä¢ ' : ''}
                        Industry-Standard LUFS-Targeting ‚Ä¢ Phase-koh√§rente Verarbeitung
                    </small>
                </div>
            `;
            container.appendChild(infoDiv);
            
            // Initialize A/B Comparison if we have mastered files
            console.log('üîç Checking for A/B comparison setup...');
            console.log('üìÅ Status files:', status.files);
            console.log('üéµ Original URL:', window.currentOriginalFileUrl);
            
            if (status.files && status.files.length > 0) {
                // Find the mastered file (usually the first one)
                const masteredFilename = status.files.find(f => f.includes('mastered') || f.includes('.wav') || f.includes('.mp3'));
                console.log('üéõÔ∏è Found mastered file:', masteredFilename);
                
                if (masteredFilename) {
                    const originalUrl = window.currentOriginalFileUrl; // Set this when uploading
                    const masteredUrl = `${MATCHERING_API_BASE}/download/mastering/${jobId}/${masteredFilename}`;
                    
                    console.log('üîó URLs for A/B comparison:');
                    console.log('   Original:', originalUrl);
                    console.log('   Mastered:', masteredUrl);
                    
                    if (originalUrl) {
                        console.log('‚úÖ Initializing A/B comparison...');
                        initializeABComparison(originalUrl, masteredUrl);
                    } else {
                        console.error('‚ùå No original URL found - A/B comparison skipped');
                    }
                } else {
                    console.error('‚ùå No mastered file found in status.files');
                }
            } else {
                console.error('‚ùå No files in status or status.files is empty');
            }
            
            // Show available files
            if (status.files) {
                status.files.forEach(filename => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'stem-file';
                    fileDiv.innerHTML = `
                        <div>
                            <i class="fas fa-file-audio"></i>
                            <strong>${filename}</strong>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="downloadMasteredFile('${filename}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    `;
                    container.appendChild(fileDiv);
                });
            }
        }

        function downloadMasteredFile(filename) {
            if (currentMasteringJobId) {
                const url = `${MATCHERING_API_BASE}/download/mastering/${currentMasteringJobId}/${filename}`;
                window.open(url, '_blank');
            } else {
                alert('Datei nicht gefunden!');
            }
        }

        function downloadAllMastered() {
            if (currentMasteringJobId) {
                const url = `${MATCHERING_API_BASE}/download/mastering/${currentMasteringJobId}/all.zip`;
                window.open(url, '_blank');
            } else {
                alert('Keine Dateien zum Download verf√ºgbar!');
            }
        }

        // Professional A/B Comparison Functions
        let originalWaveSurfer = null;
        let masteredWaveSurfer = null;
        let isLooping = false;
        let isSoloMode = false;
        let masterVolume = 0.8;

        function initializeABComparison(originalUrl, masteredUrl) {
            console.log('üéµ initializeABComparison called with:');
            console.log('   Original URL:', originalUrl);
            console.log('   Mastered URL:', masteredUrl);
            
            originalAudioUrl = originalUrl;
            masteredAudioUrl = masteredUrl;
            
            // Show the comparison player
            const abPlayer = document.getElementById('ab-comparison-player');
            console.log('üéõÔ∏è A/B Player element:', abPlayer);
            
            if (abPlayer) {
                abPlayer.style.display = 'block';
                console.log('‚úÖ A/B Player shown successfully!');
            } else {
                console.error('‚ùå A/B Player element not found!');
            }
            
            // Initialize dual waveforms
            initializeDualWaveforms();
            
            // Setup event listeners
            setupABPlayerEvents();
        }

        function initializeDualWaveforms() {
            // Destroy existing waveforms
            if (originalWaveSurfer) originalWaveSurfer.destroy();
            if (masteredWaveSurfer) masteredWaveSurfer.destroy();
            if (comparisonWaveSurfer) comparisonWaveSurfer.destroy();
            
            // Create original waveform
            originalWaveSurfer = WaveSurfer.create({
                container: '#original-waveform',
                waveColor: 'rgba(239, 68, 68, 0.6)',
                progressColor: '#ef4444',
                cursorColor: '#ffffff',
                height: 88,
                responsive: true,
                normalize: true,
                barWidth: 2,
                barRadius: 1
            });
            
            // Create mastered waveform
            masteredWaveSurfer = WaveSurfer.create({
                container: '#mastered-waveform',
                waveColor: 'rgba(34, 197, 94, 0.6)',
                progressColor: '#22c55e',
                cursorColor: '#ffffff',
                height: 88,
                responsive: true,
                normalize: true,
                barWidth: 2,
                barRadius: 1
            });
            
            // Load audio files with error handling
            if (originalAudioUrl) {
                originalWaveSurfer.load(originalAudioUrl);
                originalWaveSurfer.on('error', (error) => {
                    console.error('‚ùå Original audio load error:', error);
                });
            }
            if (masteredAudioUrl) {
                masteredWaveSurfer.load(masteredAudioUrl);
                masteredWaveSurfer.on('error', (error) => {
                    console.error('‚ùå Mastered audio load error:', error);
                    console.log('üîó Failed URL:', masteredAudioUrl);
                });
            }
            
            // Set initial active player
            comparisonWaveSurfer = originalWaveSurfer;
            currentAudioType = 'original';
            updateActiveWaveform();
        }

        function setupABPlayerEvents() {
            // Update time display during playback
            if (originalWaveSurfer) {
                originalWaveSurfer.on('audioprocess', updateTimeDisplay);
                originalWaveSurfer.on('finish', onPlaybackFinish);
            }
            if (masteredWaveSurfer) {
                masteredWaveSurfer.on('audioprocess', updateTimeDisplay);
                masteredWaveSurfer.on('finish', onPlaybackFinish);
            }
            
            // Volume control
            const volumeSlider = document.getElementById('master-volume');
            if (volumeSlider) {
                volumeSlider.addEventListener('input', function() {
                    masterVolume = this.value / 100;
                    if (originalWaveSurfer) originalWaveSurfer.setVolume(masterVolume);
                    if (masteredWaveSurfer) masteredWaveSurfer.setVolume(masterVolume);
                });
            }
        }

        function switchAudio(type) {
            if (!originalWaveSurfer || !masteredWaveSurfer) return;
            
            const wasPlaying = comparisonWaveSurfer ? comparisonWaveSurfer.isPlaying() : false;
            const currentTime = comparisonWaveSurfer ? comparisonWaveSurfer.getCurrentTime() : 0;
            
            // Pause current audio
            if (originalWaveSurfer.isPlaying()) originalWaveSurfer.pause();
            if (masteredWaveSurfer.isPlaying()) masteredWaveSurfer.pause();
            
            if (type === 'original' && currentAudioType !== 'original') {
                comparisonWaveSurfer = originalWaveSurfer;
                currentAudioType = 'original';
                document.getElementById('btn-original').classList.add('active');
                document.getElementById('btn-mastered').classList.remove('active');
            } else if (type === 'mastered' && currentAudioType !== 'mastered') {
                comparisonWaveSurfer = masteredWaveSurfer;
                currentAudioType = 'mastered';
                document.getElementById('btn-mastered').classList.add('active');
                document.getElementById('btn-original').classList.remove('active');
            }
            
            updateActiveWaveform();
            
            // Sync playback position
            if (comparisonWaveSurfer.isReady) {
                const duration = comparisonWaveSurfer.getDuration();
                if (duration > 0) {
                    comparisonWaveSurfer.seekTo(currentTime / duration);
                }
                
                // Resume playback if it was playing
                if (wasPlaying) {
                    comparisonWaveSurfer.play();
                }
            }
        }

        function togglePlayPause() {
            if (!comparisonWaveSurfer) return;
            
            const playBtn = document.getElementById('transport-play');
            
            if (comparisonWaveSurfer.isPlaying()) {
                comparisonWaveSurfer.pause();
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
            } else {
                comparisonWaveSurfer.play();
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            }
        }

        function stopPlayback() {
            if (!comparisonWaveSurfer) return;
            
            comparisonWaveSurfer.stop();
            document.getElementById('transport-play').innerHTML = '<i class="fas fa-play"></i>';
        }

        function toggleLoop() {
            isLooping = !isLooping;
            const loopBtn = document.getElementById('loop-toggle');
            
            if (isLooping) {
                loopBtn.classList.add('active');
            } else {
                loopBtn.classList.remove('active');
            }
            
            // Loop functionality handled in onPlaybackFinish
            console.log('üîÅ Loop mode:', isLooping ? 'enabled' : 'disabled');
        }

        function toggleSolo() {
            isSoloMode = !isSoloMode;
            const soloBtn = document.getElementById('solo-toggle');
            
            if (isSoloMode) {
                soloBtn.classList.add('active');
                // In solo mode, only the active track plays
            } else {
                soloBtn.classList.remove('active');
            }
        }

        function updateActiveWaveform() {
            // Visual feedback for active waveform
            const originalSection = document.querySelector('.original-section');
            const masteredSection = document.querySelector('.mastered-section');
            
            if (currentAudioType === 'original') {
                originalSection.style.opacity = '1';
                masteredSection.style.opacity = '0.7';
            } else {
                originalSection.style.opacity = '0.7';
                masteredSection.style.opacity = '1';
            }
        }

        function updateTimeDisplay() {
            if (!comparisonWaveSurfer) return;
            
            const currentTime = comparisonWaveSurfer.getCurrentTime();
            const totalTime = comparisonWaveSurfer.getDuration();
            
            document.getElementById('current-time').textContent = formatTime(currentTime);
            document.getElementById('total-time').textContent = formatTime(totalTime);
            
            // Update level meters (simplified)
            updateLevelMeters();
        }

        function updateLevelMeters() {
            // Simulate level meters with random values for demo
            const originalLevel = Math.random() * 80 + 20;
            const masteredLevel = Math.random() * 90 + 10;
            
            document.getElementById('original-level').style.width = originalLevel + '%';
            document.getElementById('mastered-level').style.width = masteredLevel + '%';
        }

        function onPlaybackFinish() {
            document.getElementById('transport-play').innerHTML = '<i class="fas fa-play"></i>';
            
            if (isLooping && comparisonWaveSurfer) {
                comparisonWaveSurfer.play();
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '00:00';
            
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update WaveSurfer play button when audio finishes
        // WaveSurfer initialization moved to initializeApplication()

        // ==========================================
        // SUPABASE AUTHENTICATION SYSTEM
        // ==========================================
        
        // Initialize Supabase
        const SUPABASE_URL = 'https://ocglduwwtgdedskvttme.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9jZ2xkdXd3dGdkZWRza3Z0dG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwNzk4MjIsImV4cCI6MjA2ODY1NTgyMn0.EkVRCNAUzQe3ShfrirwBHzzsW7ChBs0hPFioU0N2zQg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let userProfile = null;

        // Show Authentication Modal
        function showAuthModal(mode) {
            document.getElementById('authModalTitle').textContent = mode === 'login' ? 'Login' : 'Registrieren';
            
            // Hide all forms
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('passwordResetForm').style.display = 'none';
            
            // Show selected form
            if (mode === 'login') {
                document.getElementById('loginForm').style.display = 'block';
            } else {
                document.getElementById('registerForm').style.display = 'block';
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('authModal'));
            modal.show();
        }

        // Switch between auth modes
        function switchAuthMode(mode) {
            showAuthModal(mode);
        }

        // Show password reset
        function showPasswordReset() {
            document.getElementById('authModalTitle').textContent = 'Passwort zur√ºcksetzen';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('passwordResetForm').style.display = 'block';
        }

        // Handle Login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            // Show loading
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Wird eingeloggt...';
            loginBtn.disabled = true;
            
            try {
                console.log('üîê Starting login process...');
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                
                if (error) throw error;
                
                console.log('‚úÖ Login successful, loading profile...');
                
                // Load user profile and ensure it exists
                await loadUserProfile();
                
                console.log('‚úÖ Profile loaded, updating UI...');
                
                // Update UI
                updateAuthUI();
                
                // Hide modal
                bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                
                showSuccessModal('Erfolgreich eingeloggt!', 'Sie sind jetzt angemeldet und k√∂nnen alle Services nutzen.');
                
                // ‚úÖ Check if user had intended to upgrade before login
                const intendedPlan = localStorage.getItem('klein_intended_plan');
                if (intendedPlan) {
                    console.log('üéØ Continuing with intended subscription plan:', intendedPlan);
                    localStorage.removeItem('klein_intended_plan');
                    
                    // Small delay to let success modal show first
                    setTimeout(() => {
                        proceedToStripeCheckout(intendedPlan);
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‚ùå Login error:', error);
                showToast('Login fehlgeschlagen: ' + error.message, 'error');
            } finally {
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Einloggen';
                loginBtn.disabled = false;
            }
        }

        // Handle Registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const company = document.getElementById('registerCompany').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const registerBtn = document.getElementById('registerBtn');
            
            // Validate passwords match
            if (password !== passwordConfirm) {
                showToast('Passw√∂rter stimmen nicht √ºberein!', 'error');
                return;
            }
            
            // Show loading
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Wird registriert...';
            registerBtn.disabled = true;
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name,
                            company_name: company
                        },
                        emailRedirectTo: undefined // Disable email confirmation
                    }
                });
                
                if (error) throw error;
                
                // Success
                bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                showToast('Registrierung erfolgreich! Bitte best√§tigen Sie Ihre E-Mail.', 'success');
                
                // ‚úÖ Check if user had intended to upgrade before registration
                const intendedPlan = localStorage.getItem('klein_intended_plan');
                if (intendedPlan) {
                    console.log('üéØ User registered for subscription plan:', intendedPlan);
                    showToast('Nach der E-Mail-Best√§tigung werden Sie automatisch zur Zahlung weitergeleitet.', 'info');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Registrierung fehlgeschlagen: ' + error.message, 'error');
            } finally {
                registerBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>Registrieren';
                registerBtn.disabled = false;
            }
        }

        // Handle Password Reset
        async function handlePasswordReset(event) {
            event.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            const resetBtn = document.getElementById('resetBtn');
            
            // Show loading
            resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Wird gesendet...';
            resetBtn.disabled = true;
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email);
                
                if (error) throw error;
                
                bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                showToast('Reset-Link wurde gesendet! Pr√ºfen Sie Ihre E-Mails.', 'success');
                
            } catch (error) {
                console.error('Password reset error:', error);
                showToast('Fehler beim Senden: ' + error.message, 'error');
            } finally {
                resetBtn.innerHTML = '<i class="fas fa-envelope me-2"></i>Reset-Link senden';
                resetBtn.disabled = false;
            }
        }

        // Prevent concurrent loadUserProfile calls
        let isLoadingProfile = false;

        // Load User Profile
        async function loadUserProfile() {
            if (isLoadingProfile) {
                console.log('‚è≥ Profile already loading, skipping...');
                return;
            }

            isLoadingProfile = true;
            try {
                console.log('üìä Loading user profile...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('‚ùå No user found');
                    currentUser = null;
                    userProfile = null;
                    updateAuthUI();
                    return;
                }
                
                currentUser = user;
                console.log('üë§ Current user:', user.email);
                
                // Try to get profile, if not exists create it
                let { data: profile, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error || !profile) {
                    console.log('‚ö†Ô∏è Profile not found, creating new profile...', error?.message);
                    
                    // Create profile with all required fields
                    const newProfileData = {
                        id: user.id,
                        email: user.email,
                        full_name: user.user_metadata?.full_name || user.user_metadata?.name || '',
                        company_name: user.user_metadata?.company_name || '',
                        plan_type: 'free',
                        monthly_usage_count: 0,
                        monthly_limit: 3,
                        subscription_status: 'inactive',
                        stripe_customer_id: null,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    console.log('üìù Creating profile with data:', newProfileData);
                    
                    const { data: newProfile, error: createError } = await supabase
                        .from('user_profiles')
                        .insert(newProfileData)
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('‚ùå Profile creation error:', createError);
                        // Use fallback profile
                        userProfile = newProfileData;
                    } else {
                        console.log('‚úÖ Profile created successfully');
                        userProfile = newProfile;
                    }
                } else {
                    console.log('‚úÖ Profile loaded successfully');
                    userProfile = profile;
                }
                
                console.log('User profile loaded:', userProfile);
                updateAuthUI();
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Fallback: create minimal profile for auth user
                if (currentUser) {
                    userProfile = {
                        id: currentUser.id,
                        email: currentUser.email,
                        plan_type: 'free',
                        monthly_usage_count: 0,
                        monthly_limit: 3,
                        subscription_status: 'inactive'
                    };
                    updateAuthUI();
                }
            } finally {
                isLoadingProfile = false;
            }
        }

        // Update Authentication UI
        function updateAuthUI() {
            console.log('üîÑ Updating auth UI...', { 
                hasCurrentUser: !!currentUser, 
                hasUserProfile: !!userProfile,
                userEmail: currentUser?.email 
            });
            
            const authButtons = document.getElementById('auth-buttons');
            const userMenu = document.getElementById('user-menu');
            const userEmail = document.getElementById('user-email');
            
            if (currentUser && userProfile) {
                console.log('‚úÖ Showing user menu for:', currentUser.email);
                // Show user menu, hide auth buttons
                authButtons.style.display = 'none';
                userMenu.style.display = 'block';
                userEmail.textContent = currentUser.email;
            } else {
                console.log('‚ùå Showing auth buttons');
                // Show auth buttons, hide user menu
                authButtons.style.display = 'block';
                userMenu.style.display = 'none';
            }
        }

        // Show Dashboard
        function showDashboard() {
            if (!userProfile) return;
            
            const dashboardContent = document.getElementById('dashboardContent');
            dashboardContent.innerHTML = `
                <div class="row">
                    <!-- Profile Info -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-user me-2"></i>Profil Information
                                </h6>
                                <p><strong>Name:</strong> ${userProfile.full_name || 'Nicht angegeben'}</p>
                                <p><strong>E-Mail:</strong> ${userProfile.email}</p>
                                <p><strong>Firma:</strong> ${userProfile.company_name || 'Nicht angegeben'}</p>
                                <p><strong>Plan:</strong> <span class="badge bg-${userProfile.plan_type === 'free' ? 'secondary' : 'primary'}">${userProfile.plan_type.toUpperCase()}</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Usage Stats -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-bar me-2"></i>Nutzung diesen Monat
                                </h6>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Verbrauchte Tracks:</span>
                                    <strong>${userProfile.monthly_usage_count} / ${userProfile.monthly_limit}</strong>
                                </div>
                                <div class="progress mb-2">
                                    <div class="progress-bar" style="width: ${(userProfile.monthly_usage_count / userProfile.monthly_limit) * 100}%"></div>
                                </div>
                                <small class="text-muted">Reset: ${new Date(userProfile.usage_reset_date).toLocaleDateString('de-DE')}</small>
                                <hr>
                                <p><strong>Gesamt verarbeitet:</strong> ${userProfile.total_usage_count} Tracks</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-cogs me-2"></i>Aktionen
                                </h6>
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-primary" onclick="manageSubscription()">
                                        <i class="fas fa-credit-card me-2"></i>Subscription verwalten
                                    </button>
                                    ${userProfile.subscription_status !== 'active' ? `
                                        <button class="btn btn-success" onclick="showUpgradeModal()">
                                            <i class="fas fa-arrow-up me-2"></i>Upgrade auf Pro
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('dashboardModal'));
            modal.show();
        }

        // Manage Subscription (Stripe Customer Portal or Payment Link)
        async function manageSubscription() {
            if (!userProfile) {
                showToast('Bitte loggen Sie sich zuerst ein', 'error');
                return;
            }
            
            try {
                // Check if user has an active subscription
                if (userProfile.subscription_status === 'active' && userProfile.stripe_customer_id) {
                    // User has active subscription - open Customer Portal
                    const customerPortalUrl = 'https://billing.stripe.com/p/login/5kQdR84LT5vM0bd0eu7EQ00';
                    const urlWithEmail = `${customerPortalUrl}?prefilled_email=${encodeURIComponent(userProfile.email)}`;
                    
                    window.open(urlWithEmail, '_blank');
                    showToast('Customer Portal wird ge√∂ffnet...', 'info');
                    
                } else {
                    // User has no subscription - show upgrade options
                    showUpgradeModal();
                }
                
            } catch (error) {
                console.error('Subscription management error:', error);
                showToast('Fehler beim √ñffnen des Subscription-Managers: ' + error.message, 'error');
            }
        }

        // Show Upgrade Modal for users without subscription
        function showUpgradeModal() {
            const modalHtml = `
                <div class="modal fade" id="upgradeModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-arrow-up me-2"></i>Upgrade Ihr Konto
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center mb-4">
                                    <p class="lead">Kaufen Sie Credits um alle Services zu nutzen</p>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>1 Credit = 1 Service ‚Ä¢ Credits laufen nie ab
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100 border-success">
                                            <div class="card-body text-center">
                                                <h5 class="card-title text-success">Starter Paket</h5>
                                                <h2 class="text-success">‚Ç¨24.99</h2>
                                                <p class="text-muted"><small>‚Ç¨2.50 pro Credit</small></p>
                                                <ul class="list-unstyled mb-4">
                                                    <li><i class="fas fa-check text-success me-2"></i>10 Credits</li>
                                                    <li><i class="fas fa-check text-success me-2"></i>Alle AI Services</li>
                                                    <li><i class="fas fa-check text-success me-2"></i>WAV & MP3 Download</li>
                                                    <li><i class="fas fa-check text-success me-2"></i>Nie ablaufend</li>
                                                </ul>
                                                <button class="btn btn-success px-4" onclick="handleCreditPurchase('starter')">
                                                    Starter kaufen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100 border-warning">
                                            <div class="card-body text-center">
                                                <h5 class="card-title text-warning">Studio Paket</h5>
                                                <h2 class="text-warning">‚Ç¨79.99</h2>
                                                <p class="text-muted"><small>‚Ç¨1.60 pro Credit</small></p>
                                                <div class="badge bg-warning text-dark mb-2">Beste Ersparnis</div>
                                                <ul class="list-unstyled mb-4">
                                                    <li><i class="fas fa-check text-success me-2"></i>50 Credits</li>
                                                    <li><i class="fas fa-check text-success me-2"></i>Alle AI Services</li>
                                                    <li><i class="fas fa-check text-success me-2"></i>WAV & MP3 Download</li>
                                                    <li><i class="fas fa-check text-success me-2"></i>Nie ablaufend</li>
                                                </ul>
                                                <button class="btn btn-warning px-4 text-dark" onclick="handleCreditPurchase('studio')">
                                                    Studio kaufen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <p class="text-muted">
                                        <i class="fas fa-lock me-2"></i>Sichere Zahlung mit Stripe ‚Ä¢ Einmaliger Kauf
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('upgradeModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('upgradeModal'));
            modal.show();
        }

        // Redirect to Payment Link (uses existing Stripe Checkout)
        function redirectToPaymentLink(plan) {
            // Close the modal first
            const modal = bootstrap.Modal.getInstance(document.getElementById('upgradeModal'));
            if (modal) modal.hide();
            
            // Use existing checkout function
            redirectToCheckout(plan);
        }

        // Logout
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                userProfile = null;
                updateAuthUI();
                showToast('Erfolgreich ausgeloggt!', 'success');
                
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Logout fehlgeschlagen: ' + error.message, 'error');
            }
        }

        // Check Usage Limit (New Paywall Function)
        async function checkUsageLimit() {
            // Admin bypass check
            const adminMode = localStorage.getItem('klein_admin_mode');
            if (adminMode === 'enabled') {
                console.log('üîß Admin mode: Bypassing usage limit check');
                return true;
            }
            
            if (!userProfile) {
                showAuthModal('login');
                return false;
            }
            
            // Active subscribers have unlimited usage
            if (userProfile.subscription_status === 'active') {
                return true;
            }
            
            // Check free tier limit
            if (userProfile.monthly_usage_count >= userProfile.monthly_limit) {
                showPaywall();
                return false;
            }
            
            return true;
        }

        // Track Usage (call after successful API call)
        async function trackUsage(serviceType, fileName = null) {
            if (!currentUser) return;
            
            try {
                // Increment usage counter
                const { error: functionError } = await supabase.rpc('increment_usage', {
                    user_uuid: currentUser.id,
                    service_name: serviceType
                });
                
                if (functionError) throw functionError;
                
                // Log the usage
                const { error: logError } = await supabase
                    .from('usage_logs')
                    .insert({
                        user_id: currentUser.id,
                        service_type: serviceType,
                        file_name: fileName,
                        status: 'completed'
                    });
                
                if (logError) throw logError;
                
                // Reload profile to update usage counts
                await loadUserProfile();
                
            } catch (error) {
                console.error('Usage tracking error:', error);
            }
        }

        // Show Success Modal (centered, beautiful card)
        function showSuccessModal(title, message) {
            // Remove any existing success modal
            const existingModal = document.getElementById('successModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHTML = `
                <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                            <div class="modal-body text-center p-5">
                                <div class="mb-4">
                                    <div class="d-inline-flex align-items-center justify-content-center" 
                                         style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; margin-bottom: 1rem;">
                                        <i class="fas fa-check" style="font-size: 2rem; color: white;"></i>
                                    </div>
                                </div>
                                <h3 class="fw-bold text-success mb-3">${title}</h3>
                                <p class="text-muted mb-4" style="font-size: 1.1rem;">${message}</p>
                                <button type="button" class="btn btn-success btn-lg px-4" data-bs-dismiss="modal" style="border-radius: 50px; font-weight: 600;">
                                    <i class="fas fa-arrow-right me-2"></i>Weiter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
            
            // Auto-remove modal after it's hidden
            document.getElementById('successModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Show Toast Notifications
        function showToast(message, type = 'info') {
            // Create toast element
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0" 
                     role="alert" id="${toastId}" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove after hiding
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Listen for auth state changes (only for logout)
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_OUT') {
                console.log('üîì User signed out');
                currentUser = null;
                userProfile = null;
                updateAuthUI();
            }
        });

        // Initialization moved to initializeApplication()

        // === TRANSCRIPTION FUNCTIONALITY ===
        
        let currentTranscriptionJobId = null;
        let transcriptionStatusInterval = null;
        
        // API Configuration for Transcription
        const TRANSCRIPTION_API_BASE = 'https://bucci369--music-ai-transcription-complete-transcription-app.modal.run';
        
        // Test transcription connection
        async function testTranscriptionConnection() {
            try {
                document.getElementById('transcription-connection-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verbindung wird getestet...';
                
                // Add timeout for Modal cold starts
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 seconds for cold start
                
                const response = await fetch(`${TRANSCRIPTION_API_BASE}/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('transcription-connection-status').innerHTML = 
                        '<i class="fas fa-check-circle text-success"></i> Transcription Service online - ' + data.service;
                    setupTranscriptionUploads();
                } else {
                    throw new Error('Service nicht verf√ºgbar');
                }
            } catch (error) {
                console.error('Transcription connection test failed:', error);
                
                let errorMessage = 'Service tempor√§r nicht verf√ºgbar';
                if (error.name === 'AbortError') {
                    errorMessage = 'Service startet (Cold Start) - bitte warten...';
                    // Retry once after timeout
                    setTimeout(() => testTranscriptionConnection(), 3000);
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Netzwerkfehler - Service nicht erreichbar';
                }
                
                document.getElementById('transcription-connection-status').innerHTML = 
                    `<i class="fas fa-exclamation-circle text-warning"></i> ${errorMessage}`;
            }
        }
        
        // Setup transcription file uploads
        function setupTranscriptionUploads() {
            const uploadZone = document.getElementById('transcription-upload-zone');
            const fileInput = document.getElementById('transcription-file-input');
            
            // Click handler
            uploadZone.addEventListener('click', () => fileInput.click());
            
            // File selection handler
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleTranscriptionFileSelect(e.target.files[0]);
                }
            });
            
            // Drag and drop handlers
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleTranscriptionFileSelect(e.dataTransfer.files[0]);
                }
            });
        }
        
        // Variables for transcription
        let transcriptionFile = null;
        
        // Handle file selection for transcription (not processing yet)
        function handleTranscriptionFileSelect(file) {
            // Validate file
            const allowedTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/flac', 'audio/x-m4a'];
            if (!allowedTypes.includes(file.type)) {
                alert('Unsupported file format. Please use MP3, WAV, FLAC, or M4A.');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) { // 50MB limit
                alert('File too large. Maximum size is 50MB.');
                return;
            }
            
            transcriptionFile = file;
            const transcriptionZone = document.getElementById('transcription-upload-zone');
            safeHTML(transcriptionZone, `
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h4>Audio bereit: <span class="filename"></span></h4>
                <p class="text-muted">${(file.size / (1024*1024)).toFixed(1)} MB</p>
            `);
            transcriptionZone.querySelector('.filename').textContent = file.name;
            
            checkTranscriptionReady();
        }
        
        // Check if transcription is ready to start
        function checkTranscriptionReady() {
            const startBtn = document.getElementById('start-transcription-btn');
            if (transcriptionFile) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-cogs"></i> Transkription starten';
            } else {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-cogs"></i> Datei w√§hlen';
            }
        }
        
        // Start transcription processing
        async function startTranscription() {
            // ‚úÖ PAYWALL CHECK FIRST
            const canUse = await checkUsageLimit();
            if (!canUse) {
                console.log('üö´ Paywall blocked transcription - user limit reached');
                return; // Stop if paywall blocks usage
            }

            if (!transcriptionFile) {
                alert('Bitte w√§hlen Sie eine Audio-Datei aus');
                return;
            }

            await handleTranscriptionUpload(transcriptionFile);
        }

        // Handle file upload for transcription
        async function handleTranscriptionUpload(file) {
            // ‚úÖ PAYWALL CHECK FIRST
            const canUse = await checkUsageLimit();
            if (!canUse) {
                console.log('üö´ Paywall blocked transcription upload - user limit reached');
                return; // Stop if paywall blocks usage
            }

            console.log('Starting transcription upload:', file.name);
            
            // Validate file
            const allowedTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/flac', 'audio/x-m4a'];
            if (!allowedTypes.includes(file.type)) {
                alert('Unsupported file format. Please use MP3, WAV, FLAC, or M4A.');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) { // 50MB limit
                alert('File too large. Maximum size is 50MB.');
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('audio_file', file);
            
            // Get selected transcription tasks (matching backend)
            const melodyChecked = document.getElementById('task-melody').checked;
            const drumsChecked = document.getElementById('task-drums').checked;
            const chordsChecked = document.getElementById('task-chords').checked;
            const beatsChecked = document.getElementById('task-beats').checked;

            if (!melodyChecked && !drumsChecked && !chordsChecked && !beatsChecked) {
                alert('Bitte w√§hlen Sie mindestens eine Transkriptions-Aufgabe aus.');
                return;
            }

            formData.append('melody', melodyChecked);
            formData.append('drums', drumsChecked);
            formData.append('chords', chordsChecked);
            formData.append('beat', beatsChecked);
            
            try {
                // Show progress
                document.getElementById('transcription-upload-zone').style.display = 'none';
                document.getElementById('transcription-progress-container').style.display = 'block';
                
                updateTranscriptionProgress(5, 'Upload wird gestartet...', '');
                
                // Start transcription
                const response = await fetch(`${TRANSCRIPTION_API_BASE}/transcribe`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.job_id) {
                    currentTranscriptionJobId = result.job_id;
                    console.log('Transcription job started:', currentTranscriptionJobId);
                    
                    // Start status polling
                    startTranscriptionStatusPolling(currentTranscriptionJobId);
                } else {
                    throw new Error(result.error || 'Transcription upload failed');
                }
                
            } catch (error) {
                console.error('Transcription upload error:', error);
                alert(`Transcription upload failed: ${error.message}`);
                
                // Reset UI
                document.getElementById('transcription-progress-container').style.display = 'none';
                document.getElementById('transcription-upload-zone').style.display = 'block';
            }
        }
        
        // Start transcription status polling
        function startTranscriptionStatusPolling(jobId) {
            updateTranscriptionProgress(10, 'Transkription l√§uft...', '');
            
            transcriptionStatusInterval = IntervalManager.create(async () => {
                try {
                    const response = await fetch(`${TRANSCRIPTION_API_BASE}/status/${jobId}`);
                    const status = await response.json();
                    
                    updateTranscriptionProgress(
                        status.progress || 0,
                        status.phase || 'Verarbeitung...',
                        status.processing_time ? `Verarbeitungszeit: ${status.processing_time}s` : ''
                    );
                    
                    if (status.status === 'completed') {
                        IntervalManager.clear(transcriptionStatusInterval);
                        displayTranscriptionResults(status);
                    } else if (status.status === 'error') {
                        IntervalManager.clear(transcriptionStatusInterval);
                        throw new Error(status.error || 'Transcription failed');
                    }
                    
                } catch (error) {
                    console.error('Status polling error:', error);
                    IntervalManager.clear(transcriptionStatusInterval);
                    alert(`Transcription status error: ${error.message}`);
                    
                    // Reset UI
                    document.getElementById('transcription-progress-container').style.display = 'none';
                    document.getElementById('transcription-upload-zone').style.display = 'block';
                }
            }, 2000); // Poll every 2 seconds
        }
        
        // Update transcription progress
        function updateTranscriptionProgress(progress, text, timeText) {
            const progressBar = document.getElementById('transcription-progress-bar');
            const statusText = document.getElementById('transcription-status-text');
            const timeElement = document.getElementById('transcription-processing-time');
            
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            statusText.textContent = text;
            timeElement.textContent = timeText;
        }
        
        // Display transcription results
        function displayTranscriptionResults(status) {
            // Track usage after successful transcription
            trackUsage('transcription', transcriptionFile?.name);
            
            document.getElementById('transcription-progress-container').style.display = 'none';
            document.getElementById('transcription-download-section').style.display = 'block';
            
            const downloadLinksContainer = document.getElementById('transcription-download-links');
            downloadLinksContainer.innerHTML = '';
            
            if (status.files && status.files.length > 0) {
                // Create download buttons for each file
                status.files.forEach(filename => {
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'btn btn-primary me-2 mb-2';
                    downloadBtn.innerHTML = `<i class="fas fa-download me-1"></i>${filename}`;
                    downloadBtn.onclick = () => downloadTranscriptionFile(filename);
                    downloadLinksContainer.appendChild(downloadBtn);
                });
                
                // Add download all button
                const downloadAllBtn = document.createElement('button');
                downloadAllBtn.className = 'btn btn-success me-2 mb-2';
                downloadAllBtn.innerHTML = '<i class="fas fa-download me-1"></i>Alle Dateien herunterladen';
                downloadAllBtn.onclick = downloadAllTranscription;
                downloadLinksContainer.appendChild(downloadAllBtn);
                
                // Add restart button
                const restartBtn = document.createElement('button');
                restartBtn.className = 'btn btn-outline-secondary mb-2';
                restartBtn.innerHTML = '<i class="fas fa-redo me-1"></i>Neue Transkription';
                restartBtn.onclick = () => {
                    document.getElementById('transcription-download-section').style.display = 'none';
                    document.getElementById('transcription-upload-zone').style.display = 'block';
                    currentTranscriptionJobId = null;
                };
                downloadLinksContainer.appendChild(restartBtn);
                
                // Show info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'mt-3 small text-muted';
                infoDiv.innerHTML = `
                    <i class="fas fa-info-circle me-1"></i>
                    ${status.files.length} Dateien generiert ‚Ä¢ 
                    ${status.total_size_mb || 0} MB ‚Ä¢ 
                    Verarbeitungszeit: ${status.processing_time || 0}s<br>
                    <strong>Librosa + Music21</strong> - 
                    Audio-Analyse und Musik-Transkription
                `;
                downloadLinksContainer.appendChild(infoDiv);
            }
        }
        
        // Download individual transcription file
        function downloadTranscriptionFile(filename) {
            if (currentTranscriptionJobId) {
                const url = `${TRANSCRIPTION_API_BASE}/download/transcription/${currentTranscriptionJobId}/${filename}`;
                window.open(url, '_blank');
            } else {
                alert('Datei nicht gefunden!');
            }
        }
        
        // Download all transcription files
        function downloadAllTranscription() {
            if (currentTranscriptionJobId) {
                const url = `${TRANSCRIPTION_API_BASE}/download/transcription/${currentTranscriptionJobId}/all.zip`;
                window.open(url, '_blank');
            } else {
                alert('Keine Dateien zum Download verf√ºgbar!');
            }
        }

        
        // === END TRANSCRIPTION FUNCTIONALITY ===
        
        // === ENHANCED CREDIT SYSTEM FUNCTIONALITY ===
        
        // Global variables
        let stripe = null;
        let userCredits = 0;
        let userUsageCount = parseInt(localStorage.getItem('klein_usage_count') || '0');
        const FREE_LIMIT = 3; // 3 free uses before requiring credits
        
        // ‚úÖ NEW CREDIT PACKAGE PRICE IDs - Launch Special
        const creditPriceIds = {
            'single': 'price_1RnxGhAmspxoSxsTlG9fP5K3',   // 1 Credit - ‚Ç¨3.49
            'starter': 'price_1RnxJsAmspxoSxsTWG1nkwdL',  // 10 Credits - ‚Ç¨24.99
            'pro': 'price_1RnxMNAmspxoSxsT13PcPtQW',      // 25 Credits - ‚Ç¨49.99
            'studio': 'price_1RnxO0AmspxoSxsTVTuTSQSe'     // 50 Credits - ‚Ç¨79.99
        };
        
        // Credit package details for UI
        const creditPackages = {
            'single': { credits: 1, price: '‚Ç¨3.49', name: '1 Credit Pack', originalPrice: '‚Ç¨4.99', discount: '30%' },
            'starter': { credits: 10, price: '‚Ç¨24.99', name: '10 Credits Pack', originalPrice: '‚Ç¨34.90', discount: '28%' },
            'pro': { credits: 25, price: '‚Ç¨49.99', name: '25 Credits Pack', originalPrice: '‚Ç¨87.25', discount: '43%' },
            'studio': { credits: 50, price: '‚Ç¨79.99', name: '50 Credits Pack', originalPrice: '‚Ç¨174.50', discount: '54%' }
        };
        
        // ‚úÖ INTERVAL MANAGEMENT: Prevent memory leaks
        const IntervalManager = {
            intervals: new Set(),
            
            create(callback, delay) {
                const id = setInterval(callback, delay);
                this.intervals.add(id);
                return id;
            },
            
            clear(id) {
                if (id && this.intervals.has(id)) {
                    clearInterval(id);
                    this.intervals.delete(id);
                }
            },
            
            clearAll() {
                this.intervals.forEach(id => clearInterval(id));
                this.intervals.clear();
            }
        };

        // Clear all intervals when page unloads
        window.addEventListener('beforeunload', () => {
            IntervalManager.clearAll();
        });

        // ‚úÖ SECURITY: Safe HTML injection
        function safeHTML(element, html) {
            if (typeof element === 'string') {
                element = document.getElementById(element);
            }
            if (!element) return;
            
            // Clear existing content
            element.innerHTML = '';
            
            // Create temporary container
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Move nodes safely
            while (temp.firstChild) {
                element.appendChild(temp.firstChild);
            }
        }
        
        function safeText(element, text) {
            if (typeof element === 'string') {
                element = document.getElementById(element);
            }
            if (!element) return;
            element.textContent = text;
        }

        // ‚úÖ NEW CREDIT SYSTEM FUNCTIONS
        
        // Load user credits from server
        async function loadUserCredits() {
            if (!currentUser) {
                userCredits = 0;
                return 0;
            }
            
            try {
                const response = await fetch(`https://studio.kleindigitalsolutions.de/api/credits?userId=${currentUser.id}&userEmail=${userProfile?.email}`);
                const data = await response.json();
                
                if (response.ok) {
                    userCredits = data.credits || 0;
                    console.log(`üíé User has ${userCredits} credits`);
                    updateCreditDisplay();
                    return userCredits;
                } else {
                    console.error('Failed to load credits:', data.error);
                    userCredits = 0;
                    return 0;
                }
            } catch (error) {
                console.error('Error loading credits:', error);
                userCredits = 0;
                return 0;
            }
        }
        
        // Check if user can use service
        async function canUseService() {
            // Admin bypass check
            const adminMode = localStorage.getItem('klein_admin_mode');
            if (adminMode === 'enabled') {
                console.log('üîß Admin mode: Bypassing credit check');
                return true;
            }
            
            // Check free usage first
            if (userUsageCount < FREE_LIMIT) {
                console.log(`üÜì Free usage: ${userUsageCount}/${FREE_LIMIT}`);
                return true;
            }
            
            // Load current credits
            await loadUserCredits();
            
            // Check if user has credits
            if (userCredits > 0) {
                console.log(`üíé User has ${userCredits} credits available`);
                return true;
            }
            
            console.log('‚ùå No credits available');
            return false;
        }
        
        // Deduct credit after service usage
        async function deductCredit(service = 'unknown') {
            if (!currentUser) {
                // For free users, just increment usage count
                userUsageCount++;
                localStorage.setItem('klein_usage_count', userUsageCount.toString());
                return true;
            }
            
            // If user still has free uses, don't deduct credits
            if (userUsageCount < FREE_LIMIT) {
                userUsageCount++;
                localStorage.setItem('klein_usage_count', userUsageCount.toString());
                console.log(`üÜì Free usage: ${userUsageCount}/${FREE_LIMIT}`);
                return true;
            }
            
            // Deduct credit via API
            try {
                const response = await fetch('https://studio.kleindigitalsolutions.de/api/credits', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        userEmail: userProfile?.email,
                        credits: 1,
                        service: service
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    userCredits = data.credits;
                    console.log(`üí∏ Credit deducted. New balance: ${userCredits}`);
                    updateCreditDisplay();
                    return true;
                } else {
                    console.error('Failed to deduct credit:', data.error);
                    return false;
                }
            } catch (error) {
                console.error('Error deducting credit:', error);
                return false;
            }
        }
        
        // Update credit display in UI
        function updateCreditDisplay() {
            const creditDisplays = document.querySelectorAll('.credit-balance');
            creditDisplays.forEach(display => {
                if (userCredits > 0) {
                    display.innerHTML = `<i class="fas fa-coins text-warning"></i> ${userCredits} Credits`;
                    display.className = 'credit-balance badge bg-success';
                } else if (userUsageCount < FREE_LIMIT) {
                    const remaining = FREE_LIMIT - userUsageCount;
                    display.innerHTML = `<i class="fas fa-gift text-info"></i> ${remaining} kostenlose Versuche`;
                    display.className = 'credit-balance badge bg-info';
                } else {
                    display.innerHTML = `<i class="fas fa-shopping-cart text-danger"></i> Credits kaufen`;
                    display.className = 'credit-balance badge bg-danger';
                }
            });
        }
        
        // Show credit purchase modal
        function showPaywall() {
            const modal = `
                <div class="modal fade" id="paywallModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header border-0 bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <h5 class="modal-title text-white">
                                    <i class="fas fa-fire text-warning me-2"></i>
                                    üíé Credits kaufen - Launch Special!
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning text-center mb-4">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Sie haben ${FREE_LIMIT} kostenlose Versuche verwendet!</strong><br>
                                    <small>Kaufen Sie Credits f√ºr weiteren Zugang zu allen AI-Services</small>
                                </div>
                                
                                <div class="row">
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card h-100 border-info">
                                            <div class="card-body text-center">
                                                <i class="fas fa-play fa-2x text-info mb-2"></i>
                                                <h6 class="card-title">Testen</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted text-decoration-line-through">‚Ç¨4.99</small><br>
                                                    <h4 class="text-info">‚Ç¨3.49</h4>
                                                    <span class="badge bg-danger">30% Rabatt</span>
                                                </div>
                                                <p class="small"><strong>1 Credit</strong></p>
                                                <button class="btn btn-info btn-sm w-100" onclick="handleCreditPurchase('single')">
                                                    Jetzt kaufen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card h-100 border-success border-2">
                                            <div class="position-absolute top-0 start-50 translate-middle">
                                                <span class="badge bg-success px-2">Beliebt</span>
                                            </div>
                                            <div class="card-body text-center">
                                                <i class="fas fa-star fa-2x text-success mb-2"></i>
                                                <h6 class="card-title">Starter</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted text-decoration-line-through">‚Ç¨34.90</small><br>
                                                    <h4 class="text-success">‚Ç¨24.99</h4>
                                                    <span class="badge bg-danger">28% Rabatt</span>
                                                </div>
                                                <p class="small"><strong>10 Credits</strong><br>‚Ç¨2.50 pro Credit</p>
                                                <button class="btn btn-success btn-sm w-100" onclick="handleCreditPurchase('starter')">
                                                    Jetzt kaufen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card h-100 border-primary border-2">
                                            <div class="position-absolute top-0 start-50 translate-middle">
                                                <span class="badge bg-primary px-2">Beste Ersparnis</span>
                                            </div>
                                            <div class="card-body text-center">
                                                <i class="fas fa-crown fa-2x text-primary mb-2"></i>
                                                <h6 class="card-title">Pro</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted text-decoration-line-through">‚Ç¨87.25</small><br>
                                                    <h4 class="text-primary">‚Ç¨49.99</h4>
                                                    <span class="badge bg-danger">43% Rabatt</span>
                                                </div>
                                                <p class="small"><strong>25 Credits</strong><br>‚Ç¨2.00 pro Credit</p>
                                                <button class="btn btn-primary btn-sm w-100" onclick="handleCreditPurchase('pro')">
                                                    Jetzt kaufen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-lg-3 col-md-6 mb-3">
                                        <div class="card h-100 border-warning border-2">
                                            <div class="position-absolute top-0 start-50 translate-middle">
                                                <span class="badge bg-warning text-dark px-2">Studio</span>
                                            </div>
                                            <div class="card-body text-center">
                                                <i class="fas fa-building fa-2x text-warning mb-2"></i>
                                                <h6 class="card-title">Studio</h6>
                                                <div class="mb-2">
                                                    <small class="text-muted text-decoration-line-through">‚Ç¨174.50</small><br>
                                                    <h4 class="text-warning">‚Ç¨79.99</h4>
                                                    <span class="badge bg-danger">54% Rabatt</span>
                                                </div>
                                                <p class="small"><strong>50 Credits</strong><br>‚Ç¨1.60 pro Credit</p>
                                                <button class="btn btn-warning btn-sm w-100 text-dark" onclick="handleCreditPurchase('studio')">
                                                    Jetzt kaufen
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <div class="alert alert-info d-inline-block">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>1 Credit = 1 Service</strong> ‚Ä¢ Credits laufen nie ab ‚Ä¢ Alle Features inklusive
                                    </div>
                                    <br>
                                    <p class="text-muted">
                                        <i class="fas fa-lock me-1"></i> Sichere Zahlung mit Stripe ‚Ä¢ 
                                        <i class="fas fa-shield-alt me-1"></i> SSL verschl√ºsselt
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page if it doesn't exist
            if (!document.getElementById('paywallModal')) {
                document.body.insertAdjacentHTML('beforeend', modal);
            }
            
            // Show modal
            const paywallModal = new bootstrap.Modal(document.getElementById('paywallModal'));
            paywallModal.show();
        }
        
        // ‚úÖ NEW CREDIT PURCHASE FLOW (Launch Special 2025)
        async function handleCreditPurchase(packageType) {
            console.log('üíé User wants to purchase credits:', packageType);
            
            // Step 1: Check if user is logged in for credit tracking
            if (!currentUser || !userProfile) {
                console.log('üîê User not logged in - showing auth modal first');
                
                // Store the intended package for after login
                localStorage.setItem('klein_intended_package', packageType);
                
                // Show login modal with purchase context
                showAuthModal('register');
                
                // Show friendly message
                const packageInfo = creditPackages[packageType];
                showSuccessModal(
                    'Account f√ºr Credits erforderlich',
                    `Um ${packageInfo.name} zu kaufen, erstellen Sie bitte zuerst einen kostenlosen Account. Ihre Credits werden dann sicher in Ihrem Account gespeichert.`
                );
                
                return;
            }
            
            // Step 2: User is logged in - proceed to checkout
            console.log('‚úÖ User logged in, proceeding to credit purchase');
            await proceedToCreditCheckout(packageType);
        }
        
        // Legacy function for compatibility - maps old subscription plans to credit packages
        async function handleSubscriptionUpgrade(plan) {
            const packageMap = { 'pro': 'pro', 'studio': 'studio' };
            return handleCreditPurchase(packageMap[plan] || 'starter');
        }
        
        // Process credit purchase checkout for authenticated users - Direct Stripe like Pro/Pro+
        async function proceedToCreditCheckout(packageType) {
            try {
                console.log('üí≥ Starting direct credit purchase for package:', packageType);
                
                // Initialize Stripe if needed
                if (!stripe) {
                    await initializeStripe();
                    if (!stripe) {
                        showToast('Zahlungssystem konnte nicht geladen werden. Bitte versuchen Sie es erneut.', 'error');
                        return;
                    }
                }
                
                // Get price ID for package
                const priceId = creditPriceIds[packageType];
                if (!priceId) {
                    showToast('Dieses Paket ist noch nicht verf√ºgbar. Bitte versuchen Sie ein anderes Paket.', 'warning');
                    return;
                }
                
                // ‚úÖ DIRECT STRIPE CHECKOUT - Bypass API authentication issues
                console.log('üîß Using direct Stripe checkout with price:', priceId);
                
                // Use Stripe's direct checkout with price ID
                const { error } = await stripe.redirectToCheckout({
                    lineItems: [{
                        price: priceId,
                        quantity: 1,
                    }],
                    mode: 'payment',
                    successUrl: window.location.origin + '?payment=success&package=' + packageType,
                    cancelUrl: window.location.origin + '?payment=cancelled',
                    locale: 'de',
                    customerEmail: userProfile?.email || '',
                    clientReferenceId: currentUser?.id || 'anonymous'
                });
                
                if (error) {
                    console.error('‚ùå Stripe redirect error:', error);
                    showToast('Fehler beim Weiterleiten zu Stripe: ' + error.message, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Credit checkout error:', error);
                showToast('Ein unerwarteter Fehler ist aufgetreten: ' + error.message, 'error');
            }
        }
        
        // Initialize Stripe with retry logic
        async function initializeStripe() {
            if (stripe) return true;
            
            console.log('üîÑ Initializing Stripe...');
            
            let retryCount = 0;
            const maxRetries = 5;
            
            while (retryCount < maxRetries && !stripe) {
                try {
                    if (typeof Stripe !== 'undefined') {
                        stripe = Stripe('pk_live_51Rc287AmspxoSxsTV4vIhl3ztXtsqaWuSWgSRXsTpB1AbF4HxEH56lYPetVV8buOdJPDyvzO4vsuZuByRTuErp9100SZc7Snim');
                        console.log('‚úÖ Stripe initialized successfully');
                        return true;
                    }
                } catch (error) {
                    console.error('‚ùå Stripe initialization failed:', error);
                }
                
                retryCount++;
                if (retryCount < maxRetries) {
                    console.log(`üîÑ Stripe retry ${retryCount}/${maxRetries}`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            console.error('‚ùå Failed to initialize Stripe after', maxRetries, 'attempts');
            return false;
        }
        
        // Legacy compatibility functions - direct aliases
        const proceedToStripeCheckout = handleSubscriptionUpgrade;
        const redirectToCheckout = handleSubscriptionUpgrade;
        
        // Enhanced 2025 payment verification with server validation
        async function checkPaymentSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            const paymentStatus = urlParams.get('payment');
            
            // Handle cancelled payments
            if (paymentStatus === 'cancelled') {
                console.log('üí≥ Payment was cancelled by user');
                showToast('Zahlung abgebrochen. Sie k√∂nnen jederzeit erneut versuchen.', 'info');
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (sessionId) {
                try {
                    // Verify session with server (2025 best practice)
                    const response = await fetch('/verify-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ sessionId })
                    });

                    if (response.ok) {
                        const { subscription, customer } = await response.json();
                        
                        // Store verified subscription data
                        localStorage.setItem('klein_subscription', JSON.stringify(subscription));
                        localStorage.setItem('klein_customer_id', customer.id);
                        
                        // Show success message
                        alert('üéâ Zahlung erfolgreich! Ihr Pro-Account ist jetzt aktiv.');
                        
                    } else {
                        console.error('Session verification failed');
                    }
                } catch (error) {
                    console.error('Payment verification error:', error);
                    // Fallback to local verification for now
                    localStorage.setItem('klein_subscription', 'active');
                    localStorage.setItem('klein_subscription_expiry', new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString());
                    alert('üéâ Zahlung erfolgreich! Ihr Pro-Account ist jetzt aktiv.');
                }
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // Check usage before allowing service access
        
        // Admin functions (accessible in browser console)
        window.enableAdminMode = function() {
            localStorage.setItem('klein_admin_mode', 'enabled');
            console.log('üîß Admin mode ENABLED - All paywalls bypassed!');
            console.log('Use disableAdminMode() to turn off');
        };
        
        window.disableAdminMode = function() {
            localStorage.removeItem('klein_admin_mode');
            console.log('üîß Admin mode DISABLED - Normal paywall behavior restored');
        };
        
        window.checkAdminMode = function() {
            const isEnabled = localStorage.getItem('klein_admin_mode') === 'enabled';
            console.log(`üîß Admin mode: ${isEnabled ? 'ENABLED' : 'DISABLED'}`);
            return isEnabled;
        };

        // Paywall initialization moved to initializeApplication()
        
        // === END STRIPE PAYWALL FUNCTIONALITY ===
        
        // === LEGAL MODALS FUNCTIONALITY ===
        
        // Show Legal Modal
        function showLegalModal(type) {
            const modalContent = getLegalContent(type);
            
            // Remove existing modal if any
            const existingModal = document.getElementById('legalModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div class="modal fade" id="legalModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="${modalContent.icon} me-2"></i>${modalContent.title}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${modalContent.content}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('legalModal'));
            modal.show();
        }
        
        // Get Legal Content
        function getLegalContent(type) {
            const contents = {
                impressum: {
                    title: 'Impressum',
                    icon: 'fas fa-info-circle',
                    content: `
                        <h4>Angaben gem√§√ü ¬ß 5 TMG</h4>
                        <div class="mb-4">
                            <strong>Klein Digital Solutions AI Studio</strong><br>
                            √ñzg√ºr Azap<br>
                            Wittbr√§uckerstra√üe 109<br>
                            44287 Dortmund<br>
                            Deutschland
                        </div>

                        <h4>Kontakt</h4>
                        <div class="mb-4">
                            <strong>E-Mail:</strong> info@kleindigitalsolutions.de<br>
                            <strong>Website:</strong> https://studio.kleindigitalsolutions.de
                        </div>

                        <h4>Verantwortlich f√ºr den Inhalt nach ¬ß 55 Abs. 2 RStV</h4>
                        <div class="mb-4">
                            √ñzg√ºr Azap<br>
                            Wittbr√§uckerstra√üe 109<br>
                            44287 Dortmund<br>
                            Deutschland
                        </div>

                        <h4>KI-Dienste und Transparenz</h4>
                        <div class="alert alert-info">
                            <p><strong>Klein Digital Solutions AI Studio</strong> nutzt k√ºnstliche Intelligenz zur Audio-Verarbeitung. 
                            Gem√§√ü EU-KI-Verordnung informieren wir Sie √ºber:</p>
                            <ul>
                                <li><strong>Art der KI-Systeme:</strong> Audio-Separation, Mastering und Transkription</li>
                                <li><strong>Zweck:</strong> Professionelle Audio-Bearbeitung f√ºr Musikproduzenten</li>
                                <li><strong>Funktionsweise:</strong> Machine Learning basierte Audio-Analyse</li>
                                <li><strong>Qualit√§tssicherung:</strong> Kontinuierliche √úberwachung der KI-Modelle</li>
                            </ul>
                        </div>

                        <h4>Online-Streitbeilegung</h4>
                        <p>Die Europ√§ische Kommission stellt eine Plattform zur Online-Streitbeilegung (OS) bereit: 
                        <a href="https://ec.europa.eu/consumers/odr/" target="_blank" rel="noopener">https://ec.europa.eu/consumers/odr/</a></p>
                    `
                },
                agb: {
                    title: 'Allgemeine Gesch√§ftsbedingungen',
                    icon: 'fas fa-file-contract',
                    content: `
                        <h4>¬ß 1 Geltungsbereich und Vertragsgegenstand</h4>
                        <div class="alert alert-primary">
                            <h5><i class="fas fa-robot me-2"></i>KI-Audio-Services</h5>
                            <p>Klein Digital Solutions AI Studio bietet folgende KI-gest√ºtzte Audio-Dienste:</p>
                            <ul>
                                <li><strong>AI Stem Separation:</strong> Trennung von Musikspuren</li>
                                <li><strong>AI Audio Mastering:</strong> Automatische Audio-Optimierung</li>
                                <li><strong>Music Transcription:</strong> Konvertierung von Audio zu MIDI</li>
                            </ul>
                        </div>

                        <h4>¬ß 2 Nutzungsmodelle</h4>
                        <ul>
                            <li><strong>Free Plan:</strong> 3 kostenlose Verarbeitungen</li>
                            <li><strong>Starter Credits:</strong> 10 Credits f√ºr ‚Ç¨24.99</li>
                            <li><strong>Pro Credits:</strong> 25 Credits f√ºr ‚Ç¨49.99</li>
                            <li><strong>Studio Credits:</strong> 50 Credits f√ºr ‚Ç¨79.99</li>
                        </ul>

                        <h4>¬ß 3 Zahlungsbedingungen</h4>
                        <p>Alle Preise verstehen sich inklusive der gesetzlichen Mehrwertsteuer. Credits sind einmalige K√§ufe ohne automatische Verl√§ngerung.</p>
                        <p><strong>R√ºckerstattung:</strong> 14-t√§gige Geld-zur√ºck-Garantie f√ºr ungenutzte Credits.</p>

                        <h4>¬ß 4 Pflichten des Nutzers</h4>
                        <div class="alert alert-warning">
                            <p><strong>Untersagt sind insbesondere:</strong></p>
                            <ul>
                                <li>Verarbeitung urheberrechtlich gesch√ºtzten Materials ohne Berechtigung</li>
                                <li>Upload von Inhalten, die Pers√∂nlichkeitsrechte verletzen</li>
                                <li>Missbrauch oder automatisierte Anfragen</li>
                            </ul>
                        </div>

                        <h4>¬ß 5 KI-Verarbeitung und Haftung</h4>
                        <div class="alert alert-info">
                            <p><strong>Technische Hinweise:</strong></p>
                            <ul>
                                <li>KI-Ergebnisse k√∂nnen je nach Eingangsmaterial variieren</li>
                                <li>Keine Garantie f√ºr 100%ige Perfektion der KI-Ergebnisse</li>
                                <li>Haftung beschr√§nkt auf den Wert des gebuchten Plans</li>
                            </ul>
                        </div>

                        <h4>¬ß 6 Credits und G√ºltigkeit</h4>
                        <p>Gekaufte Credits haben keine Ablaufzeit und k√∂nnen jederzeit verwendet werden. Ungenutzte Credits verfallen nicht.</p>

                        <h4>¬ß 7 Geistiges Eigentum</h4>
                        <div class="alert alert-success">
                            <p><strong>Wichtig:</strong> Sie behalten alle Rechte an Ihren urspr√ºnglichen Audioinhalten und den durch die KI verarbeiteten Ergebnissen.</p>
                        </div>

                        <div class="mt-4 p-3 bg-light rounded">
                            <p><strong>Stand:</strong> Januar 2025<br>
                            <strong>Anwendbares Recht:</strong> Deutsches Recht<br>
                            <strong>Gerichtsstand:</strong> Dortmund, Deutschland</p>
                        </div>
                    `
                },
                datenschutz: {
                    title: 'Datenschutzerkl√§rung',
                    icon: 'fas fa-shield-alt',
                    content: `
                        <h4>1. Verantwortlicher</h4>
                        <div class="mb-3 p-3 bg-light rounded">
                            <strong>Klein Digital Solutions AI Studio</strong><br>
                            √ñzg√ºr Azap<br>
                            Wittbr√§uckerstra√üe 109, 44287 Dortmund<br>
                            E-Mail: info@kleindigitalsolutions.de
                        </div>

                        <h4>2. KI-Audio-Verarbeitung</h4>
                        <div class="alert alert-primary">
                            <h5><i class="fas fa-music me-2"></i>Audio-Datenverarbeitung</h5>
                            <p><strong>Verarbeitungsablauf:</strong></p>
                            <ol>
                                <li>Upload: Tempor√§re Speicherung auf sicheren Servern</li>
                                <li>KI-Verarbeitung: Automatisierte Analyse durch unsere KI-Modelle</li>
                                <li>Ergebnis-Bereitstellung: Verarbeitete Dateien zum Download</li>
                                <li>Automatische L√∂schung: Alle Dateien nach 24 Stunden</li>
                            </ol>
                            
                            <p><strong>Zweck:</strong> KI-gest√ºtzte Audio-Bearbeitung<br>
                            <strong>Rechtsgrundlage:</strong> Art. 6 Abs. 1 lit. b DSGVO (Vertragserf√ºllung)<br>
                            <strong>Speicherdauer:</strong> Maximal 24 Stunden</p>
                        </div>

                        <div class="alert alert-success">
                            <h5><i class="fas fa-shield-alt me-2"></i>KI-Modell Training</h5>
                            <p><strong>Garantie:</strong> Ihre Audiodateien werden NIEMALS zum Training unserer KI-Modelle verwendet. Jede Verarbeitung erfolgt isoliert und ausschlie√ülich f√ºr Ihren Service-Request.</p>
                        </div>

                        <h4>3. Benutzerregistrierung</h4>
                        <p><strong>Verarbeitete Daten:</strong></p>
                        <ul>
                            <li>E-Mail-Adresse, Passwort (gehashed)</li>
                            <li>Optional: Name, Firmenname</li>
                            <li>Nutzungsstatistiken (Anzahl verarbeiteter Dateien)</li>
                        </ul>
                        <p><strong>Zweck:</strong> Account-Verwaltung, Authentifizierung, Paywall-Management</p>

                        <h4>4. Zahlungsabwicklung (Stripe)</h4>
                        <p><strong>Verarbeitete Daten:</strong> E-Mail, Zahlungsinformationen, Rechnungsdaten<br>
                        <strong>Drittanbieter:</strong> Stripe Inc. (USA) mit Angemessenheitsbeschluss<br>
                        <strong>Datenschutz:</strong> <a href="https://stripe.com/privacy" target="_blank">Stripe Privacy Policy</a></p>

                        <h4>5. Ihre Datenschutz-Rechte</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <ul>
                                    <li><strong>Auskunftsrecht</strong> (Art. 15 DSGVO)</li>
                                    <li><strong>Berichtigung</strong> (Art. 16 DSGVO)</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul>
                                    <li><strong>L√∂schung</strong> (Art. 17 DSGVO)</li>
                                    <li><strong>Datenportabilit√§t</strong> (Art. 20 DSGVO)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <h5><i class="fas fa-envelope me-2"></i>Aus√ºbung Ihrer Rechte</h5>
                            <p><strong>Kontakt:</strong> info@kleindigitalsolutions.de<br>
                            <strong>Betreff:</strong> "Datenschutzanfrage - AI Studio"<br>
                            <strong>Antwortzeit:</strong> Binnen 48 Stunden</p>
                        </div>

                        <h4>6. Technische Sicherheitsma√ünahmen</h4>
                        <ul>
                            <li><strong>Verschl√ºsselung:</strong> HTTPS/TLS f√ºr alle Daten√ºbertragungen</li>
                            <li><strong>Isolierte Verarbeitung:</strong> Jede Datei wird separat verarbeitet</li>
                            <li><strong>Sichere L√∂schung:</strong> √úberschreibung der Speicherbereiche</li>
                            <li><strong>EU-Server:</strong> KI-Verarbeitung nur auf EU-Servern</li>
                        </ul>

                        <div class="mt-4 p-3 bg-light rounded">
                            <p><strong>Stand:</strong> Januar 2025<br>
                            <strong>Aufsichtsbeh√∂rde:</strong> LDI NRW, D√ºsseldorf<br>
                            <strong>Website:</strong> <a href="https://www.ldi.nrw.de" target="_blank">www.ldi.nrw.de</a></p>
                        </div>
                    `
                }
            };
            
            return contents[type] || contents.impressum;
        }
        
        // === AUDIO ENHANCEMENT FUNCTIONALITY ===
        
        // Enhancement API Configuration  
        const ENHANCEMENT_API_BASE = 'https://bucci369--audio-enhancement-complete-fastapi-app.modal.run';
        let currentEnhancementJobId = null;
        let lastEnhancementResult = null;
        let enhancementSelectedFile = null;
        
        // Enhancement presets
        const enhancementPresets = {
            podcast: {
                noise_reduction: true,
                volume_normalization: true,
                filler_word_removal: true,
                silence_trimming: true,
                loudness_targeting: true,
                target_lufs: -16.0,
                cough_detection: true,
                quality_enhancement: true
            },
            interview: {
                noise_reduction: true,
                volume_normalization: true,
                filler_word_removal: false,
                silence_trimming: true,
                loudness_targeting: true,
                target_lufs: -18.0,
                cough_detection: false,
                quality_enhancement: true
            },
            presentation: {
                noise_reduction: true,
                volume_normalization: true,
                filler_word_removal: true,
                silence_trimming: true,
                loudness_targeting: true,
                target_lufs: -16.0,
                cough_detection: true,
                quality_enhancement: true
            },
            voiceover: {
                noise_reduction: true,
                volume_normalization: true,
                filler_word_removal: true,
                silence_trimming: true,
                loudness_targeting: true,
                target_lufs: -14.0,
                cough_detection: true,
                quality_enhancement: true
            }
        };
        
        // Select enhancement preset
        function selectEnhancementPreset(presetName) {
            const preset = enhancementPresets[presetName];
            if (!preset) return;
            
            // Update checkboxes based on preset
            document.getElementById('enhancement-noise-reduction').checked = preset.noise_reduction;
            document.getElementById('enhancement-volume-normalization').checked = preset.volume_normalization;
            document.getElementById('enhancement-silence-trimming').checked = preset.silence_trimming;
            document.getElementById('enhancement-filler-words').checked = preset.filler_word_removal;
            document.getElementById('enhancement-cough-detection').checked = preset.cough_detection;
            document.getElementById('enhancement-quality').checked = preset.quality_enhancement;
            document.getElementById('enhancement-loudness').checked = preset.loudness_targeting;
            
            // Visual feedback
            document.querySelectorAll('#enhancement .btn-outline-primary').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show success message
            const statusDiv = document.createElement('div');
            statusDiv.className = 'alert alert-success mt-2';
            statusDiv.innerHTML = `<i class="fas fa-check me-2"></i>Preset "${presetName}" angewendet!`;
            
            const presetContainer = event.target.parentElement;
            presetContainer.appendChild(statusDiv);
            
            setTimeout(() => statusDiv.remove(), 2000);
        }
        
        function handleEnhancementFileSelect(file) {
            // Validate file
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/mp4', 'audio/aac'];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|flac|m4a|aac)$/i)) {
                alert('Unsupported file format. Please use MP3, WAV, FLAC, M4A, or AAC.');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) { // 100MB limit
                alert('File too large. Maximum size is 100MB.');
                return;
            }
            
            enhancementFile = file;
            const enhancementZone = document.getElementById('enhancement-upload-zone');
            safeHTML(enhancementZone, `
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h4>Audio bereit: <span class="filename"></span></h4>
                <p class="text-muted">${(file.size / (1024*1024)).toFixed(1)} MB</p>
            `);
            enhancementZone.querySelector('.filename').textContent = file.name;
            
            checkEnhancementReady();
        }
        
        // Start enhancement processing
        function setupEnhancementUploads() {
            const uploadZone = document.getElementById('enhancement-upload-zone');
            const fileInput = document.getElementById('enhancement-file-input-main');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleEnhancementFileSelect(files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleEnhancementFileSelect(e.target.files[0]);
                }
            });
        }
        
        // Global enhancement file variable
        let enhancementFile = null;

        function checkEnhancementReady() {
            const startBtn = document.getElementById('start-enhancement-btn');
            if (enhancementFile) {
                startBtn.disabled = false;
                startBtn.classList.remove('btn-secondary');
                startBtn.classList.add('btn-primary');
            } else {
                startBtn.disabled = true;
                startBtn.classList.remove('btn-primary');
                startBtn.classList.add('btn-secondary');
            }
        }

        async function startEnhancement() {
            if (!enhancementFile) {
                alert('‚ùå Bitte w√§hlen Sie eine Audio-Datei aus!');
                return;
            }
            
            // Check usage limits again
            const canUse = await checkUsageLimit();
            if (!canUse) {
                console.log('üö´ Paywall blocked enhancement - user limit reached');
                showPaywall();
                return;
            }
            
            // Hide upload section and show processing
            document.getElementById('enhancement-upload-zone').style.display = 'none';
            document.getElementById('start-enhancement-btn').style.display = 'none';
            document.getElementById('enhancement-processing').style.display = 'block';
            
            // Start processing
            startEnhancementProcessing(enhancementFile);
        }

        async function startEnhancementProcessing(file) {
            try {
                // Get enhancement options
                const enhancementOptions = {
                    noise_reduction: document.getElementById('enhancement-noise-reduction').checked,
                    volume_normalization: document.getElementById('enhancement-volume-normalization').checked,
                    filler_word_removal: document.getElementById('enhancement-filler-words').checked,
                    silence_trimming: document.getElementById('enhancement-silence-trimming').checked,
                    cough_detection: document.getElementById('enhancement-cough-detection').checked,
                    quality_enhancement: document.getElementById('enhancement-quality').checked,
                    loudness_targeting: document.getElementById('enhancement-loudness').checked,
                    target_lufs: -16.0
                };
                
                updateEnhancementProgress(0, 'Datei wird hochgeladen...', 'üîÑ Upload gestartet');
                
                // Create FormData for upload
                const formData = new FormData();
                formData.append('audio', file);
                formData.append('enhancement_options', JSON.stringify(enhancementOptions));
                
                // Upload and start processing
                const response = await fetch(`${ENHANCEMENT_API_BASE}/upload/enhancement`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }
                
                const result = await response.json();
                currentEnhancementJobId = result.job_id;
                
                updateEnhancementProgress(10, 'Verarbeitung gestartet...', 'üß† AI Pipeline wird initialisiert');
                
                // Start polling for status updates
                pollEnhancementStatus();
                
            } catch (error) {
                console.error('Enhancement error:', error);
                showEnhancementError(error.message);
            }
        }
        
        // Poll enhancement status
        let enhancementStatusInterval = null;
        
        function pollEnhancementStatus() {
            enhancementStatusInterval = IntervalManager.create(async () => {
                try {
                    const response = await fetch(`${ENHANCEMENT_API_BASE}/status/enhancement/${currentEnhancementJobId}`);
                    const status = await response.json();
                    
                    updateEnhancementProgress(
                        status.progress || 0,
                        status.phase || 'Verarbeitung l√§uft...',
                        ''
                    );
                    
                    if (status.status === 'completed') {
                        IntervalManager.clear(enhancementStatusInterval);
                        
                        // Track usage
                        trackUsage('enhancement', enhancementFile?.name);
                        
                        setTimeout(() => {
                            showEnhancementResults(status);
                        }, 1000);
                        
                    } else if (status.status === 'error') {
                        IntervalManager.clear(enhancementStatusInterval);
                        showEnhancementError(status.error || 'Processing failed');
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                    // Continue polling on error
                }
            }, 2000); // Poll every 2 seconds
        }
        
        // Update enhancement progress
        function updateEnhancementProgress(percentage, status, phase) {
            const progressBar = document.getElementById('enhancement-progress');
            const statusText = document.getElementById('enhancement-status');
            const phaseText = document.getElementById('enhancement-phase');
            
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
            statusText.textContent = status;
            phaseText.textContent = phase;
        }
        
        // Show enhancement results
        function showEnhancementResults(result) {
            lastEnhancementResult = result;
            document.getElementById('enhancement-processing').style.display = 'none';
            document.getElementById('enhancement-results').style.display = 'block';
            
            // Display metrics
            const metricsContainer = document.getElementById('enhancement-metrics');
            if (result.metrics && !result.metrics.error) {
                const metrics = result.metrics;
                metricsContainer.innerHTML = `
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="metric-card p-3 border rounded">
                                <h6>SNR Verbesserung</h6>
                                <h4 class="text-success">${(metrics.snr_improvement_db || 0).toFixed(1)} dB</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card p-3 border rounded">
                                <h6>Original SNR</h6>
                                <h4>${(metrics.original_snr_db || 0).toFixed(1)} dB</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card p-3 border rounded">
                                <h6>Enhanced SNR</h6>
                                <h4 class="text-primary">${(metrics.enhanced_snr_db || 0).toFixed(1)} dB</h4>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card p-3 border rounded">
                                <h6>Dynamic Range</h6>
                                <h4>${(metrics.dynamic_range_db || 0).toFixed(1)} dB</h4>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Display processing log
            const logContainer = document.createElement('div');
            logContainer.className = 'mt-3';
            logContainer.innerHTML = `
                <h6>Angewendete Verbesserungen:</h6>
                <ul class="list-unstyled">
                    ${result.processing_log.map(log => `<li class="text-success">${log}</li>`).join('')}
                </ul>
            `;
            metricsContainer.appendChild(logContainer);
            
            // Create download links
            const downloadLinksContainer = document.getElementById('enhancement-download-links');
            downloadLinksContainer.innerHTML = `
                <div class="row justify-content-center">
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-primary btn-lg w-100" onclick="downloadEnhancedAudio()">
                            <i class="fas fa-download me-2"></i>Enhanced Audio
                        </button>
                        <small class="text-muted d-block mt-1">24-bit WAV ‚Ä¢ Broadcast Quality</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-primary btn-lg w-100" onclick="downloadEnhancementPreview()">
                            <i class="fas fa-headphones me-2"></i>Vorher/Nachher
                        </button>
                        <small class="text-muted d-block mt-1">Stereo Vergleich ‚Ä¢ Links: Original, Rechts: Enhanced</small>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-success w-100" onclick="restartEnhancement()">
                        <i class="fas fa-redo me-2"></i>Weitere Datei enhancen
                    </button>
                </div>
            `;
            
            // Add info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'mt-3 small text-muted text-center';
            infoDiv.innerHTML = `
                <i class="fas fa-info-circle me-1"></i>
                Enhancement abgeschlossen ‚Ä¢ Job ID: ${result.job_id}<br>
                <strong>DeepFilterNet + Whisper + YAMNet</strong> - 
                Professional Speech Enhancement
            `;
            downloadLinksContainer.appendChild(infoDiv);
        }
        
        // Download enhanced audio
        function downloadEnhancedAudio() {
            if (currentEnhancementJobId && lastEnhancementResult && lastEnhancementResult.files) {
                const url = `${ENHANCEMENT_API_BASE}/download/enhancement/${currentEnhancementJobId}/${lastEnhancementResult.files.enhanced}`;
                window.open(url, '_blank');
            } else {
                alert('‚ùå Enhanced audio nicht verf√ºgbar!');
            }
        }
        
        // Download enhancement preview
        function downloadEnhancementPreview() {
            if (currentEnhancementJobId && lastEnhancementResult && lastEnhancementResult.files) {
                const url = `${ENHANCEMENT_API_BASE}/download/enhancement/${currentEnhancementJobId}/${lastEnhancementResult.files.preview}`;
                window.open(url, '_blank');
            } else {
                alert('‚ùå Preview nicht verf√ºgbar!');
            }
        }
        
        // Restart enhancement
        function restartEnhancement() {
            document.getElementById('enhancement-results').style.display = 'none';
            document.getElementById('enhancement-upload-area').style.display = 'block';
            document.getElementById('enhancement-file-input').value = '';
            currentEnhancementJobId = null;
        }
        
        // Show enhancement error
        function showEnhancementError(errorMessage) {
            document.getElementById('enhancement-processing').style.display = 'none';
            
            const errorHtml = `
                <div class="card border-danger">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h5 class="text-danger">Enhancement Fehler</h5>
                        <p class="text-muted">${errorMessage}</p>
                        <button class="btn btn-primary" onclick="restartEnhancement()">
                            <i class="fas fa-redo me-2"></i>Erneut versuchen
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('enhancement-results').innerHTML = errorHtml;
            document.getElementById('enhancement-results').style.display = 'block';
        }
        
        // Test enhancement connection
        async function testEnhancementConnection() {
            try {
                const response = await fetch(`${ENHANCEMENT_API_BASE}/health`);
                const status = await response.json();
                
                if (status.status === 'healthy') {
                    document.getElementById('enhancement-connection-status').innerHTML = 
                        '<i class="fas fa-check-circle text-success"></i> Audio Enhancement Service bereit';
                    setupEnhancementUploads();
                } else {
                    throw new Error('Service not healthy');
                }
            } catch (error) {
                document.getElementById('enhancement-connection-status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle text-warning"></i> Enhancement Service l√§dt...';
                
                // Retry after 5 seconds
                setTimeout(testEnhancementConnection, 5000);
            }
        }
        
        
        // === END AUDIO ENHANCEMENT FUNCTIONALITY ===
        
        // === MISSING AUDIO GENERATION FUNCTION ===
        async function startAudioGeneration() {
            const inputText = document.getElementById('generation-text').value.trim();
            
            if (!inputText) {
                showNotification('Bitte geben Sie einen Text f√ºr die Audio-Generierung ein.', 'error');
                return;
            }
            
            const canUse = await checkUsageLimit();
            if (!canUse) {
                console.log('üö´ Paywall blocked audio generation - user limit reached');
                showPaywall();
                return;
            }
            
            try {
                showNotification('Audio-Generierung wird gestartet...', 'info');
                
                const formData = new FormData();
                formData.append('text', inputText);
                formData.append('voice_id', document.getElementById('voice-selection').value || 'default');
                formData.append('generation_options', JSON.stringify({
                    speed: document.getElementById('generation-speed').value || 1.0,
                    pitch: document.getElementById('generation-pitch').value || 0
                }));
                
                // TODO: Replace with actual API endpoint when implemented
                console.log('üé§ Audio generation would start here with:', {
                    text: inputText,
                    formData: Object.fromEntries(formData)
                });
                
                showNotification('Audio-Generierung Feature kommt bald!', 'info');
                
            } catch (error) {
                console.error('Audio generation error:', error);
                showNotification('Fehler bei der Audio-Generierung: ' + error.message, 'error');
            }
        }
        
        // === SERVICE SELECTION SETUP ===
        function setupServiceSelection() {
            console.log('üîß Setting up service selection...');
            // Service selection is handled by onClick events in HTML
            // This function ensures all service cards are properly initialized
            try {
                // Initialize service cards if needed
                const serviceCards = document.querySelectorAll('.service-card');
                serviceCards.forEach(card => {
                    if (!card.hasAttribute('data-initialized')) {
                        card.setAttribute('data-initialized', 'true');
                    }
                });
                console.log('‚úÖ Service selection setup completed');
            } catch (error) {
                console.error('‚ùå Service selection setup failed:', error);
            }
        }

        // === MASTER INITIALIZATION FUNCTION ===
        function initializeApplication() {
            console.log('üöÄ Initializing Klein Digital Solutions AI Music Studio...');
            
            // Service Selection Setup
            setupServiceSelection();
            
            // Upload zones are setup when services are selected
            
            // Enhanced Stripe Initialization with robust retry logic
            function initializeStripe() {
                if (typeof Stripe !== 'undefined') {
                    try {
                        stripe = Stripe('pk_live_51Rc287AmspxoSxsTV4vIhl3ztXtsqaWuSWgSRXsTpB1AbF4HxEH56lYPetVV8buOdJPDyvzO4vsuZuByRTuErp9100SZc7Snim');
                        console.log('‚úÖ Stripe initialized successfully');
                        return true;
                    } catch (error) {
                        console.error('‚ùå Stripe initialization failed:', error);
                        return false;
                    }
                } else {
                    console.warn('‚è≥ Stripe not yet loaded, retrying...');
                    return false;
                }
            }
            
            // Enhanced retry logic with better timing
            function attemptStripeInitialization() {
                if (initializeStripe()) {
                    return; // Success!
                }
                
                let retryCount = 0;
                const maxRetries = 15; // Increased retries
                const retryInterval = IntervalManager.create(() => {
                    retryCount++;
                    console.log(`üîÑ Stripe initialization attempt ${retryCount}/${maxRetries}`);
                    
                    if (initializeStripe()) {
                        IntervalManager.clear(retryInterval);
                        console.log('üéâ Stripe successfully loaded after retry');
                    } else if (retryCount >= maxRetries) {
                        IntervalManager.clear(retryInterval);
                        console.error('‚ùå Failed to load Stripe after ' + maxRetries + ' attempts');
                        console.error('Please refresh the page if you encounter payment issues');
                    }
                }, 800); // Increased interval for better reliability
            }
            
            // Start initialization process
            attemptStripeInitialization();
            
            // Payment success check and paywall setup
            checkPaymentSuccess();
            
            // Update UI based on credit status
            loadUserCredits().then(() => {
                if (userCredits > 0) {
                    console.log(`üéµ Credit User - ${userCredits} credits available`);
                } else {
                    const userUsageCount = parseInt(localStorage.getItem('klein_usage_count') || '0');
                    console.log(`üéµ Free User - ${FREE_LIMIT - userUsageCount} uses remaining`);
                }
                updateCreditDisplay();
            });
            
            // Custom Stem Selection Setup
            const customRadio = document.getElementById('custom-stems');
            const customCheckboxes = document.getElementById('custom-checkboxes');
            const allRadios = document.querySelectorAll('input[name="stemSelection"]');
            
            allRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customCheckboxes.style.display = 'block';
                    } else {
                        customCheckboxes.style.display = 'none';
                    }
                });
            });
            
            // Initialize additional functionality
            loadModels();
            loadUserProfile(); // Load user on page load
            
            // Setup all service connections
            // testSeparationConnection(); // Removed - causes error
            testMasteringConnection();
            testTranscriptionConnection();
            testEnhancementConnection();
            
            console.log('‚úÖ Application initialization complete!');
        }
        
        // === SINGLE DOMContentLoaded LISTENER ===
        document.addEventListener('DOMContentLoaded', initializeApplication);
        
    </script>
</body>
</html>